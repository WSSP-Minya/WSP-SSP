<!DOCTYPE html>
<html>
    <title>main page</title>
    
    <head>
        <link rel="stylesheet" href="mainpage.css">
    </head>
    <body>
        <!-- زر Logout -->
        <div class="topbar">
            <!-- الجزء الخاص بالأزرار في أقصى اليسار -->
            <div class="left-side">
                <button class="logout-button" onclick="logout()">Logout</button>
                <button class="changepassword-button" onclick="AccessedToPage('changepassword')">
                    <img src="https://media.istockphoto.com/id/1500914761/vector/fitness-health-gym-trendy-icons-on-circles.jpg?s=612x612&w=0&k=20&c=MaSBJ-edgZ2Nm7utjZgYupCWAzhrcIek0Udz48L_JME=" alt="Change password" title="Change password">
                    
                </button>
                <button class="add-user-button" onclick="openAddUserPopup()"> <!-- زر إضافة مستخدم -->
                    <img src="adduser.webp" alt="add user" title="Add user">
                </button>
            </div>

            <!-- الجزء الخاص بالـ logo و user info في أقصى اليمين -->
            <div class="right-side">
                <div class="userinfo">
                    <label>Section</label>
                    <input id="section" disabled>
                </div>
                <img class="logo" src="wsp.22cd4e849308ae80b006.png">
            </div>
        </div>
        <!--نافذه منشقة داخل الصفحة لادخال new user-->
        <div id="addUserPopup" class="popup">
            <div class="popup-content">
                <span class="close-btn" onclick="closeAddUserPopup()">&times;</span>
                <h2>Add New User</h2>
                <form id="addUserForm" onsubmit="submitUserForm(event)">
                    <input type="email" id="email" placeholder="User Email" required>
                    <input type="password" id="password" placeholder="Password" required>
                    <select id="branch">
                        <option value="" selected disabled>Select Branch</option>
                        <option value="العدوه">العدوه</option>
                        <option value="مغاغة">مغاغة</option>
                        <option value="بنى مزار">بنى مزار</option>
                        <option value="مطاى">مطاى</option>
                        <option value="سمالوط">سمالوط</option>
                        <option value="المنيا">المنيا</option>
                        <option value="ابوقرقاص">ابوقرقاص</option>
                        <option value="ملوى">ملوى</option>
                        <option value="ديرمواس">ديرمواس</option>
                    </select>
                    <select id="role" required>
                        <option value="user">user</option>
                        <option value="admin">admin</option>
                    </select>
                    <button type="submit">Add</button>
                </form>
                <div id="errorMessage" style="color: red; text-align: center;"></div>
            </div>
        </div>


               
        <div class="options">
            <button onclick="AccessedToPage('waterqualitymonitoring')" class="buttonlabel">
                
                <img src="water-setization-image.webp" alt="Water Quality Monitoring" title="Raw Water Quality Monitoring">
                <span>Water Quality Monitoring</span>
            </button>
            
            <button onclick="AccessedToPage('correctiveactions')" class="buttonlabel">
                <img src="https://i0.wp.com/hellonimbly.com/wp-content/uploads/2022/09/BLOG-Social-Media_September_5-Important-Benefits-of-Corrective-Action-Report-in-Business.jpg?fit=1281%2C721&ssl=1" alt="Corrective Actions" title="Corrective Actions">
                <span>Corrective Actions</span>
            </button> 

            <button onclick="AccessedToPage('waterlevelmonitoring')" class="buttonlabel">
                <img src="water-level.webp" alt="Water Level Monitoring" title="Water Level Monitoring">
                <span>Water Level Monitoring</span>
            </button> 

             <button onclick="AccessedToPage('reports')" class="buttonlabel">
                <img src="business-report.webp" alt="Reports" title="Reports">
                <span>Reports</span>
            </button> 
          
        </div>
        <script>
            const department = sessionStorage.getItem("department");
            document.getElementById("section").value = department || "";
            function AccessedToPage(pagename){
                
                window.location.href= pagename+".html";
            }
            
         if (department?.toLowerCase() !== "wsp") {
            const buttons = document.querySelectorAll(".buttonlabel");
            const waterLevelButton = buttons[2];  // الزر الثالث
            const reportsButton = buttons[3];
            waterLevelButton.disabled = true;     // تعطيل الزر
            reportsButton.disabled = true;
            waterLevelButton.style.opacity = "0.5";  // شكل يدل على أنه غير فعّال
            reportsButton.style.opacity = "0.5";  // شكل يدل على أنه غير فعّال
            waterLevelButton.style.pointerEvents = "none"; // يمنع الضغط عليه نهائيًا
            reportsButton.style.pointerEvents = "none"; // يمنع الضغط عليه نهائيًا
        }
             // فتح نافذة إضافة مستخدم
            function openAddUserPopup() {
                const userRole = sessionStorage.getItem("role");
                if (userRole !== "Admin") {
                    console.log("User Role:", userRole)

                    alert("Only admin can add users.");
                    return;
                }
                document.getElementById("addUserPopup").style.display = "flex";
            }

            // غلق نافذة إضافة مستخدم
            function closeAddUserPopup() {
                document.getElementById("addUserPopup").style.display = "none";
            }

            // معالجة إرسال نموذج إضافة المستخدم
            function submitUserForm(event) {
                event.preventDefault();
            
                const newEmail = document.getElementById("email").value;  // البريد الإلكتروني الجديد
                const password = document.getElementById("password").value;
                const department = document.getElementById("branch").value;
                const userRole = document.getElementById("role").value;
                console.log("User Role:", userRole);
            
                fetch("https://script.google.com/macros/s/AKfycbzeIctN1LZN0C90D1cjzdpzoivB6IajhcQyg1pyO_qrLRDg7wYvUYAgvWpiX31CmfIj7w/exec", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/x-www-form-urlencoded"
                    },
                    body: new URLSearchParams({
                        action: "addUser",
                        adminEmail: sessionStorage.getItem("email"),
                        email: newEmail,          // ✅ الاسم الصحيح
                        password: password,
                        role: userRole,
                        department: department
                    })
                })
                .then(res => res.json())
                .then(data => {
                    console.log(data);
                    alert(data.message);
                })
                .catch(err => alert(err.message));

            }


            // فتح نافذة حذف مستخدم
            function openDeleteUserPopup() {
                const userRole = sessionStorage.getItem("role");
                if (userRole !== "admin") {
                    alert("Only admin can delete users.");
                    return;
                }
                document.getElementById("deleteUserPopup").style.display = "flex";
            }

            // غلق نافذة حذف مستخدم
            function closeDeleteUserPopup() {
                document.getElementById("deleteUserPopup").style.display = "none";
            }

            // معالجة إرسال نموذج حذف المستخدم
            function submitDeleteUserForm(event) {
                event.preventDefault();

                const emailToDelete = document.getElementById("emailToDelete").value;
                
                // استدعاء Google Apps Script لحذف المستخدم
                google.script.run
                    .withSuccessHandler(function(response) {
                        alert(response.message);  // عرض رسالة نجاح
                        closeDeleteUserPopup();
                    })
                    .withFailureHandler(function(error) {
                        alert("Error: " + error.message);  // عرض رسالة خطأ
                    })
                    .deleteUser(sessionStorage.getItem("email"), emailToDelete);  // تمرير البريد الإلكتروني للأدمن والمستخدم المراد حذفه
            }
            //  تسجيل الخروج
            function logout() {
                sessionStorage.clear(); // مسح بيانات الجلسة
                alert("You have been logged out");
                window.location.href = "index.html"; // إعادة توجيه لصفحة تسجيل الدخول
            }
  


        </script>
    </body>






</html>













































