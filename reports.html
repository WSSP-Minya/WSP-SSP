<!DOCTYPE html>
<html>
  <head>
    <title>Reports</title>
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
     
        <div class="username">
          <label for="email" class="dislabel">Email</label>
          <input id="email" value="" disabled>
        </div>
      
        <div class="region">
          <label for="section" class="dislabel">Section</label>
          <input id="section" value="" disabled>
        </div>
      
        <form onsubmit="return false;">
          <h1>Reports</h1>
          <br><br>
      
          <div class="generalinfo">
            <div>
              <label class="infolabel">Branch</label>
              <select id="branch">
                <option value="" selected disabled>Select Branch</option>
                <option value="الكل">الكل</option>
                <option value="العدوه">العدوه</option>
                <option value="مغاغة">مغاغة</option>
                <option value="بنى مزار">بنى مزار</option>
                <option value="مطاى">مطاى</option>
                <option value="سمالوط">سمالوط</option>
                <option value="المنيا">المنيا</option>
                <option value="ابوقرقاص">ابوقرقاص</option>
                <option value="ملوى">ملوى</option>
                <option value="ديرمواس">ديرمواس</option>
              </select>
            </div>
      
            <div>
              <label class="infolabel">Station</label>
              <select id="station">
                <option value="" selected disabled>Select Station</option>
              </select>
            </div>
            <div>
              <label>Status</label>
              <select id="status">
                <option value="" selected disabled>Select Status</option>
                <option value="تم">تم</option>
                <option value="جارى">جارى</option>
                <option value="لم يتم">لم يتم</option>
              </select>
            </div>
            <button>Report All</button>
            <button>Report Branch</button>
            <button type="button" id="reportstation">Report Station</button>
            
        </form>

      
     <script>
          const email = sessionStorage.getItem("email");
          const department = sessionStorage.getItem("department");
    
    
      
          document.getElementById("email").value = email || "";
          document.getElementById("section").value = department || "";
    
             
          const stationSelect = document.getElementById("station");
          const branchSelect = document.getElementById("branch");
          const certifiedDateInput = document.getElementById("certifieddate");
          const locationSelect = document.getElementById("location");
          const riskInput = document.getElementById("risk");
          const corractionInput = document.getElementById("corraction");
          const durationInput = document.getElementById("duration");
          const statusSelect = document.getElementById("status");
          const branchcomment = document.getElementById("branchcomment");
          const wspcomment = document.getElementById("wspcomment");
          const branchbuttons = document.querySelectorAll('.branchbutton');
          const wspbuttons = document.querySelectorAll('.wspbutton');
 
         // جلب المحطات بناءً على الفرع
          function fetchStations(branch) {
            if (!branch) return;
    
            stationSelect.innerHTML = '<option value="" disabled selected>Loading Stations..</option>';
    
            const url = scriptURL + "?action=getStations&branch=" + encodeURIComponent(branch);
    
            fetch(url)
              .then(res => res.json())
              .then(data => {
                if (data.status === "success") {
                  stationSelect.innerHTML = '<option value="" disabled selected>Select Station</option>';
                  branchStations = data.stations;
                  branchDates = data.certifiedDates;
    
                  data.stations.forEach(station => {
                    const option = document.createElement("option");
                    option.value = station;
                    option.textContent = station;
                    stationSelect.appendChild(option);
                  });
                } else {
                  stationSelect.innerHTML = '<option value="" disabled selected>Not found</option>';
                }
              })
              .catch(err => {
                console.error("Error fetching stations:", err);
                stationSelect.innerHTML = '<option value="" disabled selected>Connection Error</option>';
              });
          }
        
                // ملء تفاصيل الموقع
          function fillStationDetails(details) {
            locationSelect.innerHTML = '<option value="" disabled selected>Select Location</option>';
            locationSelect.detailsMap = {};
            details.forEach((detail, index) => {
              const option = document.createElement("option");
              option.value = index;  // أرسل نص الموقع
              option.textContent = detail.location || "Unnamed Location";
              locationSelect.appendChild(option);
              locationSelect.detailsMap[index] = detail;
            });
          }
    
          locationSelect.addEventListener("change", () => {
            const selectedKey = locationSelect.value;
            if (!selectedKey) return;
    
            const detail = locationSelect.detailsMap[selectedKey];
    
            if (detail) {
              riskInput.value = detail.risk || "";
              corractionInput.value = detail.corraction || "";
              durationInput.value = detail.duration || "";
    
              let status = (detail.status || "").trim();
              switch (true) {
                case /تم/.test(status): status = "تم"; break;
                case /جار/.test(status): status = "جارى"; break;
                case /لم/.test(status): status = "لم يتم"; break;
                default: status = "";
              }
              statusSelect.value = status;
              branchcomment.value = detail.branchcomment || "";
              wspcomment.value = detail.wspcomment || "";
    
              if (detail.attachment) {
                document.getElementById("filename").innerHTML = `<a href="${detail.attachment}" target="_blank">Show File</a>`;
              } else {
                document.getElementById("filename").textContent = "No File";
              }
            }
          });

    
          // عند تغيير المحطة
          stationSelect.addEventListener("change", () => {
            const selectedStation = stationSelect.value;
            const index = branchStations.indexOf(selectedStation);
            if (index !== -1 && branchDates[index]) {
              const date = new Date(branchDates[index]);
              const year = date.getFullYear();
              const month = String(date.getMonth() + 1).padStart(2, '0');
              const day = String(date.getDate()).padStart(2, '0');
              certifiedDateInput.value = `${year}-${month}-${day}`;
            } else certifiedDateInput.value = "";
    
            fetch(scriptURL + "?action=getStationDetails&station=" + encodeURIComponent(selectedStation))
              .then(res => res.json())
              .then(data => {
                if (data.status === "success" && data.details.length > 0) fillStationDetails(data.details);
                else {
                  locationSelect.innerHTML = '<option value="" disabled selected>No locations</option>';
                  riskInput.value = corractionInput.value = durationInput.value = statusSelect.value = "";
                  branchcomment.value = wspcomment.value = "";
                  document.getElementById("filename").textContent = "";
                }
              })
              .catch(err => console.error("Error fetching station details:", err));
          });
        };
            // طباعة الاجراءات التصحيحة 
          document.getElementById("reportstation").addEventListener("click", () => {
          const branch = document.getElementById("branch").value || "----";
          const station = document.getElementById("station").value || "----";
          const certifiedDate = document.getElementById("certifieddate").value || "----";
      
          const locationSelect = document.getElementById("location");
          const detailsMap = locationSelect.detailsMap;
      
          if (!detailsMap || Object.keys(detailsMap).length === 0) {
              alert("No Data for Print!");
              return;
          }
            
          // جميع الإجراءات
            const allLocations = Object.values(detailsMap) || [];
            
            
            // 2) عدد الاجراءات المنفذة 
            const doneActionsCount = allLocations.filter(item => item.status?.trim() === "تم").length;      
            // 2) عدد الإجراءات الجارية
            const inProgressActionsCount = allLocations.filter(item => item.status?.trim() === "جارى").length;
            // 4) عدد الإجراءات لم يتم التنفيذ
            const notDoneActionsCount = allLocations.filter(item => item.status?.trim() === "لم يتم").length;
            // 1) إجمالي عدد الإجراءات التصحيحية
            const totalActionsCount = doneActionsCount + inProgressActionsCount + notDoneActionsCount;
      
          // تصفية المواقع المعتمدة فقط (checkbox = false)
          const approvedLocations = Object.values(detailsMap).filter(detail => detail.checkbox === false);
      
          if (approvedLocations.length === 0) {
              alert("لا توجد مواقع معتمدة للطباعة!");
              return;
          }
      
          let rowsHtml = approvedLocations.map(detail => `
              <tr>
                  <td>${detail.location || ""}</td>
                  <td>${detail.risk || ""}</td>
                  <td>${detail.corraction || ""}</td>
                  <td>${detail.duration || ""}</td>
                  <td>${detail.status || ""}</td>
                  
              </tr>
          `).join("");
    
            
    
      
          const htmlContent = `
              <html>
              <head>
                  <title>تقرير الاعتماد</title>
                  <style>
                      body { font-family: Arial, sans-serif; direction: rtl; text-align: right; }
                      table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                      th, td { border: 1px solid #000; padding: 5px; word-wrap: break-word; }
                      th { background-color: #f0f0f0; }
                      h2 { text-align: center; }
                      p { text-align: center;}
                      /* تحديد أقل عرض لكل عمود (يمكن تعديلها كما تريد) */
                      th:nth-child(1), td:nth-child(1) { width: 10%; } /* الموقع */
                      th:nth-child(2), td:nth-child(2) { width: 15%; } /* الخطر */
                      th:nth-child(3), td:nth-child(3) { width: 25%; } /* الإجراء التصحيحي */
                      th:nth-child(4), td:nth-child(4) { width: 10%; } /* المدة */
                      th:nth-child(5), td:nth-child(5) { width: 10%; } /* الموقف التنفيذي */
                      th:nth-child(6), td:nth-child(6) { width: 25%; } /* الملاحظات */
                  </style>
              </head>
              <body>
                  <h2>تقرير الموقف من تنفيذ الاجراءات التصحيحية</h2>
                  <p><strong>الفرع:</strong> ${branch} &nbsp;&nbsp;&nbsp;&nbsp; <strong>النظام:</strong> ${station} &nbsp;&nbsp;&nbsp;&nbsp <strong>تاريخ الاعتماد:</strong> ${certifiedDate}</p>
                  
                  <table>
                      <thead>
                          <tr>
                              <th>إجمالى عدد الاجراءات التصحيحية</th>
                              <th>عدد الاجراءات التصحيحية المنفذة</th>
                              <th>عدد الاجراءات التصحيحية الجارية</th>
                              <th>عدد الاجراءات التصحيحية لم يتم تنفيذها</th>
                                                           
                          </tr>
                      </thead>
                      <tbody>
                          <td>${totalActionsCount}</td>
                          <td>${doneActionsCount}</td>
                          <td>${inProgressActionsCount}</td>
                          <td>${notDoneActionsCount}</td>
                      </tbody>
                          
                  
                  </table>
                  
                  
    
                  <table>
                      <thead>
                          <tr>
                              <th>الموقع</th>
                              <th>الخطر</th>
                              <th>الإجراء التصحيحي</th>
                              <th>المدة الزمنية</th>
                              <th>الموقف التنفيذي</th>
                              
                          </tr>
                      </thead>
                      <tbody>
                          ${rowsHtml}
                      </tbody>
                  </table>
              </body>
              </html>
          `;
      
          const printWindow = window.open('', '', 'height=600,width=800');
          printWindow.document.write(htmlContent);
          printWindow.document.close();
          printWindow.focus();
          printWindow.print();
      });


     </script>
  </body>

</html>
