<!DOCTYPE html>
<html>
  <head>
    <title>Reports</title>
    <link rel="stylesheet" href="report.css" />
   
  </head>
  <body>
     
      <div class="topbar">
           <button class="logout-button" onclick="logout()">Logout</button>
           <div class="userinfo"> 
                <label>Section</label>
                <input id="section" disabled>
           </div>
    
           <img src="https://wssp.hcww.com.eg/public/static/media/wsp.22cd4e849308ae80b006.png" class="logo">
      </div>
      
      <form onsubmit="return false;">
          <h1>Reports</h1>
          <br><br>
      
          <div class="generalinfo">
            <div>
              <label class="infolabel">Branch</label>
              <select id="branch">
                <option value="" selected disabled>Select Branch</option>
                <option value="العدوه">العدوه</option>
                <option value="مغاغة">مغاغة</option>
                <option value="بنى مزار">بنى مزار</option>
                <option value="مطاى">مطاى</option>
                <option value="سمالوط">سمالوط</option>
                <option value="المنيا">المنيا</option>
                <option value="ابوقرقاص">ابوقرقاص</option>
                <option value="ملوى">ملوى</option>
                <option value="ديرمواس">ديرمواس</option>
              </select>
            </div>
      
            <div>
              <label class="infolabel">Station</label>
              <select id="station">
                <option value="" selected disabled>Select Station</option>
              </select>
            </div>
            <div>
              <label class="infolabel">Certified Date</label>
              <input type="date" id="certifieddate" readonly>
            </div>
            <div hidden>
              <label>Status</label>
              <select id="status">
                <option value="" selected disabled>Select Status</option>
                <option value="تم">تم</option>
                <option value="جارى">جارى</option>
                <option value="لم يتم">لم يتم</option>
              </select>
            </div>
            <div class="location" hidden>
              <label>Location</label>
              <select id="location">
                <option value="">Select Location</option>
              </select>
            </div>
            <div class="form-buttons">
                <button type="button" id="reportstation" >Report Station</button>
                <button type="button" id="reportbranch" >Report Branch</button>
                <button type="button" id="reportall" >Report All</button>
                <button type="button" id="reportwspcomments" >Report WSP</button>
                <button type="button" id="reportdeadlinebranch" >Report Deadline</button>
            </div>
      </form>


      
     <script>
          const scriptURL = "https://script.google.com/macros/s/AKfycby2x5YYVS5VlI8zuRjecdVXGR3zIZMDGUjE1b1bAVl14pXsYh0ymvwtcBzx1tXL_RHf6A/exec";
    
  
          window.onload = () => {
           
            const email = sessionStorage.getItem("email");
            const department = sessionStorage.getItem("department");
            const branchSelect = document.getElementById("branch");
            const stationSelect = document.getElementById("station");
            const certifiedDateInput = document.getElementById("certifieddate");
            const locationSelect = document.getElementById("location");
      
      
        
            
            document.getElementById("section").value = department || "";

            branchSelect.addEventListener("change", () => {
            console.log("Branch changed:", branchSelect.value);
            fetchStations(branchSelect.value);
        });


            let branchStations = [];
            let branchDates = [];
        
            
      
            // جلب المحطات بناءً على الفرع
            function fetchStations(branch) {
              if (!branch) {
              console.log("Branch is not provided or invalid.");
              return;}
              console.log("Fetching stations for branch:", branch);
              stationSelect.innerHTML = '<option value="" disabled selected>Loading Stations..</option>';
      
              const url = scriptURL + "?action=getStations&branch=" + encodeURIComponent(branch);
      
              fetch(url)
                .then(res => res.json())
                .then(data => {
                  console.log("datastation:", data)
                  if (data.status === "success") {
                    stationSelect.innerHTML = '<option value="" disabled selected>Select Station</option>';
                    branchStations = data.stations;
                    branchDates = data.certifiedDates;
      
                    data.stations.forEach(station => {
                      const option = document.createElement("option");
                      option.value = station;
                      option.textContent = station;
                      stationSelect.appendChild(option);
                    });
                  } else {
                    stationSelect.innerHTML = '<option value="" disabled selected>Not found</option>';
                  }
                })
                .catch(err => {
                  console.error("Error fetching stations:", err);
                  stationSelect.innerHTML = '<option value="" disabled selected>Connection Error</option>';
                });
            }
            // ملء تفاصيل الموقع
             window.fillStationDetails = function(details) {
              locationSelect.innerHTML = '<option value="" disabled selected>Select Location</option>';
              locationSelect.detailsMap = {};
              details.forEach((detail, index) => {
                              
               
                const option = document.createElement("option");
                option.value = index;  // أرسل نص الموقع
                option.textContent = detail.location || "Unnamed Location";
                locationSelect.appendChild(option);
                locationSelect.detailsMap[index] = detail;
              });
            }
      
            locationSelect.addEventListener("change", () => {
              const selectedKey = locationSelect.value;
              if (!selectedKey) return;
      
              const detail = locationSelect.detailsMap[selectedKey];
      
              if (detail) {
                riskInput.value = detail.risk || "";
                corractionInput.value = detail.corraction || "";
                durationInput.value = detail.duration || "";
      
                let status = (detail.status || "").trim();
                switch (true) {
                  case /^تم$/.test(status): status = "تم"; break;
                  case /^جارى$/.test(status): status = "جارى"; break;
                  case /^لم يتم$/.test(status): status = "لم يتم"; break;
                  default: status = "";
                }
                statusSelect.value = status;
                branchcomment.value = detail.branchcomment || "";
                wspcomment.value = detail.wspcomment || "";
      
                if (detail.attachment) {
                  document.getElementById("filename").innerHTML = `<a href="${detail.attachment}" target="_blank">Show File</a>`;
                } else {
                  document.getElementById("filename").textContent = "No File";
                }
              }
            });

            // عند تغيير المحطة
            stationSelect.addEventListener("change", () => {
              const selectedStation = stationSelect.value;
              const index = branchStations.indexOf(selectedStation);
              if (index !== -1 && branchDates[index]) {
                const date = new Date(branchDates[index]);
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                certifiedDateInput.value = `${year}-${month}-${day}`;
              } else certifiedDateInput.value = "";
      
              fetch(scriptURL + "?action=getStationDetails&station=" + encodeURIComponent(selectedStation))
                .then(res => res.json())
                .then(data => {
                 
                  if (data.status === "success" && data.details.length > 0) fillStationDetails(data.details);
                   
                  else {
                    locationSelect.innerHTML = '<option value="" disabled selected>No locations</option>';
                    riskInput.value = corractionInput.value = durationInput.value = statusSelect.value = "";
                    branchcomment.value = wspcomment.value = "";
                    document.getElementById("filename").textContent = "";
                  }
                })
                .catch(err => console.error("Error fetching station details:", err));
            });
          };
  /////////////////////////////////////////////////////////////////////////////////////////////
 /////////////////////////////////////////////////////////////////////////////////////////////
          ////طباعة تقرير الاجراءات التصحيحية لمحطة واحدة
         document.getElementById("reportstation").addEventListener("click", () => {
          const branch = document.getElementById("branch").value || "----";
          const station = document.getElementById("station").value || "----";
          const certifiedDate = document.getElementById("certifieddate").value || "----";
      
          const locationSelect = document.getElementById("location");
          const detailsMap = locationSelect.detailsMap;
      
          if (!detailsMap || Object.keys(detailsMap).length === 0) {
              alert("No Data for Print!");
              return;
          }
      
          const allLocations = Object.values(detailsMap) || [];
      
          const doneActionsCount = allLocations.filter(item => item.status?.trim() === "تم").length;
          const inProgressActionsCount = allLocations.filter(item => item.status?.trim() === "جارى").length;
          const notDoneActionsCount = allLocations.filter(item => item.status?.trim() === "لم يتم").length;
          const totalActionsCount = doneActionsCount + inProgressActionsCount + notDoneActionsCount;
      
          if (allLocations.length === 0) {
              alert("لا توجد بيانات للطباعة!");
              return;
          }
      
          let rowsHtml = allLocations.map(detail => {
              // تغيير لون الصف حسب حالة التنفيذ
              let rowColor = "";
              if (detail.status?.trim() === "جارى") rowColor = "background-color:#fff3cd;"; // أصفر فاتح
              else if (detail.status?.trim() === "لم يتم") rowColor = "background-color:#f8d7da;"; // أحمر فاتح
      
              return `
              <tr style="${rowColor}">
                  <td>${detail.location || ""}</td>
                  <td>${detail.risk || ""}</td>
                  <td>${detail.corraction || ""}</td>
                  <td>${detail.duration || ""}</td>
                  <td>${detail.status || ""}</td>
              </tr>
              `;
          }).join("");
      
          const htmlContent = `
              <html>
              <head>
                  <title>تقرير الاعتماد</title>
                  <style>
                      body {font-family: Arial, sans-serif; direction: rtl; text-align: right; margin: 20px;}
                      h2 {text-align: center;margin-bottom: 10px;}
                      p {text-align: center; margin-bottom: 20px; font-size: 16px;}
                      table {
                          width: 100%;
                          border-collapse: collapse;
                          margin-bottom: 30px;
                      }
                      th, td {
                          border: 1px solid #000;
                          padding: 8px;
                          text-align: center;
                          word-wrap: break-word;
                      }
                      th {
                          background-color: #f0f0f0;
                          color: black;
                          font-weight: bold;
                      }
                      tr:nth-child(even) td {
                          background-color: #f9f9f9;
                      }
                      .logo-container {
                          text-align: right; /* محاذاة الصور لليمين */
                          margin-bottom: 20px;
                          display: flex;
                          justify-content: flex-start; /* محاذاة الصور لليمين */
                          gap: 10px;
                      }
                      .logo-container img {
                          width: 80px; /* تغيير الحجم حسب الحاجة */
                          margin-top: 5px;
                      }
                      .summary-table th {
                          background-color: #dcdcdc;
                          font-weight: bold;
                      }
                      .summary-table td {
                          text-align: center;
                          padding: 10px;
                      }
                      .content-section {
                          margin-top: 20px;
                      }
                  </style>
              </head>
              <body>
                  <div class="logo-container">
                      <img src="https://wssp.hcww.com.eg/public/company_logo/menia.png" alt="logo">
                      <img src="https://wssp.hcww.com.eg/public/static/media/wsp.22cd4e849308ae80b006.png" alt="logo">
                  </div>
                  <h2>تقرير الموقف من تنفيذ الاجراءات التصحيحية</h2>
                  <p>
                      <strong>الفرع:</strong> ${branch} &nbsp;&nbsp;
                      <strong>النظام:</strong> ${station} &nbsp;&nbsp;
                      <strong>تاريخ الاعتماد:</strong> ${certifiedDate}
                  </p>
      
                  <!-- جدول الإحصائيات -->
                  <div class="content-section">
                      <h3>ملخص الموقف التنفيذى للإجراءات التصحيحية</h3>
                      <table class="summary-table">
                          <thead>
                              <tr>
                                  <th>عدد الإجراءات التصحيحية</th>
                                  <th>عدد الإجراءات المنفذة</th>
                                  <th>عدد الإجراءات الجارية</th>
                                  <th>عدد الإجراءات لم يتم التنفيذ</th>
                              </tr>
                          </thead>
                          <tbody>
                              <tr>
                                  <td>${totalActionsCount}</td>
                                  <td>${doneActionsCount}</td>
                                  <td>${inProgressActionsCount}</td>
                                  <td>${notDoneActionsCount}</td>
                              </tr>
                          </tbody>
                      </table>
                  </div>
      
                  <!-- جدول التفاصيل -->
                  <div class="content-section">
                      <h3>تفاصيل الإجراءات التصحيحية</h3>
                      <table>
                          <thead>
                              <tr>
                                  <th>الموقع</th>
                                  <th>الخطر</th>
                                  <th>الإجراء التصحيحي</th>
                                  <th>المدة الزمنية</th>
                                  <th>الموقف التنفيذي</th>
                              </tr>
                          </thead>
                          <tbody>
                              ${rowsHtml}
                          </tbody>
                      </table>
                  </div>
              </body>
              </html>
          `;
      
          const printWindow = window.open('', '', 'height=700,width=900');
          printWindow.document.write(htmlContent);
          printWindow.document.close();
          printWindow.focus();
          printWindow.print();
      });


        /////////////////////////////// كل المحطات الفرع الواحد المختار
        document.getElementById("reportbranch").addEventListener("click", async () => {
            const branch = document.getElementById("branch").value || "----";
        
            // جلب جميع المحطات للفرع من السيرفر
            const stationsResponse = await fetch(`${scriptURL}?action=getStations&branch=${encodeURIComponent(branch)}`);
            const stationsData = await stationsResponse.json();
        
            if (stationsData.status !== "success" || !stationsData.stations || stationsData.stations.length === 0) {
                alert("لا توجد محطات لهذا الفرع للطباعة!");
                return;
            }
        
            let htmlContent = `
                <html>
                <head>
                    <title>تقرير الاعتماد لكل المحطات</title>
                    <style>
                        body { font-family: Arial, sans-serif; direction: rtl; text-align: right; }
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                        th, td { border: 1px solid #000; padding: 5px; word-wrap: break-word; }
                        th { background-color: #f0f0f0; }
                        h2, h3 { text-align: center; }
                         .logo-container {
                          text-align: center;
                          margin-bottom: 20px;
                          margin-left:100%;
                          display: flex;
                          gap: 5px;
                      }
                  
                      .logo-container img {
                          width: 60px; /* ← يمكنك تغيير الحجم */
                      }
                    </style>
                </head>
                <body>
                   <div class="logo-container">
                      <img src="https://wssp.hcww.com.eg/public/company_logo/menia.png" alt="logo">
                      <img src="https://wssp.hcww.com.eg/public/static/media/wsp.22cd4e849308ae80b006.png" alt="logo">
                    </div>
                    <h2>تقرير الموقف من تنفيذ الاجراءات التصحيحية لكل محطات فرع: ${branch}</h2>
            `;
        
            // --------- جدول الملخص لجميع المحطات ---------
            htmlContent += `
                <h3>ملخص جميع المحطات</h3>
                <table>
                    <tr>
                        <th>المحطة</th>
                        <th>إجمالي الإجراءات</th>
                        <th>المنفذ</th>
                        <th>الجارية</th>
                        <th>لم يتم التنفيذ</th>
                    </tr>
            `;
        
            const allDetailsPerStation = {}; // لتخزين التفاصيل لكل محطة
        
            // تعديل هنا: استخدام Promise.all لتحميل تفاصيل المحطات بشكل متوازي
            // تم تعديل هذه الكود لجعل تحميل التفاصيل للمحطات يتم بشكل متوازي بدلاً من التتابع
            const stationPromises = stationsData.stations.map(async (station) => {
                const detailsResponse = await fetch(`${scriptURL}?action=getStationDetails&station=${encodeURIComponent(station)}`);
                const detailsData = await detailsResponse.json();
        
                let totalActions = 0, doneActions = 0, inProgressActions = 0, notDoneActions = 0;
        
                if (detailsData.status === "success" && detailsData.details && detailsData.details.length > 0) {
                    const allLocations = detailsData.details;
                    totalActions = allLocations.length;
                    doneActions = allLocations.filter(item => item.status?.trim() === "تم").length;
                    inProgressActions = allLocations.filter(item => item.status?.trim() === "جارى").length;
                    notDoneActions = allLocations.filter(item => item.status?.trim() === "لم يتم").length;
        
                    // تخزين التفاصيل لكل محطة لاستخدامها لاحقًا في الجدول التفصيلي
                    allDetailsPerStation[station] = allLocations;
                }
        
                return { station, totalActions, doneActions, inProgressActions, notDoneActions };
            });
        
            // تعديل هنا: استخدام Promise.all لانتظار جميع الوعود (promises) المتعلقة بالمحطات
            const stationSummary = await Promise.all(stationPromises);
        
            // إضافة بيانات المحطات في جدول الملخص
            stationSummary.forEach(({ station, totalActions, doneActions, inProgressActions, notDoneActions }) => {
                htmlContent += `
                    <tr>
                        <td>${station}</td>
                        <td>${totalActions}</td>
                        <td>${doneActions}</td>
                        <td>${inProgressActions}</td>
                        <td>${notDoneActions}</td>
                    </tr>
                `;
            });
        
            htmlContent += `</table>`;
        
            // --------- الجداول التفصيلية لكل محطة ---------
            // إضافة التفاصيل لكل محطة باستخدام البيانات المخزنة في allDetailsPerStation
            for (const station of Object.keys(allDetailsPerStation)) {
                const allLocations = allDetailsPerStation[station];
                const detailRowsHtml = allLocations.map(detail => `
                    <tr>
                        <td>${detail.location || ""}</td>
                        <td>${detail.risk || ""}</td>
                        <td>${detail.corraction || ""}</td>
                        <td>${detail.duration || ""}</td>
                        <td>${detail.status || ""}</td>
                    </tr>
                `).join("");
        
                htmlContent += `
                    <h4>تفاصيل الإجراءات لكل موقع في محطة: ${station}</h4>
                    <table>
                        <thead>
                            <tr>
                                <th>الموقع</th>
                                <th>الخطر</th>
                                <th>الإجراء التصحيحي</th>
                                <th>المدة الزمنية</th>
                                <th>الموقف التنفيذي</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${detailRowsHtml}
                        </tbody>
                    </table>
                `;
            }
        
            htmlContent += `</body></html>`;
        
            // فتح نافذة الطباعة
            const printWindow = window.open('', '', 'height=800,width=1000');
            if (!printWindow) {
                alert("تعذر فتح نافذة الطباعة. يرجى السماح بالبوب‌آب في المتصفح.");
                return;
            }
        
            printWindow.document.write(htmlContent);
            printWindow.document.close();
            printWindow.focus();
            printWindow.print();
        });

       //////////////////////تقرير مجمع للفروع كلها
            
            document.getElementById("reportall").addEventListener("click", async () => {
              const branchSelect = document.getElementById("branch");
              const branchOptions = Array.from(branchSelect.options)
                                         .filter(opt => opt.value && opt.value !== "----"); // تجاهل placeholder
          
              if (branchOptions.length === 0) {
                  alert("لا توجد فروع للطباعة!");
                  return;
              }
          
              let htmlContent = `
                  <html>
                  <head>
                      <title>تقرير الموقف من تنفيذ الإجراءات التصحيحية لكل الفروع</title>
                      <style>
                          body { font-family: Arial, sans-serif; direction: rtl; text-align: right; }
                          table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                          th, td { border: 1px solid #000; padding: 5px; word-wrap: break-word; }
                          th { background-color: #f0f0f0; }
                          h2, h3 { text-align: center; }
                           .logo-container {
                            text-align: center;
                            margin-bottom: 20px;
                            margin-left:100%;
                            display: flex;
                            gap: 5px;
                        }
          
                        .logo-container img {
                            width: 60px; /* ← يمكنك تغيير الحجم */
                        }
                      </style>
                  </head>
                  <body>
                      <div class="logo-container">
                          <img src="https://wssp.hcww.com.eg/public/company_logo/menia.png" alt="logo">
                          <img src="https://wssp.hcww.com.eg/public/static/media/wsp.22cd4e849308ae80b006.png" alt="logo">
                      </div>
                      <h2>تقرير الموقف من تنفيذ الاجراءات التصحيحية لجميع فروع الشركة</h2>
                      <h3>ملخص لكل الفروع</h3>
                      <table>
                          <tr>
                              <th>الفرع</th>
                              <th>إجمالي الإجراءات</th>
                              <th>المنفذ</th>
                              <th>الجارية</th>
                              <th>لم يتم التنفيذ</th>
                          </tr>
              `;
          
              const allDetailsPerBranch = {}; // لتخزين التفاصيل لكل فرع
          
              // تعديل هنا: استخدام Promise.all لتحميل المحطات بشكل متوازي (Parallel Fetching)
              // تم تعديل الكود لاستخدام Promise.all لتحميل بيانات المحطات وتفاصيل المحطات بشكل متوازي
              const branchPromises = branchOptions.map(async (opt) => {
                  const branch = opt.value;
          
                  // جلب المحطات لكل فرع
                  const stationsResponse = await fetch(`${scriptURL}?action=getStations&branch=${encodeURIComponent(branch)}`);
                  const stationsData = await stationsResponse.json();
          
                  let branchTotal = 0, branchDone = 0, branchInProgress = 0, branchNotDone = 0;
                  allDetailsPerBranch[branch] = {};
          
                  if (stationsData.status === "success" && stationsData.stations?.length) {
                      // استخدام Promise.all لتحميل تفاصيل المحطات بشكل متوازي
                      const stationPromises = stationsData.stations.map(async (station) => {
                          const detailsResponse = await fetch(`${scriptURL}?action=getStationDetails&station=${encodeURIComponent(station)}`);
                          const detailsData = await detailsResponse.json();
          
                          let totalActions = 0, doneActions = 0, inProgressActions = 0, notDoneActions = 0;
          
                          if (detailsData.status === "success" && detailsData.details?.length) {
                              const allLocations = detailsData.details;
          
                              totalActions = allLocations.length;
                              doneActions = allLocations.filter(item => item.status?.trim() === "تم").length;
                              inProgressActions = allLocations.filter(item => item.status?.trim() === "جارى").length;
                              notDoneActions = allLocations.filter(item => item.status?.trim() === "لم يتم").length;
          
                              allDetailsPerBranch[branch][station] = allLocations;
                          }
          
                          return { station, totalActions, doneActions, inProgressActions, notDoneActions };
                      });
          
                      // استخدام Promise.all لتحميل تفاصيل كل المحطات بشكل متوازي
                      const stationSummary = await Promise.all(stationPromises);
          
                      // إضافة بيانات المحطات في جدول الملخص
                      stationSummary.forEach(({ station, totalActions, doneActions, inProgressActions, notDoneActions }) => {
                          branchTotal += totalActions;
                          branchDone += doneActions;
                          branchInProgress += inProgressActions;
                          branchNotDone += notDoneActions;
                      });
                  }
          
                  return { branch, branchTotal, branchDone, branchInProgress, branchNotDone };
              });
          
              // الانتظار حتى يتم تحميل جميع الفروع والمحطات بالتوازي
              const branchSummary = await Promise.all(branchPromises);
          
              // إضافة بيانات الفروع في جدول الملخص
              branchSummary.forEach(({ branch, branchTotal, branchDone, branchInProgress, branchNotDone }) => {
                  htmlContent += `
                      <tr>
                          <td>${branch}</td>
                          <td>${branchTotal}</td>
                          <td>${branchDone}</td>
                          <td>${branchInProgress}</td>
                          <td>${branchNotDone}</td>
                      </tr>
                  `;
              });
          
              htmlContent += `</table>`;
          
              // --------- جدول لكل فرع (ملخص لكل محطة) ---------
              for (const branch of Object.keys(allDetailsPerBranch)) {
                  htmlContent += `<h3>ملخص محطات الفرع: ${branch}</h3>`;
                  htmlContent += `
                      <table>
                          <tr>
                              <th>المحطة</th>
                              <th>إجمالي الإجراءات</th>
                              <th>المنفذ</th>
                              <th>الجارية</th>
                              <th>لم يتم التنفيذ</th>
                          </tr>
                  `;
          
                  const stations = Object.keys(allDetailsPerBranch[branch]);
                  for (const station of stations) {
                      const allLocations = allDetailsPerBranch[branch][station];
          
                      const totalActions = allLocations.length;
                      const doneActions = allLocations.filter(item => item.status?.trim() === "تم").length;
                      const inProgressActions = allLocations.filter(item => item.status?.trim() === "جارى").length;
                      const notDoneActions = allLocations.filter(item => item.status?.trim() === "لم يتم").length;
          
                      htmlContent += `
                          <tr>
                              <td>${station}</td>
                              <td>${totalActions}</td>
                              <td>${doneActions}</td>
                              <td>${inProgressActions}</td>
                              <td>${notDoneActions}</td>
                          </tr>
                      `;
                  }
          
                  htmlContent += `</table>`;
              }
          
              const printWindow = window.open('', '', 'height=800,width=1200');
              if (!printWindow) {
                  alert("تعذر فتح نافذة الطباعة. يرجى السماح بالبوب‌آب في المتصفح.");
                  return;
              }
          
              printWindow.document.write(htmlContent);
              printWindow.document.close();
              printWindow.focus();
              printWindow.print();
          });



 
           
           
    
         
           
       //  تسجيل الخروج
        function logout() {
          sessionStorage.clear(); // مسح بيانات الجلسة
          alert("You have been logged out");
          window.location.href = "index.html"; // إعادة توجيه لصفحة تسجيل الدخول
        }
  /////////////////////////////////////////////////////////////////////////////////////////////
 /////////////////////////////////////////////////////////////////////////////////////////////       
        /////////////طباعة تقرير ملاحظات WSP  الاجراءات التصحيحية لمحطة واحدة
         document.getElementById("reportwspcomments").addEventListener("click", () => {
          const branch = document.getElementById("branch").value || "----";
          const station = document.getElementById("station").value || "----";
          const certifiedDate = document.getElementById("certifieddate").value || "----";
      
          const locationSelect = document.getElementById("location");
          const detailsMap = locationSelect.detailsMap;
      
          if (!detailsMap || Object.keys(detailsMap).length === 0) {
              alert("No Data for Print!");
              return;
          }
      
          const allLocations = Object.values(detailsMap) || [];
      
          const doneActionsCount = allLocations.filter(item => item.status?.trim() === "تم").length;
          const inProgressActionsCount = allLocations.filter(item => item.status?.trim() === "جارى").length;
          const notDoneActionsCount = allLocations.filter(item => item.status?.trim() === "لم يتم").length;
          const totalActionsCount = doneActionsCount + inProgressActionsCount + notDoneActionsCount;
      
          if (allLocations.length === 0) {
              alert("لا توجد بيانات للطباعة!");
              return;
          }
      
          let rowsHtml = allLocations.map(detail => {
              // تغيير لون الصف حسب حالة التنفيذ
              let rowColor = "";
              if (detail.status?.trim() === "جارى") rowColor = "background-color:#fff3cd;"; // أصفر فاتح
              else if (detail.status?.trim() === "لم يتم") rowColor = "background-color:#f8d7da;"; // أحمر فاتح
      
              return `
              <tr style="${rowColor}">
                  <td>${detail.location || ""}</td>
                  <td>${detail.risk || ""}</td>
                  <td>${detail.corraction || ""}</td>
                  <td>${detail.duration || ""}</td>
                  <td>${detail.status || ""}</td>
                  <td>${detail.wspcomment || ""}</td>
              </tr>
              `;
          }).join("");
      
          const htmlContent = `
              <html>
              <head>
                  <title>تقرير مرور</title>
                  <style>
                      body {font-family: Arial, sans-serif; direction: rtl; text-align: right; margin: 20px;}
                      h2 {text-align: center;margin-bottom: 10px;}
                      p {text-align: center; margin-bottom: 20px; font-size: 16px;}
                      table {
                          width: 100%;
                          border-collapse: collapse;
                          margin-bottom: 30px;
                      }
                      th, td {
                          border: 1px solid #000;
                          padding: 8px;
                          text-align: center;
                          word-wrap: break-word;
                      }
                      th {
                          background-color: #f0f0f0;
                          color: black;
                          font-weight: bold;
                      }
                      tr:nth-child(even) td {
                          background-color: #f9f9f9;
                      }
                      .logo-container {
                          text-align: right; /* محاذاة الصور لليمين */
                          margin-bottom: 20px;
                          display: flex;
                          justify-content: flex-start; /* محاذاة الصور لليمين */
                          gap: 10px;
                      }
                      .logo-container img {
                          width: 80px; /* تغيير الحجم حسب الحاجة */
                          margin-top: 5px;
                      }
                      .summary-table th {
                          background-color: #dcdcdc;
                          font-weight: bold;
                      }
                      .summary-table td {
                          text-align: center;
                          padding: 10px;
                      }
                      .content-section {
                          margin-top: 20px;
                      }
                  </style>
              </head>
              <body>
                  <div class="logo-container">
                      <img src="https://wssp.hcww.com.eg/public/company_logo/menia.png" alt="logo">
                      <img src="https://wssp.hcww.com.eg/public/static/media/wsp.22cd4e849308ae80b006.png" alt="logo">
                  </div>
                  <h2>تقرير الموقف من تنفيذ الاجراءات التصحيحية</h2>
                  <p>
                      <strong>الفرع:</strong> ${branch} &nbsp;&nbsp;
                      <strong>النظام:</strong> ${station} &nbsp;&nbsp;
                      <strong>تاريخ الاعتماد:</strong> ${certifiedDate}
                  </p>
      
                  <!-- جدول الإحصائيات -->
                  <div class="content-section">
                      <h3>ملخص الموقف التنفيذى للإجراءات التصحيحية</h3>
                      <table class="summary-table">
                          <thead>
                              <tr>
                                  <th>عدد الإجراءات التصحيحية</th>
                                  <th>عدد الإجراءات المنفذة</th>
                                  <th>عدد الإجراءات الجارية</th>
                                  <th>عدد الإجراءات لم يتم التنفيذ</th>
                              </tr>
                          </thead>
                          <tbody>
                              <tr>
                                  <td>${totalActionsCount}</td>
                                  <td>${doneActionsCount}</td>
                                  <td>${inProgressActionsCount}</td>
                                  <td>${notDoneActionsCount}</td>
                              </tr>
                          </tbody>
                      </table>
                  </div>
      
                  <!-- جدول التفاصيل -->
                  <div class="content-section">
                      <h3>تفاصيل الإجراءات التصحيحية</h3>
                      <table>
                          <thead>
                              <tr>
                                  <th>الموقع</th>
                                  <th>الخطر</th>
                                  <th>الإجراء التصحيحي</th>
                                  <th>المدة الزمنية</th>
                                  <th>الموقف التنفيذي</th>
                                  <th>ملاحظات WSP</th>
                              </tr>
                          </thead>
                          <tbody>
                              ${rowsHtml}
                          </tbody>
                      </table>
                  </div>
              </body>
              </html>
          `;
      
          const printWindow = window.open('', '', 'height=700,width=900');
          printWindow.document.write(htmlContent);
          printWindow.document.close();
          printWindow.focus();
          printWindow.print();
      });
  /////////////////////////////////////////////////////////////////////////////////////////////
 /////////////////////////////////////////////////////////////////////////////////////////////
       // تقرير لمحطات الفرع عن الاجراءات التى قاربت مدة انتهائها
      // دالة مساعدة لتحليل التواريخ من صيغ مختلفة
      function parseDateSmart(dateStr) {
          if (/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) {
              const [y, m, d] = dateStr.split("-");
              return new Date(y, m - 1, d);
          }
          if (/^\d{2}\/\d{2}\/\d{4}$/.test(dateStr)) {
              const [d, m, y] = dateStr.split("/");
              return new Date(y, m - 1, d);
          }
          return new Date(dateStr);
      }
      
      // تقرير الإجراءات التي قاربت على الانتهاء للفرع المحدد
      document.getElementById("reportdeadlinebranch").addEventListener("click", async () => {
          const branchSelect = document.getElementById("branch");
          const selectedBranch = branchSelect.value;
      
          if (!selectedBranch || selectedBranch === "----") {
              alert("يرجى اختيار فرع!");
              return;
          }
      
          let htmlContent = `
          <html>
          <head>
              <title>تقرير الإجراءات شارفت على انتهاء مدتها</title>
              <style>
                  body { font-family: Arial; direction: rtl; text-align: right; }
                  table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                  th, td { border: 1px solid #000; padding: 6px; }
                  th { background-color: #f0f0f0; }
                  h2, h3 { text-align: center; }
                  .logo-container {
                          text-align: right; /* محاذاة الصور لليمين */
                          margin-bottom: 20px;
                          display: flex;
                          justify-content: flex-start; /* محاذاة الصور لليمين */
                          gap: 10px;
                      }
                      .logo-container img {
                          width: 80px; /* تغيير الحجم حسب الحاجة */
                          margin-top: 5px;
                      }
                  .red { background:#7A0000; color:white; }
                  .lightred { background:#f8d7da; }
              </style>
          </head>
          <body>
              <div class="logo-container">
                 <img src="https://wssp.hcww.com.eg/public/company_logo/menia.png" alt="logo">
                 <img src="https://wssp.hcww.com.eg/public/static/media/wsp.22cd4e849308ae80b006.png" alt="logo">
              </div>
              <h2>تقرير بالإجراءات شارفت على انتهاء مدتها والمنتهية</h2>
          `;
      
          const today = new Date();
          today.setHours(0,0,0,0);
      
          const branch = selectedBranch;
      
          // جلب المحطات الخاصة بالفرع
          const resStations = await fetch(`${scriptURL}?action=getStations&branch=${encodeURIComponent(branch)}`);
          const stationsData = await resStations.json();
      
          htmlContent += `<h3>الفرع: ${branch}</h3>`;
      
          if (stationsData.status !== "success") {
              htmlContent += `<p>لا توجد محطات لهذا الفرع.</p>`;
          } else {
              for (let i = 0; i < stationsData.stations.length; i++) {
                  const station = stationsData.stations[i];
                  const certDateRaw = stationsData.certifiedDates[i];
      
                  let certifiedDate = parseDateSmart(certDateRaw);
                  if (!certifiedDate || isNaN(certifiedDate)) continue;
      
                  const resDetails = await fetch(`${scriptURL}?action=getStationDetails&station=${encodeURIComponent(station)}`);
                  const detailsData = await resDetails.json();
                  if (detailsData.status !== "success") continue;
      
                  let filtered = [];
      
                  detailsData.details.forEach(detail => {
                      // تجاهل الصفوف التي فيها checkbox=true
                      if (detail.checkbox === true) return;
      
                      const durationMonths = parseInt(detail.duration);
                      if (isNaN(durationMonths)) return;
      
                      let endDate = new Date(certifiedDate);
                      endDate.setMonth(endDate.getMonth() + durationMonths);
                      endDate.setHours(0,0,0,0);
      
                      // حساب المتبقي بالشهور
                      let monthsLeft = (endDate.getFullYear() - today.getFullYear()) * 12 +
                                       (endDate.getMonth() - today.getMonth());
      
                      // المطلوب فقط (≤ 3)
                      if (monthsLeft <= 3) {
                          detail.monthsLeft = monthsLeft;
                          detail.endDate = endDate.toISOString().slice(0,10);
                          filtered.push(detail);
                      }
                  });
      
                  if (filtered.length === 0) continue;
      
                  htmlContent += `
                      <h4>المحطة: ${station}</h4>
                      <table>
                          <tr>
                              <th>الموقع</th>
                              <th>الخطر</th>
                              <th>الإجراء التصحيحي</th>
                              <th>تاريخ الانتهاء</th>
                              <th>الموقف</th>
                              <th>ملاحظات WSP</th>
                          </tr>
                  `;
      
                  filtered.forEach(detail => {
                      let rowClass = (detail.monthsLeft <= 0) ? "red" : "lightred";
      
                      htmlContent += `
                          <tr class="${rowClass}">
                              <td>${detail.location || ""}</td>
                              <td>${detail.risk || ""}</td>
                              <td>${detail.corraction || ""}</td>
                              <td>${detail.endDate}</td>
                              <td>${detail.status || ""}</td>
                              <td>${detail.wspcomment}</td>
                              
                          </tr>
                      `;
                  });
      
                  htmlContent += `</table>`;
              }
          }
      
          htmlContent += `</body></html>`;
      
          const printWindow = window.open('', '', 'width=1200,height=900');
          if (!printWindow) {
              alert("المتصفح منع نافذة الطباعة. برجاء السماح بالـ Pop-ups.");
              return;
          }
      
          printWindow.document.write(htmlContent);
          printWindow.document.close();
          setTimeout(() => {
              printWindow.focus();
              printWindow.print();
          }, 300);
      });

  
     </script>
  </body>

</html>





















































