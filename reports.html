<!DOCTYPE html>
<html>
  <head>
    <title>Reports</title>
    <link rel="stylesheet" href="report.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

   
  </head>
  <body>
      <div class="topbar">
           <button class="logout-button" onclick="logout()">Logout</button>
           <div class="userinfo"> 
                <label>Section</label>
                <input id="section" disabled>
            </div>
          
            <img src="wsp.22cd4e849308ae80b006.png" class="logo">
      </div>
      
      <h1 style="text-align:center;">Reports</h1>
      
      <!-- قسم الإجراءات التصحيحية -->
      <h2>Corrective Actions Reports</h2>
      <div class="grid">
          <div class="card" onclick="openModal('modal1')"> 
              <div class="icon">
                  <img src="execution status.png" alt="executionstatus">
              </div> 
              Execution Status
          </div>
          <div class="card" onclick="openModal('modal2')"> 
              <div class="icon">
                  <img src="Auditors.jpg" alt="wspaudition">
              </div> 
              WSP Audition
          </div>
          <div class="card" onclick="openModal('modal3')"> 
              <div class="icon">
                  <img src="deadline time.png" alt="deadlinetimeaction">
              </div> 
              Deadline Time Action
          </div>
           <div class="card" onclick="openModal('modal4')"> 
              <div class="icon">
                  <img src="PI.png" alt="performanceindex">
              </div> 
              Performance Index
          </div>
      </div>
      
      <!-- قسم جودة المياه -->
      <h2>Raw Water Quality Monitoring</h2>
      <div class="grid" >
          <div class="card" onclick="openModal('modal8')" hidden> <div class="icon"></div> </div>
          
      </div>
      
      <!-- مودالات 11 تقرير -->
      <div id="modal1" class="modal">
          <div class="modal-content">
              <span class="close" onclick="closeModal('modal1')">&times;</span>
              <h3 class="modal-title">Execution Status Reports</h3>
              <form onsubmit="return false;">
                  <div class="generalinfo">
                      <label>Branch</label>
                      <select id="branch_modal1">
                          <option selected disabled>Select Branch</option>
                          <option>العدوه</option>
                          <option>مغاغة</option>
                          <option>بنى مزار</option>
                          <option>مطاى</option>
                          <option>سمالوط</option>
                          <option>المنيا</option>
                          <option>ابوقرقاص</option>
                          <option>ملوى</option>
                          <option>ديرمواس</option>
                      </select>
      
                      <label>Station</label>
                      <select id="station_modal1"><option selected disabled>Select Station</option></select>
      
                      <label>Certified Date</label>
                      <input type="date" id="certifieddate" readonly>

                      <label hidden>Location</label>
                      <input id="location" hidden>
                  </div>
                  <div class="form-buttons">
                      <button type="button" id="reportstation">Report Station</button>
                      <button type="button" id="reportbranch">Report Branch</button>
                      <button type="button" id="reportall">Report All</button>
                      
                      
                  </div>
              </form>
          </div>
      </div>
      
      <div id="modal2" class="modal">
          <div class="modal-content">
              <span class="close" onclick="closeModal('modal2')">&times;</span>
              <h3 class="modal-title">WSP Auditions</h3>
              <form onsubmit="return false;">
                  <div class="generalinfo">
                      <label>Branch</label>
                      <select id="branch_modal2">
                          <option selected disabled>Select Branch</option>
                          <option>العدوه</option><option>مغاغة</option><option>بنى مزار</option>
                          <option>مطاى</option><option>سمالوط</option><option>المنيا</option>
                          <option>ابوقرقاص</option><option>ملوى</option><option>ديرمواس</option>
                      </select>
      
                      <label>Station</label>
                      <select id="station_modal2"><option selected disabled>Select Station</option></select>
                  </div>
                  <div class="form-buttons">
                      <button type="button" id="reportwspcomments">Report WSP</button>
                  </div>
              </form>
          </div>
      </div>
      
      <div id="modal3" class="modal">
          <div class="modal-content">
              <span class="close" onclick="closeModal('modal3')">&times;</span>
              <h3 class="modal-title">Deadline Time Action</h3>
              <form onsubmit="return false;">
                  <div class="generalinfo">
                      <label>Branch</label>
                      <select id="branch_modal3">
                          <option selected disabled>Select Branch</option>
                          <option>العدوه</option><option>مغاغة</option><option>بنى مزار</option>
                          <option>مطاى</option><option>سمالوط</option><option>المنيا</option>
                          <option>ابوقرقاص</option><option>ملوى</option><option>ديرمواس</option>
                      </select>
      
                      <label hidden>Station</label>
                      <select id="station_modal3" hidden><option selected disabled>Select Station</option></select>
                  </div>
                  <div class="form-buttons">
                      <button type="button" id="reportdeadlinebranch">Report Deadline</button>
                  </div>
              </form>
          </div>
      </div>
      <div id="modal4" class="modal">
        <div class="modal-content dashboard">
          <span class="close" onclick="closeModal('modal4')">&times;</span>
          <h3 class="modal-title">Performance Dashboard</h3>
      
          <div class="dashboard-grid">
            <canvas id="histogramChart"></canvas>
            <canvas id="pieChart"></canvas>
            <canvas id="radarChart"></canvas>
            <canvas id="radarDegreeChart"></canvas>
            <canvas id="lineChart"></canvas>
          </div>
        </div>
      </div>



      
     <script>
            const scriptURL = "https://script.google.com/macros/s/AKfycbylyqdVtMQvaa2zOJH7m-1Y-UPBg5uX-w4nXY8lYZVVf2P42LbDTK3kJqSRbpfOwPbS4A/exec";
  
            window.onload = () => {
              // الحصول على البيانات من الجلسة
              const email = sessionStorage.getItem("email");
              const department = sessionStorage.getItem("department");
          
              // تحديد عناصر DOM
              const branchSelect1 = document.getElementById("branch_modal1");
              const stationSelect1 = document.getElementById("station_modal1");
              const branchSelect2 = document.getElementById("branch_modal2");
              const stationSelect2 = document.getElementById("station_modal2");
              const branchSelect3 = document.getElementById("branch_modal3");
              const stationSelect3 = document.getElementById("station_modal3");
              const certifiedDateInput = document.getElementById("certifieddate");
              const locationSelect = document.getElementById("location");
          
              // تعيين القسم في الواجهة
              document.getElementById("section").value = department || "";
          
              // إضافة مستمع التغيير للفرع
              branchSelect1.addEventListener("change", () => {
                console.log("Branch changed:", branchSelect1.value);
                fetchStations(branchSelect1.value, stationSelect1);
              });
              // إضافة مستمع التغيير للفرع الثاني
              branchSelect2.addEventListener("change", () => {
                  console.log("Branch 2 changed:", branchSelect2.value);
                  fetchStations(branchSelect2.value, stationSelect2); // تم تمرير stationSelect2
              });
               // إضافة مستمع التغيير للفرع الثاني
              branchSelect3.addEventListener("change", () => {
                  console.log("Branch 3 changed:", branchSelect3.value);
                  fetchStations(branchSelect3.value, stationSelect3); // تم تمرير stationSelect2
              });
          
              let branchStations1 = [];
              let branchDates1 = [];
              let branchStations2 = [];
              let branchDates2 = [];
              let branchStations3 = [];
              let branchDates3 = [];

          
              // جلب المحطات بناءً على الفرع
              function fetchStations(branch, stationSelect) {
                  if (!branch) {
                      console.log("Branch is not provided or invalid.");
                      return;
                  }
                  console.log("Fetching stations for branch:", branch);
                  stationSelect.innerHTML = '<option value="" disabled selected>Loading Stations..</option>';
          
                  const url = scriptURL + "?action=getStations&branch=" + encodeURIComponent(branch);
          
                  fetch(url)
                      .then(res => res.json())
                      .then(data => {
                          console.log("datastation:", data);
                          if (data.status === "success") {
                              stationSelect.innerHTML = '<option value="" disabled selected>Select Station</option>';
                              if (stationSelect === stationSelect1) {
                                  branchStations1 = data.stations;
                                  branchDates1 = data.certifiedDates;
                              } else if (stationSelect === stationSelect2) {
                                  branchStations2 = data.stations;
                                  branchDates2 = data.certifiedDates;
                              } else if (stationSelect === stationSelect3) {
                                  branchStations3 = data.stations;
                                  branchDates3 = data.certifiedDates;
                              }
          
                              data.stations.forEach(station => {
                                  const option = document.createElement("option");
                                  option.value = station;
                                  option.textContent = station;
                                  stationSelect.appendChild(option);
                              });
                          } else {
                              stationSelect.innerHTML = '<option value="" disabled selected>Not found</option>';
                          }
                      })
                      .catch(err => {
                          console.error("Error fetching stations:", err);
                          stationSelect.innerHTML = '<option value="" disabled selected>Connection Error</option>';
                      });
              }
          
              // ملء تفاصيل الموقع
              window.fillStationDetails = function(details) {
                  locationSelect.innerHTML = '<option value="" disabled selected>Select Location</option>';
                  locationSelect.detailsMap = {};
                  details.forEach((detail, index) => {
                      const option = document.createElement("option");
                      option.value = index;  // أرسل نص الموقع
                      option.textContent = detail.location || "Unnamed Location";
                      locationSelect.appendChild(option);
                      locationSelect.detailsMap[index] = detail;
                  });
              };
              
              // استماع لتغيير الموقع
              locationSelect.addEventListener("change", () => {
                  const selectedKey = locationSelect.value;
                  if (!selectedKey) return;
              
                  const detail = locationSelect.detailsMap[selectedKey];
              
                  if (detail) {
                      riskInput.value = detail.risk || "";
                      corractionInput.value = detail.corraction || "";
                      durationInput.value = detail.duration || "";
              
                      let status = (detail.status || "").trim();
                      switch (true) {
                          case /^تم$/.test(status): status = "تم"; break;
                          case /^جارى$/.test(status): status = "جارى"; break;
                          case /^لم يتم$/.test(status): status = "لم يتم"; break;
                          default: status = "";
                      }
                      statusSelect.value = status;
                      branchcomment.value = detail.branchcomment || "";
                      wspcomment.value = detail.wspcomment || "";
              
                      if (detail.attachment) {
                          document.getElementById("filename").innerHTML = `<a href="${detail.attachment}" target="_blank">Show File</a>`;
                      } else {
                          document.getElementById("filename").textContent = "No File";
                      }
                  }
              });
              
              // عند تغيير المحطة في الفرع الأول
              stationSelect1.addEventListener("change", () => {
                  const selectedStation = stationSelect1.value;
                  const index = branchStations1.indexOf(selectedStation);
                  if (index !== -1 && branchDates1[index]) {
                      const date = new Date(branchDates1[index]);
                      const year = date.getFullYear();
                      const month = String(date.getMonth() + 1).padStart(2, '0');
                      const day = String(date.getDate()).padStart(2, '0');
                      certifiedDateInput.value = `${year}-${month}-${day}`;
                  } else certifiedDateInput.value = "";
              
                  fetch(scriptURL + "?action=getStationDetails&station=" + encodeURIComponent(selectedStation))
                      .then(res => res.json())
                      .then(data => {
                          if (data.status === "success" && data.details.length > 0) {
                              fillStationDetails(data.details);
                          } else {
                              locationSelect.innerHTML = '<option value="" disabled selected>No locations</option>';
                              riskInput.value = corractionInput.value = durationInput.value = statusSelect.value = "";
                              branchcomment.value = wspcomment.value = "";
                              document.getElementById("filename").textContent = "";
                          }
                      })
                      .catch(err => console.error("Error fetching station details:", err));
              });
              
              // عند تغيير المحطة في الفرع الثاني
              stationSelect2.addEventListener("change", () => {
                  const selectedStation = stationSelect2.value;
                  const index = branchStations2.indexOf(selectedStation);
                  if (index !== -1 && branchDates2[index]) {
                      const date = new Date(branchDates2[index]);
                      const year = date.getFullYear();
                      const month = String(date.getMonth() + 1).padStart(2, '0');
                      const day = String(date.getDate()).padStart(2, '0');
                      certifiedDateInput.value = `${year}-${month}-${day}`;
                  } else certifiedDateInput.value = "";
              
                  fetch(scriptURL + "?action=getStationDetails&station=" + encodeURIComponent(selectedStation))
                      .then(res => res.json())
                      .then(data => {
                          if (data.status === "success" && data.details.length > 0) {
                              fillStationDetails(data.details);
                          } else {
                              locationSelect.innerHTML = '<option value="" disabled selected>No locations</option>';
                              riskInput.value = corractionInput.value = durationInput.value = statusSelect.value = "";
                              branchcomment.value = wspcomment.value = "";
                              document.getElementById("filename").textContent = "";
                          }
                      })
                      .catch(err => console.error("Error fetching station details:", err));
              });
              
              // عند تغيير المحطة في الفرع الثالث
              stationSelect3.addEventListener("change", () => {
                  const selectedStation = stationSelect3.value;
                  const index = branchStations3.indexOf(selectedStation);
                  if (index !== -1 && branchDates3[index]) {
                      const date = new Date(branchDates3[index]);
                      const year = date.getFullYear();
                      const month = String(date.getMonth() + 1).padStart(2, '0');
                      const day = String(date.getDate()).padStart(2, '0');
                      certifiedDateInput.value = `${year}-${month}-${day}`;
                  } else certifiedDateInput.value = "";
              
                  fetch(scriptURL + "?action=getStationDetails&station=" + encodeURIComponent(selectedStation))
                      .then(res => res.json())
                      .then(data => {
                          if (data.status === "success" && data.details.length > 0) {
                              fillStationDetails(data.details);
                          } else {
                              locationSelect.innerHTML = '<option value="" disabled selected>No locations</option>';
                              riskInput.value = corractionInput.value = durationInput.value = statusSelect.value = "";
                              branchcomment.value = wspcomment.value = "";
                              document.getElementById("filename").textContent = "";
                          }
                      })
                      .catch(err => console.error("Error fetching station details:", err));
              });
            };

          
            // دالة لفتح المودال
            function openModal(id) {
              // أغلق كل المودالات أولاً
              document.querySelectorAll('.modal').forEach(m => {m.style.display = "none";});
                     // افتح المودال
              modal.style.display = "block";
              
            }
          
            // دالة لإغلاق المودال
            function closeModal(id) {
              document.getElementById(id).style.display = "none";
            }
          
            // إغلاق المودال عند الضغط خارج المودال
            window.onclick = function(event) {
              document.querySelectorAll('.modal').forEach(m => {
                if (event.target === m) m.style.display = "none";
              });
            }
          // تقرير الإجراءات التصحيحية لمحطة واحدة
          document.getElementById("reportstation").addEventListener("click", () => {
            const branch1 = document.getElementById("branch_modal1").value || "----";
            const station1 = document.getElementById("station_modal1").value || "----";
            const certifiedDate = document.getElementById("certifieddate").value || "----";
          
            const locationSelect = document.getElementById("location");
            const detailsMap = locationSelect.detailsMap;
          
            if (!detailsMap || Object.keys(detailsMap).length === 0) {
              alert("No Data for Print!");
              return;
            }
           
          
            const allLocations = Object.values(detailsMap) || [];
          
            const doneActionsCount = allLocations.filter(item => item.status?.trim() === "تم").length;
            const inProgressActionsCount = allLocations.filter(item => item.status?.trim() === "جارى").length;
            const notDoneActionsCount = allLocations.filter(item => item.status?.trim() === "لم يتم").length;
            const totalActionsCount = allLocations.length;
            
            // تحويل كل statuspercent من نص إلى رقم ثم حساب المتوسط
            const averageStatusPercentValue = allLocations.length === 0 ? 0 : (
              allLocations.reduce((sum, item) => sum + (Number(item.statuspercent) || 0), 0) / allLocations.length
            ).toFixed(0);
            
            console.log("متوسط نسبة التنفيذ:", averageStatusPercentValue);

          
            if (allLocations.length === 0) {
              alert("لا توجد بيانات للطباعة!");
              return;
            }
          
            let rowsHtml = allLocations.map(detail => {
              // تغيير لون الصف حسب حالة التنفيذ
              let rowColor = "";
              if (detail.status?.trim() === "جارى") rowColor = "background-color:#fff3cd;"; // أصفر فاتح
              else if (detail.status?.trim() === "لم يتم") rowColor = "background-color:#f8d7da;"; // أحمر فاتح
          
              return `
                <tr style="${rowColor}">
                  <td>${detail.location || ""}</td>
                  <td>${detail.risk || ""}</td>
                  <td>${detail.corraction || ""}</td>
                  <td>${detail.duration || ""}</td>
                  <td>${detail.status || ""}</td>
                </tr>
              `;
            }).join("");
          
            const htmlContent = `
              <html>
              <head>
                  <title>تقرير الاعتماد</title>
                  <style>
                      body {font-family: Arial, sans-serif; direction: rtl; text-align: right; margin: 20px;}
                      h2 {text-align: center;margin-bottom: 10px;}
                      p {text-align: center; margin-bottom: 20px; font-size: 16px;}
                      table {
                          width: 100%;
                          border-collapse: collapse;
                          margin-bottom: 30px;
                      }
                      th, td {
                          border: 1px solid #000;
                          padding: 8px;
                          text-align: center;
                          word-wrap: break-word;
                      }
                      th {
                          background-color: #f0f0f0;
                          color: black;
                          font-weight: bold;
                      }
                      tr:nth-child(even) td {
                          background-color: #f9f9f9;
                      }
                      .logo-container {
                          text-align: right;
                          margin-bottom: 20px;
                          display: flex;
                          justify-content: flex-start;
                          gap: 10px;
                      }
                      .logo-container img {
                          width: 80px;
                          margin-top: 5px;
                      }
                  </style>
              </head>
              <body>
                  <div class="logo-container">
                      <img src="menia logo.png" alt="logo">
                      <img src="wsp.22cd4e849308ae80b006.png" alt="logo">
                  </div>
                  <h2>تقرير الموقف من تنفيذ الاجراءات التصحيحية</h2>
                  <p>
                      <strong>الفرع:</strong> ${branch1} &nbsp;&nbsp;
                      <strong>النظام:</strong> ${station1} &nbsp;&nbsp;
                      <strong>تاريخ الاعتماد:</strong> ${certifiedDate}
                  </p>
          
                  <div>
                      <h3>ملخص الموقف التنفيذى للإجراءات التصحيحية</h3>
                      <table>
                          <thead>
                              <tr>
                                  <th>عدد الإجراءات التصحيحية</th>
                                  <th>عدد الإجراءات المنفذة</th>
                                  <th>عدد الإجراءات الجارية</th>
                                  <th>عدد الإجراءات لم يتم التنفيذ</th>
                                  <th>نسبة التنفيذ</th>
                              </tr>
                          </thead>
                          <tbody>
                              <tr>
                                  <td>${totalActionsCount}</td>
                                  <td>${doneActionsCount}</td>
                                  <td>${inProgressActionsCount}</td>
                                  <td>${notDoneActionsCount}</td>
                                  <td>${averageStatusPercentValue}%</td>
                              </tr>
                          </tbody>
                      </table>
                  </div>
          
                  <table>
                      <thead>
                          <tr>
                              <th>الموقع</th>
                              <th>الخطر</th>
                              <th>الإجراء التصحيحي</th>
                              <th>مدة التنفيذ</th>
                              <th>حالة التنفيذ</th>
                          </tr>
                      </thead>
                      <tbody>${rowsHtml}</tbody>
                  </table>
              </body>
              </html>
            `;
          
            const printWindow = window.open("", "_blank");
            printWindow.document.write(htmlContent);
            printWindow.document.close();
            printWindow.print();
          });


        /////////////////////////////// كل المحطات الفرع الواحد المختار
        document.getElementById("reportbranch").addEventListener("click", async () => {
            const branch1 = document.getElementById("branch_modal1").value || "----";
        
            // جلب جميع المحطات للفرع من السيرفر
            const stationsResponse = await fetch(`${scriptURL}?action=getStations&branch=${encodeURIComponent(branch1)}`);
            const stationsData = await stationsResponse.json();
            const certifiedDates = stationsData.certifiedDates;
        
            if (stationsData.status !== "success" || !stationsData.stations || stationsData.stations.length === 0) {
                alert("لا توجد محطات لهذا الفرع للطباعة!");
                return;
            }
        
            let htmlContent = `
                <html>
                <head>
                    <title>تقرير الاعتماد لكل المحطات</title>
                    <style>
                        body { font-family: Arial, sans-serif; direction: rtl; text-align: right; }
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                        th, td { border: 1px solid #000; padding: 5px; word-wrap: break-word; }
                        th { background-color: #f0f0f0; }
                        h2, h3 { text-align: center; }
                         .logo-container {
                          text-align: center;
                          margin-bottom: 20px;
                          margin-left:100%;
                          display: flex;
                          gap: 5px;
                      }
                  
                      .logo-container img {
                          width: 60px; /* ← يمكنك تغيير الحجم */
                      }
                    </style>
                </head>
                <body>
                   <div class="logo-container">
                      <img src="menia logo.png" alt="logo">
                      <img src="wsp.22cd4e849308ae80b006.png" alt="logo">
                    </div>
                    <h2>تقرير الموقف من تنفيذ الاجراءات التصحيحية لكل محطات فرع: ${branch1}</h2>
            `;
        
            // --------- جدول الملخص لجميع المحطات ---------
            htmlContent += `
                <h3>ملخص جميع المحطات</h3>
                <table>
                    <tr>
                        <th>المحطة</th>
                        <th>إجمالي الإجراءات</th>
                        <th>المنفذ</th>
                        <th>الجارية</th>
                        <th>لم يتم التنفيذ</th>
                        <th>نسبة التنفيذ</th>
                    </tr>
            `;
        
            const allDetailsPerStation = {}; // لتخزين التفاصيل لكل محطة
        
            // تعديل هنا: استخدام Promise.all لتحميل تفاصيل المحطات بشكل متوازي
            // تم تعديل هذه الكود لجعل تحميل التفاصيل للمحطات يتم بشكل متوازي بدلاً من التتابع
            const stationPromises = stationsData.stations.map(async (station1, index) => {
                const detailsResponse = await fetch(`${scriptURL}?action=getStationDetails&station=${encodeURIComponent(station1)}`);
                const detailsData = await detailsResponse.json();
            // شرط: المحطة لازم يكون لها تاريخ اعتماد
                const certifiedDate = certifiedDates[index];
                
                if (!certifiedDate || certifiedDate.trim() === "") {
                    return null; // تجاهل المحطة تمامًا
                }
        
                let totalActions = 0, doneActions = 0, inProgressActions = 0, notDoneActions = 0, doneActionsPercent = 0;
        
                if (detailsData.status === "success" && detailsData.details && detailsData.details.length > 0) {
                    const allLocations = detailsData.details;
                    totalActions = allLocations.length;
                    doneActions = allLocations.filter(item => item.status?.trim() === "تم").length;
                    inProgressActions = allLocations.filter(item => item.status?.trim() === "جارى").length;
                    notDoneActions = allLocations.filter(item => item.status?.trim() === "لم يتم").length;
                    doneActionsPercent = allLocations.length === 0 ? 0 : (allLocations.reduce((sum, item) => sum + (Number(item.statuspercent) || 0), 0) / allLocations.length
                    ).toFixed(0);
        
                    // تخزين التفاصيل لكل محطة لاستخدامها لاحقًا في الجدول التفصيلي
                    allDetailsPerStation[station1] = allLocations;
                }
        
                return { station1, totalActions, doneActions, inProgressActions, notDoneActions, doneActionsPercent };
            });
        
            // تعديل هنا: استخدام Promise.all لانتظار جميع الوعود (promises) المتعلقة بالمحطات
            const stationSummary = (await Promise.all(stationPromises)).filter(item => item !== null);
            if (stationSummary.length === 0) {
              alert("لاتوجد محطة معتمدة")
            }

        
            // إضافة بيانات المحطات في جدول الملخص
            stationSummary.forEach(({ station1, totalActions, doneActions, inProgressActions, notDoneActions, doneActionsPercent}) => {
                htmlContent += `
                    <tr>
                        <td>${station1}</td>
                        <td>${totalActions}</td>
                        <td>${doneActions}</td>
                        <td>${inProgressActions}</td>
                        <td>${notDoneActions}</td>
                        <td>${doneActionsPercent}%</td>
                    </tr>
                `;
            });
        
            htmlContent += `</table>`;
        
            // --------- الجداول التفصيلية لكل محطة ---------
            // إضافة التفاصيل لكل محطة باستخدام البيانات المخزنة في allDetailsPerStation
            for (const station1 of Object.keys(allDetailsPerStation)) {
                const allLocations = allDetailsPerStation[station1];
                const detailRowsHtml = allLocations.map(detail => `
                    <tr>
                        <td>${detail.location || ""}</td>
                        <td>${detail.risk || ""}</td>
                        <td>${detail.corraction || ""}</td>
                        <td>${detail.duration || ""}</td>
                        <td>${detail.status || ""}</td>
                    </tr>
                `).join("");
        
                htmlContent += `
                    <h4>تفاصيل الإجراءات لكل موقع في محطة: ${station1}</h4>
                    <table>
                        <thead>
                            <tr>
                                <th>الموقع</th>
                                <th>الخطر</th>
                                <th>الإجراء التصحيحي</th>
                                <th>المدة الزمنية</th>
                                <th>الموقف التنفيذي</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${detailRowsHtml}
                        </tbody>
                    </table>
                `;
            }
        
            htmlContent += `</body></html>`;
        
            // فتح نافذة الطباعة
            const printWindow = window.open('', '', 'height=800,width=1000');
            if (!printWindow) {
                alert("تعذر فتح نافذة الطباعة. يرجى السماح بالبوب‌آب في المتصفح.");
                return;
            }
        
            printWindow.document.write(htmlContent);
            printWindow.document.close();
            printWindow.focus();
            printWindow.print();
        });

       //////////////////////تقرير مجمع للفروع كلها
            
            document.getElementById("reportall").addEventListener("click", async () => {
              const branchSelect = document.getElementById("branch_modal1");
              const branchOptions = Array.from(branchSelect.options)
                           .filter(opt => opt.value && opt.value.trim() !== "" && opt.value !== "----" && opt.value !== "Select Branch"); // تجاهل placeholder
          
              if (branchOptions.length === 0) {
                  alert("لا توجد فروع للطباعة!");
                  return;
              }
          
              let htmlContent = `
                  <html>
                  <head>
                      <title>تقرير الموقف من تنفيذ الإجراءات التصحيحية لكل الفروع</title>
                      <style>
                          body { font-family: Arial, sans-serif; direction: rtl; text-align: right; }
                          table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                          th, td { border: 1px solid #000; padding: 5px; word-wrap: break-word; }
                          th { background-color: #f0f0f0; }
                          h2, h3 { text-align: center; }
                           .logo-container {
                            text-align: center;
                            margin-bottom: 20px;
                            margin-left:100%;
                            display: flex;
                            gap: 5px;
                        }
          
                        .logo-container img {
                            width: 60px; /* ← يمكنك تغيير الحجم */
                        }
                      </style>
                  </head>
                  <body>
                      <div class="logo-container">
                          <img src="menia logo.png" alt="logo">
                          <img src="wsp.22cd4e849308ae80b006.png" alt="logo">
                      </div>
                      <h2>تقرير الموقف من تنفيذ الاجراءات التصحيحية لجميع فروع الشركة</h2>
                      <h3>ملخص لكل الفروع</h3>
                      <table>
                          <tr>
                              <th>الفرع</th>
                              <th>إجمالي الإجراءات</th>
                              <th>المنفذ</th>
                              <th>الجارية</th>
                              <th>لم يتم التنفيذ</th>
                              <th>نسبة التنفيذ</th>
                          </tr>
              `;
          
              const allDetailsPerBranch = {}; // لتخزين التفاصيل لكل فرع
          
              // تعديل هنا: استخدام Promise.all لتحميل المحطات بشكل متوازي (Parallel Fetching)
              // تم تعديل الكود لاستخدام Promise.all لتحميل بيانات المحطات وتفاصيل المحطات بشكل متوازي
              const branchPromises = branchOptions.map(async (opt) => {
                  const branch1 = opt.value.trim();
                  if (!branch1 || branch1 === "----") return; // تجاهل placeholder
                 
          
                  // جلب المحطات لكل فرع
                  const stationsResponse = await fetch(`${scriptURL}?action=getStations&branch=${encodeURIComponent(branch1)}`);
                  const stationsData = await stationsResponse.json();
                  
          
                  let branchTotal = 0, branchDone = 0, branchInProgress = 0, branchNotDone = 0, branchDonePercent = 0;
                  allDetailsPerBranch[branch1] = {};
          
                  if (stationsData.status === "success" && stationsData.stations?.length) {
                      // استخدام Promise.all لتحميل تفاصيل المحطات بشكل متوازي
                      const stationPromises = stationsData.stations.map(async (station1) => {
                          const detailsResponse = await fetch(`${scriptURL}?action=getStationDetails&station=${encodeURIComponent(station1)}`);
                          const detailsData = await detailsResponse.json();
                          
          
                          let totalActions = 0, doneActions = 0, inProgressActions = 0, notDoneActions = 0, doneActionsPercent = 0;
          
                          if (detailsData.status === "success" && detailsData.details?.length) {
                              const allLocations = detailsData.details;
          
                              totalActions = allLocations.length;
                              doneActions = allLocations.filter(item => item.status?.trim() === "تم").length;
                              inProgressActions = allLocations.filter(item => item.status?.trim() === "جارى").length;
                              notDoneActions = allLocations.filter(item => item.status?.trim() === "لم يتم").length;
                              doneActionsPercent = allLocations.length === 0 ? 0 : (allLocations.reduce((sum, item) => sum + (Number(item.statuspercent) || 0), 0) / allLocations.length).toFixed(0);
          
                              allDetailsPerBranch[branch1][station1] = allLocations;
                          }
          
                          return { station1, totalActions, doneActions, inProgressActions, notDoneActions, doneActionsPercent };
                      });
          
                      // استخدام Promise.all لتحميل تفاصيل كل المحطات بشكل متوازي
                      const stationSummary = (await Promise.all(stationPromises)).filter(item => item !== null);;
          
                      // إضافة بيانات المحطات في جدول الملخص
                      stationSummary.forEach(({ station1, totalActions, doneActions, inProgressActions, notDoneActions, doneActionsPercent }) => {
                          branchTotal += totalActions;
                          branchDone += doneActions;
                          branchInProgress += inProgressActions;
                          branchNotDone += notDoneActions;
                          branchDonePercent += Number(doneActionsPercent);
                      });
                  }
          
                  return { branch1, branchTotal, branchDone, branchInProgress, branchNotDone, branchDonePercent };
              });
          
              // الانتظار حتى يتم تحميل جميع الفروع والمحطات بالتوازي
              const branchSummary = (await Promise.all(branchPromises)).filter(item => item !== null);
          
              // إضافة بيانات الفروع في جدول الملخص
              branchSummary.forEach(({ branch1, branchTotal, branchDone, branchInProgress, branchNotDone, branchDonePercent }) => {
                  htmlContent += `
                      <tr>
                          <td>${branch1}</td>
                          <td>${branchTotal}</td>
                          <td>${branchDone}</td>
                          <td>${branchInProgress}</td>
                          <td>${branchNotDone}</td>
                          <td>${branchDonePercent}%</td>
                      </tr>
                  `;
              });
          
              htmlContent += `</table>`;
          
              // --------- جدول لكل فرع (ملخص لكل محطة) ---------
              for (const branchSummaryItem of branchSummary) {
                const branch1 = branchSummaryItem.branch1;
                if (!allDetailsPerBranch[branch1]) continue; // لو ما فيش محطات لهذا الفرع

                  htmlContent += `<h3>ملخص محطات الفرع: ${branch1}</h3>`;
                  htmlContent += `
                      <table>
                          <tr>
                              <th>المحطة</th>
                              <th>إجمالي الإجراءات</th>
                              <th>المنفذ</th>
                              <th>الجارية</th>
                              <th>لم يتم التنفيذ</th>
                              <th>نسبة التنفيذ</th>
                          </tr>
                  `;
          
                  const stations = Object.keys(allDetailsPerBranch[branch1]);
                  for (const station1 of stations) {
                      const allLocations = allDetailsPerBranch[branch1][station1];
          
                      const totalActions = allLocations.length;
                      const doneActions = allLocations.filter(item => item.status?.trim() === "تم").length;
                      const inProgressActions = allLocations.filter(item => item.status?.trim() === "جارى").length;
                      const notDoneActions = allLocations.filter(item => item.status?.trim() === "لم يتم").length;
                      const doneActionsPercent =  allLocations.length === 0 ? 0 : (allLocations.reduce((sum, item) => sum + (Number(item.statuspercent) || 0), 0) / allLocations.length
                    ).toFixed(0);
          
                      htmlContent += `
                          <tr>
                              <td>${station1}</td>
                              <td>${totalActions}</td>
                              <td>${doneActions}</td>
                              <td>${inProgressActions}</td>
                              <td>${notDoneActions}</td>
                              <td>${doneActionsPercent}%</td>
                          </tr>
                      `;
                  }
          
                  htmlContent += `</table>`;
              }
          
              const printWindow = window.open('', '', 'height=800,width=1200');
              if (!printWindow) {
                  alert("تعذر فتح نافذة الطباعة. يرجى السماح بالبوب‌آب في المتصفح.");
                  return;
              }
          
              printWindow.document.write(htmlContent);
              printWindow.document.close();
              printWindow.focus();
              printWindow.print();
          });
          /////////////////////////
          // تحميل بيانات لوحة الأداء لمودال 4
          /////////////////////////
          async function loadDashboardData() {
              const histogramCtx = document.getElementById("histogramChart").getContext("2d");
              const pieCtx = document.getElementById("pieChart").getContext("2d");
              const radarCtx = document.getElementById("radarChart").getContext("2d");
              const radarDegreeCtx = document.getElementById("radarDegreeChart").getContext("2d");
              const lineCtx = document.getElementById("lineChart").getContext("2d");
          
              // أوزان درجات الخطورة
              const riskWeights = {
                      "خطورة منخفضة": 0.25,
                      "خطورة متوسطة": 0.5,
                      "خطورة عالية": 0.75,
                      "خطورة عالية جداً": 1
              };          
              // قائمة الفروع
              const branchSelect = document.getElementById("branch_modal1");
              const branches = Array.from(branchSelect.options)
                                    .filter(opt => opt.value && opt.value.trim() !== "" && opt.value !== "Select Branch")
                                    .map(opt => opt.value.trim());
          
              const branchData = {}; // لتخزين بيانات كل فرع
          
              // جلب بيانات كل فرع
              const fetchPromises = branches.map(async branch => {
                  const res = await fetch(`${scriptURL}?action=getStations&branch=${encodeURIComponent(branch)}`);
                  const data = await res.json();
                  branchData[branch] = {
                      stations: data.stations || [],
                      certifiedDates: data.certifiedDates || [],
                      details: {} // لتخزين تفاصيل كل محطة
                  };
          
                  // جلب تفاصيل كل محطة
                  const detailPromises = (data.stations || []).map(async station => {
                      const stationRes = await fetch(`${scriptURL}?action=getStationDetails&station=${encodeURIComponent(station)}`);
                      const stationData = await stationRes.json();
                      branchData[branch].details[station] = stationData.details || [];
                  });
          
                  await Promise.all(detailPromises);
              });
          
              await Promise.all(fetchPromises);
              // بعد جمع كل بيانات الفروع والمحطات في branchData
              const branchSummary = branches.map(branch => {
                  const stations = branchData[branch].stations;
                  let branchDonePercent = 0;
                  let stationsWithActionsCount = 0;
              
                  stations.forEach(station => {
                      const details = branchData[branch].details[station] || [];
                      if (details.length > 0) {
                          const donePercent = details.reduce((sum, item) => sum + (Number(item.statuspercent) || 0), 0) / details.length;
                          branchDonePercent += donePercent;
                          stationsWithActionsCount++;
                      }
                  });
              
                  const averageDonePercent = stationsWithActionsCount === 0 ? 0 : Math.round(branchDonePercent / stationsWithActionsCount);
              
                  return {
                      branch1: branch,
                      averageDonePercent
                  };
             
              });
                   

          
              // ----------- Histogram Chart: عدد المحطات التي لها تاريخ اعتماد لكل فرع ----------
              // الترتيب المخصص الذي تريده
              
              const histogramLabels = branches;  // أو array من الفروع
              const histogramCounts = histogramLabels.map(branch => {
                const dates = branchData[branch].certifiedDates;
                // نفلتر التواريخ الفارغة (null, "", undefined)
                const countCertified = dates.filter(date => date && date.toString().trim() !== "").length;
                return countCertified;
              });


             new Chart(histogramCtx, {
                type: "bar",
                data: {
                  labels: histogramLabels,
                  datasets: [{
                    label: "عدد المحطات المعتمدة",
                    data: histogramCounts,
                    backgroundColor: "rgba(54, 162, 235, 1.6)"
                  }]
                },
                options: {
                  responsive: true,
                  plugins: {
                    legend: {
                      display: false,
                      labels: {
                        font: {
                          size: 14  // حجم خط التسمية في الأسطورة لو ظهرت
                        }
                      }
                    }
                  },
                  scales: {
                    x: {  // محور السينات (التسميات)
                      ticks: {
                        font: {
                          size: 20  // حجم خط محور X
                        }
                      },
                      title: {
                        display: true,
                        text: '',
                        font: {
                          size: 20,
                          weight: 'bold'
                        }
                      }
                    },
                     y: { 
                          beginAtZero: true,
                          ticks: { 
                            font: { size: 16 },
                            stepSize: 1, // ← هنا نضمن أن كل خطوة عدد صحيح
                            callback: function(value) { return Number(value); } // عرض الأعداد بدون كسور
                          },
                          title: { display: true, text: 'عدد المحطات المعتمدة', font: { size: 18, weight: 'bold' } }
                        }
                      }
                    }
                  });

          
              // ----------- Pie Chart: نسبة تنفيذ الإجراءات التصحيحية ----------
              
              const pieLabels = branchSummary.map(branch => branch.branch1); // ترتيب الفروع
              const pieData = branchSummary.map(branch => branch.averageDonePercent); // المتوسط لكل فرع
              
              const pieColors = [
                  "#4dc9f6","#f67019","#f53794","#537bc4","#acc236",
                  "#166a8f","#00a950","#58595b","#8549ba"
              ];
              
              new Chart(pieCtx, {
                  type: "doughnut",
                  data: {
                      labels: pieLabels,
                      datasets: [{
                          label: "نسبة التنفيذ %",
                          data: pieData,
                          backgroundColor: pieColors
                      }]
                  },
                  options: {
                      responsive: true,
                      plugins: {
                          legend: { display: true, position: 'right' },
                          tooltip: {
                              callbacks: {
                                  label: function(context) {
                                      return context.label + ": " + context.raw + "%";
                                  }
                              }
                          }
                      }
                  }
              });



              // ----------- Radar Chart: الإجراءات التصحيحية حسب درجة الخطورة ----------

              
              // افترض أن branchData موجود ويحتوي على كل التفاصيل لكل فرع
              // branchData = { "فرع 1": { details: { "محطة A": [ {riskdegree, statuspercent}, ...] }, ... } }
                const piority = {}; //تخزين قيمة piority لكل فرع لاستخدامه فى KPI
                const radarLabels = Object.keys(branchData); // أسماء الفروع
                const radarValues = radarLabels.map(branch => {
                    let executedWeightedSum_branch = 0;
                    let totalWeightedSum_branch = 0;
                    let executedActionsCount_branch = 0;
                    let totalActions_branch = 0;
                
                    Object.entries(branchData[branch].details).forEach(([station, stationActions]) => {
                        let executedWeightedSum_station = 0;
                        let executedActionsCount_station = 0;
                        let totalWeightedSum_station = 0;
                        let totalActions_station = 0;
                
                        stationActions.forEach(action => {
                            const weight = riskWeights[action.riskdegree] || 0;
                            const percent = Number(action.statuspercent) || 0;
                
                            totalWeightedSum_station += weight;
                            totalActions_station++;
                
                            if (percent === 100) {
                                executedWeightedSum_station += weight;
                                executedActionsCount_station++;
                            }
                        });
                
                        console.log(
                            "Branch:", branch,
                            "| Station:", station,
                            "| executedWeightedSum:", executedWeightedSum_station,
                            "| executedActionsCount:", executedActionsCount_station,
                            "| totalWeightedSum:", totalWeightedSum_station,
                            "| totalActions:", totalActions_station
                        );
                
                        // جمع القيم لكل فرع
                        executedWeightedSum_branch += executedWeightedSum_station;
                        totalWeightedSum_branch += totalWeightedSum_station;
                        executedActionsCount_branch += executedActionsCount_station;
                        totalActions_branch += totalActions_station;
                    });
                
                    const radarScore_branch =
                        totalWeightedSum_branch === 0
                            ? 0
                            : ((executedWeightedSum_branch * executedActionsCount_branch) / (totalActions_branch * totalWeightedSum_branch)) * 100;
                    piority[branch] = parseFloat(radarScore_branch.toFixed(2));
                    
                    console.log("Radar % for branch", branch, ":", radarScore_branch.toFixed(2));
                    
                });

              
              // رسم المخطط الشبكي
              new Chart(document.getElementById("radarChart").getContext("2d"), {
                  type: "radar",
                  data: {
                      labels: radarLabels,
                      datasets: [{
                          label: "نسبة اولية التنفيذ%",
                          data: radarLabels.map(branch => piority[branch] || 0),
                          backgroundColor: "rgba(54,162,235,0.2)",
                          borderColor: "rgba(54,162,235,1)",
                          borderWidth: 2,
                          pointBackgroundColor: "rgba(54,162,235,1)"
                      }]
                  },
                  options: {
                      responsive: true,
                      scales: {
                          r: { beginAtZero: true,
                                       min: 0,    // ← أقل قيمة للمحور
                                       max: 100   // ← أعلى قيمة للمحور
                          }
                      },
                      plugins: {
                          legend: { display: true, position: "right" }
                      }
                  }
              });
               // ---------------- Radar حسب درجات الخطورة ----------------
              const riskCategories = ["خطورة منخفضة", "خطورة متوسطة", "خطورة عالية", "خطورة عالية جداً"];
              const radarDegreeBranches = branches;
              
              const riskColors = {
                "خطورة عالية جداً": "rgba(255, 0, 0, 0.6)",    // أحمر
                "خطورة عالية": "rgba(255, 140, 0, 0.6)",      // برتقالي
                "خطورة متوسطة": "rgba(255, 215, 0, 0.6)",     // أصفر
                "خطورة منخفضة": "rgba(0, 200, 0, 0.6)"        // أخضر
              };
              
              const radarDegreeData = riskCategories.map(risk => {
                return radarDegreeBranches.map(branch => {
                    let executedWeightedSum_branch = 0;
                    let totalWeightedSum_branch = 0;
              
                    Object.entries(branchData[branch].details).forEach(([station, stationActions]) => {
                        let executedWeightedSum_station = 0;
                        let totalWeightedSum_station = 0;
              
                        stationActions.forEach(action => {
                            if (action.riskdegree === risk) {
                                const weight = riskWeights[risk] || 0;
                                const percent = Number(action.statuspercent) || 0;
              
                                totalWeightedSum_station += weight;
                                executedWeightedSum_station += weight * (percent / 100);
                            }
                        });
              
                        console.log(
                            `Branch: ${branch} | Station: ${station} | Risk: ${risk} | executedWeightedSum: ${executedWeightedSum_station.toFixed(2)} | totalWeightedSum: ${totalWeightedSum_station.toFixed(2)}`
                        );
              
                        executedWeightedSum_branch += executedWeightedSum_station;
                        totalWeightedSum_branch += totalWeightedSum_station;
                    });
              
                    console.log(
                        `Branch TOTAL: ${branch} | Risk: ${risk} | executedWeightedSum: ${executedWeightedSum_branch.toFixed(2)} | totalWeightedSum: ${totalWeightedSum_branch.toFixed(2)}`
                    );
              
                    return totalWeightedSum_branch === 0 ? 0 : parseFloat(((executedWeightedSum_branch / totalWeightedSum_branch) * 100).toFixed(2));
                });
              });
              
              new Chart(radarDegreeCtx, {
                  type: "radar",
                  data: {
                      labels: radarDegreeBranches,
                      datasets: riskCategories.map(risk => ({
                          label: risk,
                          data: radarDegreeData[riskCategories.indexOf(risk)],
                          fill: true,
                          backgroundColor: riskColors[risk],
                          borderColor: riskColors[risk].replace("0.6", "1"),
                          pointBackgroundColor: riskColors[risk].replace("0.6", "1")
                      }))
                  },
                  options: {
                      responsive: true,
                      scales: { r: { min: 0, max: 100 } },
                      plugins: { legend: { position: "right" } }
                  }
              });
              /***********************
               * KPI Quarterly Calculation
               * Based on Device Date
               ***********************/
              
              // -------- تعريف الشهور مرة واحدة --------
              const KPI_MONTHS = ["يناير", "فبراير", "مارس", "ابريل"];
              
              // -------- حساب إجمالي المحطات المعتمدة --------
              const totalCertifiedStationsAllBranches = branches.reduce((sum, branch) => {
                const countCertified = branchData[branch].certifiedDates
                  .filter(d => d && d.toString().trim() !== "").length;
                return sum + countCertified;
              }, 0);
              
              // -------- حساب KPI لكل فرع --------
              const kpiPerBranch = branches.map(branch => {
              
                const P = piority[branch]; // P%
                const A = branchSummary.find(b => b.branch1 === branch).averageDonePercent; // A%
                const countCertified = branchData[branch].certifiedDates
                  .filter(d => d && d.toString().trim() !== "").length;
              
                console.log(
                  "Branch:", branch,
                  "| countCertified:", countCertified,
                  "| totalCertifiedStationsAllBranches:", totalCertifiedStationsAllBranches,
                  "| P%:", P.toFixed(2),
                  "| A%:", A.toFixed(2)
                );
              
                const kpiPerMonth = {};
              
                KPI_MONTHS.forEach(month => {
                  kpiPerMonth[month] =
                    ((P * 0.6) + (A * 0.4)) *
                    (countCertified / totalCertifiedStationsAllBranches);
                });
              
                return { branch, kpiPerMonth };
              });
              
              console.log("KPI per branch:", kpiPerBranch);
              
              // -------- تحديد الشهر الحالي --------
              const monthIndex = new Date().getMonth() % KPI_MONTHS.length;
              const currentMonthName = KPI_MONTHS[monthIndex];
              
              // -------- تجهيز بيانات الإرسال إلى Google Sheet --------
              const kpiSheetData = kpiPerBranch.map(item => {
                const row = { branch: item.branch };
              
                KPI_MONTHS.forEach(m => row[m] = 0);
              
                row[currentMonthName] = item.kpiPerMonth[currentMonthName] || 0;
              
                return row;
              });
              
              console.log("KPI per branch for current month:", kpiSheetData);
              
              // -------- حفظ البيانات --------
              const params = new URLSearchParams();
              params.append("action", "saveKPI");
              params.append("data", JSON.stringify(kpiSheetData));
              
              await fetch(scriptURL, { method: "POST", body: params });
              console.log("KPI per month calculated & saved");
              
            
             // -------- Line Chart KPI (Branches on X, Month as Line) --------
            const res = await fetch(`${scriptURL}?action=getKPI`);
            const sheetData = await res.json();
            
            const months = sheetData.header.slice(1); // ["يناير","فبراير","مارس","ابريل"]
            const rows = sheetData.rows;
            
            // محور X = الفروع
            const branchLabels = rows.map(row => row[0]);
            
            // ألوان ثابتة لكل شهر
            const monthColors = {
              "يناير": "rgba(75,192,192,1)",
              "فبراير": "rgba(153,102,255,1)",
              "مارس": "rgba(255,159,64,1)",
              "ابريل": "rgba(54,162,235,1)"
            };
            
            // كل خط = شهر
            const datasets = months.map((month, monthIndex) => ({
              label: month,
              data: rows.map(row => Number(row[monthIndex + 1]) || 0),
              borderColor: monthColors[month] || `hsl(${monthIndex * 60},70%,50%)`,
              backgroundColor: (monthColors[month] || `hsl(${monthIndex * 60},70%,50%)`).replace("1)", "0.2)"),
              tension: 0.3,
              fill: false
            }));
            
            new Chart(lineCtx, {
              type: "line",
              data: {
                labels: branchLabels, // الفروع
                datasets
              },
              options: {
                responsive: true,
                scales: {
                  y: { min: 0, max: 100 }
                },
                plugins: {
                  legend: {
                    display: true,
                    position: "top"
                  }
                }
              }
            });

          }
          
              
       



 
           
           
    
         
           
       //  تسجيل الخروج
        function logout() {
          sessionStorage.clear(); // مسح بيانات الجلسة
          alert("You have been logged out");
          window.location.href = "index.html"; // إعادة توجيه لصفحة تسجيل الدخول
        }
  /////////////////////////////////////////////////////////////////////////////////////////////
 /////////////////////////////////////////////////////////////////////////////////////////////       
        /////////////طباعة تقرير ملاحظات WSP  الاجراءات التصحيحية لمحطة واحدة
         document.getElementById("reportwspcomments").addEventListener("click", () => {
          const branch2 = document.getElementById("branch_modal2").value || "----";
          const station2 = document.getElementById("station_modal2").value || "----";
          const certifiedDate = document.getElementById("certifieddate").value || "----";
      
          const locationSelect = document.getElementById("location");
          const detailsMap = locationSelect.detailsMap;
      
          if (!detailsMap || Object.keys(detailsMap).length === 0) {
              alert("No Data for Print!");
              return;
          }
      
          const allLocations = Object.values(detailsMap) || [];
      
          const doneActionsCount = allLocations.filter(item => item.status?.trim() === "تم").length;
          const inProgressActionsCount = allLocations.filter(item => item.status?.trim() === "جارى").length;
          const notDoneActionsCount = allLocations.filter(item => item.status?.trim() === "لم يتم").length;
          const totalActionsCount = allLocations.length;
          const averageStatusPercentValue = allLocations.length === 0 ? 0 : (
              allLocations.reduce((sum, item) => sum + (Number(item.statuspercent) || 0), 0) / allLocations.length
            ).toFixed(0);
      
          if (allLocations.length === 0) {
              alert("لا توجد بيانات للطباعة!");
              return;
          }
      
          let rowsHtml = allLocations.map(detail => {
              // تغيير لون الصف حسب حالة التنفيذ
              let rowColor = "";
              if (detail.status?.trim() === "جارى") rowColor = "background-color:#fff3cd;"; // أصفر فاتح
              else if (detail.status?.trim() === "لم يتم") rowColor = "background-color:#f8d7da;"; // أحمر فاتح
      
              return `
              <tr style="${rowColor}">
                  <td>${detail.location || ""}</td>
                  <td>${detail.risk || ""}</td>
                  <td>${detail.corraction || ""}</td>
                  <td>${detail.duration || ""}</td>
                  <td>${detail.status || ""}</td>
                  <td>${detail.wspcomment || ""}</td>
              </tr>
              `;
          }).join("");
      
          const htmlContent = `
              <html>
              <head>
                  <title>تقرير مرور</title>
                  <style>
                      body {font-family: Arial, sans-serif; direction: rtl; text-align: right; margin: 20px;}
                      h2 {text-align: center;margin-bottom: 10px;}
                      p {text-align: center; margin-bottom: 20px; font-size: 16px;}
                      table {
                          width: 100%;
                          border-collapse: collapse;
                          margin-bottom: 30px;
                      }
                      th, td {
                          border: 1px solid #000;
                          padding: 8px;
                          text-align: center;
                          word-wrap: break-word;
                      }
                      th {
                          background-color: #f0f0f0;
                          color: black;
                          font-weight: bold;
                      }
                      tr:nth-child(even) td {
                          background-color: #f9f9f9;
                      }
                      .logo-container {
                          text-align: right; /* محاذاة الصور لليمين */
                          margin-bottom: 20px;
                          display: flex;
                          justify-content: flex-start; /* محاذاة الصور لليمين */
                          gap: 10px;
                      }
                      .logo-container img {
                          width: 80px; /* تغيير الحجم حسب الحاجة */
                          margin-top: 5px;
                      }
                      .summary-table th {
                          background-color: #dcdcdc;
                          font-weight: bold;
                      }
                      .summary-table td {
                          text-align: center;
                          padding: 10px;
                      }
                      .content-section {
                          margin-top: 20px;
                      }
                  </style>
              </head>
              <body>
                  <div class="logo-container">
                      <img src="menia logo.png" alt="logo">
                      <img src="wsp.22cd4e849308ae80b006.png" alt="logo">
                  </div>
                  <h2>تقرير الموقف من تنفيذ الاجراءات التصحيحية</h2>
                  <p>
                      <strong>الفرع:</strong> ${branch2} &nbsp;&nbsp;
                      <strong>النظام:</strong> ${station2} &nbsp;&nbsp;
                      <strong>تاريخ الاعتماد:</strong> ${certifiedDate}
                  </p>
      
                  <!-- جدول الإحصائيات -->
                  <div class="content-section">
                      <h3>ملخص الموقف التنفيذى للإجراءات التصحيحية</h3>
                      <table class="summary-table">
                          <thead>
                              <tr>
                                  <th>عدد الإجراءات التصحيحية</th>
                                  <th>عدد الإجراءات المنفذة</th>
                                  <th>عدد الإجراءات الجارية</th>
                                  <th>عدد الإجراءات لم يتم التنفيذ</th>
                                  <th>نسبة التنفيذ</th>
                              </tr>
                          </thead>
                          <tbody>
                              <tr>
                                  <td>${totalActionsCount}</td>
                                  <td>${doneActionsCount}</td>
                                  <td>${inProgressActionsCount}</td>
                                  <td>${notDoneActionsCount}</td>
                                  <td>${averageStatusPercentValue}%</td>
                              </tr>
                          </tbody>
                      </table>
                  </div>
      
                  <!-- جدول التفاصيل -->
                  <div class="content-section">
                      <h3>تفاصيل الإجراءات التصحيحية</h3>
                      <table>
                          <thead>
                              <tr>
                                  <th>الموقع</th>
                                  <th>الخطر</th>
                                  <th>الإجراء التصحيحي</th>
                                  <th>المدة الزمنية</th>
                                  <th>الموقف التنفيذي</th>
                                  <th>ملاحظات WSP</th>
                              </tr>
                          </thead>
                          <tbody>
                              ${rowsHtml}
                          </tbody>
                      </table>
                  </div>
              </body>
              </html>
          `;
      
          const printWindow = window.open('', '', 'height=700,width=900');
          printWindow.document.write(htmlContent);
          printWindow.document.close();
          printWindow.focus();
          printWindow.print();
      });
  /////////////////////////////////////////////////////////////////////////////////////////////
 /////////////////////////////////////////////////////////////////////////////////////////////
       // تقرير لمحطات الفرع عن الاجراءات التى قاربت مدة انتهائها
      // دالة مساعدة لتحليل التواريخ من صيغ مختلفة
      function parseDateSmart(dateStr) {
          if (/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) {
              const [y, m, d] = dateStr.split("-");
              return new Date(y, m - 1, d);
          }
          if (/^\d{2}\/\d{2}\/\d{4}$/.test(dateStr)) {
              const [d, m, y] = dateStr.split("/");
              return new Date(y, m - 1, d);
          }
          return new Date(dateStr);
      }
      
      // تقرير الإجراءات التي قاربت على الانتهاء للفرع المحدد
      document.getElementById("reportdeadlinebranch").addEventListener("click", async () => {
          const branchSelect = document.getElementById("branch_modal3");
          const selectedBranch = branchSelect.value;
      
          if (!selectedBranch || selectedBranch === "----") {
              alert("يرجى اختيار فرع!");
              return;
          }
      
          let htmlContent = `
          <html>
          <head>
              <title>تقرير الإجراءات شارفت على انتهاء مدتها</title>
              <style>
                  body { font-family: Arial; direction: rtl; text-align: right; }
                  table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                  th, td { border: 1px solid #000; padding: 6px; }
                  th { background-color: #f0f0f0; }
                  h2, h3 { text-align: center; }
                  .logo-container {
                          text-align: right; /* محاذاة الصور لليمين */
                          margin-bottom: 20px;
                          display: flex;
                          justify-content: flex-start; /* محاذاة الصور لليمين */
                          gap: 10px;
                      }
                      .logo-container img {
                          width: 80px; /* تغيير الحجم حسب الحاجة */
                          margin-top: 5px;
                      }
                  .red { background:#ff9999; color:black; }
                  .orange { background:lightsalmon; }
              </style>
          </head>
          <body>
              <div class="logo-container">
                 <img src="menia logo.png" alt="logo">
                 <img src="wsp.22cd4e849308ae80b006.png" alt="logo">
              </div>
              <h2>تقرير بالإجراءات شارفت على انتهاء مدتها والمنتهية</h2>
          `;
      
          const today = new Date();
          today.setHours(0,0,0,0);
      
          const branch3 = selectedBranch;
      
          // جلب المحطات الخاصة بالفرع
          const resStations = await fetch(`${scriptURL}?action=getStations&branch=${encodeURIComponent(branch3)}`);
          const stationsData = await resStations.json();
      
          htmlContent += `<h3>الفرع: ${branch3}</h3>`;
      
          if (stationsData.status !== "success") {
              htmlContent += `<p>لا توجد محطات لهذا الفرع.</p>`;
          } else {
              for (let i = 0; i < stationsData.stations.length; i++) {
                  const station = stationsData.stations[i];
                  const certDateRaw = stationsData.certifiedDates[i];
      
                  let certifiedDate = parseDateSmart(certDateRaw);
                  if (!certifiedDate || isNaN(certifiedDate)) continue;
      
                  const resDetails = await fetch(`${scriptURL}?action=getStationDetails&station=${encodeURIComponent(station)}`);
                  const detailsData = await resDetails.json();
                  if (detailsData.status !== "success") continue;
      
                  let filtered = [];
      
                  detailsData.details.forEach(detail => {
                      // تجاهل الصفوف التي فيها checkbox=true
                      if (detail.checkbox === true) return;
      
                      const durationMonths = parseInt(detail.duration);
                      if (isNaN(durationMonths)) return;
      
                      let endDate = new Date(certifiedDate);
                      endDate.setMonth(endDate.getMonth() + durationMonths);
                      endDate.setHours(0,0,0,0);
      
                      // حساب المتبقي بالشهور
                      let monthsLeft = (endDate.getFullYear() - today.getFullYear()) * 12 +
                                       (endDate.getMonth() - today.getMonth());
      
                      // المطلوب فقط (≤ 3)
                      if (monthsLeft <= 3) {
                          detail.monthsLeft = monthsLeft;
                          detail.endDate = endDate.toISOString().slice(0,10);
                          filtered.push(detail);
                      }
                  });
      
                  if (filtered.length === 0) continue;
      
                  htmlContent += `
                      <h4>المحطة: ${station}</h4>
                      <table>
                          <tr>
                              <th>الموقع</th>
                              <th>الخطر</th>
                              <th>الإجراء التصحيحي</th>
                              <th>تاريخ الانتهاء</th>
                              <th>الموقف</th>
                              <th>ملاحظات WSP</th>
                          </tr>
                  `;
      
                  filtered.forEach(detail => {
                      let rowClass = (detail.monthsLeft <= 0) ? "red" : "orange";
      
                      htmlContent += `
                          <tr class="${rowClass}">
                              <td>${detail.location || ""}</td>
                              <td>${detail.risk || ""}</td>
                              <td>${detail.corraction || ""}</td>
                              <td>${detail.endDate}</td>
                              <td>${detail.status || ""}</td>
                              <td>${detail.wspcomment}</td>
                              
                          </tr>
                      `;
                  });
      
                  htmlContent += `</table>`;
              }
          }
      
          htmlContent += `</body></html>`;
      
          const printWindow = window.open('', '', 'width=1200,height=900');
          if (!printWindow) {
              alert("المتصفح منع نافذة الطباعة. برجاء السماح بالـ Pop-ups.");
              return;
          }
      
          printWindow.document.write(htmlContent);
          printWindow.document.close();
          setTimeout(() => {
              printWindow.focus();
              printWindow.print();
          }, 300);
      });

  
     </script>
  </body>

</html>




















































































































































