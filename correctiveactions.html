<!DOCTYPE html>
<html>
<head>
  <title>Corrective Actions</title>
  <link rel="stylesheet" href="corr_action.css" />
  <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>

</head>
<body>
   <div class="topbar">

      <button class="logout-button" onclick="logout()">Logout</button>

       <div class="userinfo">
             
            <label>Section</label>
            <input id="section" disabled>
       </div>

      <img src="https://wssp.hcww.com.eg/public/static/media/wsp.22cd4e849308ae80b006.png" class="logo">
  </div>
    <div class="page-container">
    <form onsubmit="return false;">
        <h1>Corrective Actions</h1>
        <br><br>

        <div class="generalinfo">
        <div>
            <label class="infolabel">Branch</label>
            <select id="branch">
            <option value="" selected disabled>Select Branch</option>
            <option value="Ø§Ù„Ø¹Ø¯ÙˆÙ‡">Ø§Ù„Ø¹Ø¯ÙˆÙ‡</option>
            <option value="Ù…ØºØ§ØºØ©">Ù…ØºØ§ØºØ©</option>
            <option value="Ø¨Ù†Ù‰ Ù…Ø²Ø§Ø±">Ø¨Ù†Ù‰ Ù…Ø²Ø§Ø±</option>
            <option value="Ù…Ø·Ø§Ù‰">Ù…Ø·Ø§Ù‰</option>
            <option value="Ø³Ù…Ø§Ù„ÙˆØ·">Ø³Ù…Ø§Ù„ÙˆØ·</option>
            <option value="Ø§Ù„Ù…Ù†ÙŠØ§">Ø§Ù„Ù…Ù†ÙŠØ§</option>
            <option value="Ø§Ø¨ÙˆÙ‚Ø±Ù‚Ø§Øµ">Ø§Ø¨ÙˆÙ‚Ø±Ù‚Ø§Øµ</option>
            <option value="Ù…Ù„ÙˆÙ‰">Ù…Ù„ÙˆÙ‰</option>
            <option value="Ø¯ÙŠØ±Ù…ÙˆØ§Ø³">Ø¯ÙŠØ±Ù…ÙˆØ§Ø³</option>
            </select>
        </div>

        <div>
            <label class="infolabel">Station</label>
            <select id="station">
            <option value="" selected disabled>Select Station</option>
            </select>
        </div>

        <div>
            <label class="infolabel">Certified Date</label>
            <input type="date" id="certifieddate" readonly>
        </div>
        </div>

        <hr>
    
        <div class="location">
        <label>Location</label>
        <select id="location">
            <option value="">Select Location</option>
        </select>
        </div>

        <div class="risk">
        <label>Risk</label>
        <input value="" readonly id="risk"> 
        </div>

        <div class="action">
        <label>Corrective Action</label>
        <input value="" readonly id="corraction">
        </div>

        <div class="branchresponse">
        <div class="duration">
            <label>Duration (month)</label>
            <input value="" readonly id="duration">
        </div>

        <div>
            <label>Status</label>
            <select id="status">
            <option value="" selected disabled>Select Status</option>
            <option value="ØªÙ…">ØªÙ…</option>
            <option value="Ø¬Ø§Ø±Ù‰">Ø¬Ø§Ø±Ù‰</option>
            <option value="Ù„Ù… ÙŠØªÙ…">Ù„Ù… ÙŠØªÙ…</option>
            </select>
        </div>

        <div>
            <label>Attachment</label>
            <input type="file" id="attachment" name="attachment" accept="image/*,.pdf,.doc,.docx">
            <div id="filename">No File</div>
        </div>
        </div>

        <div class="branchremark">
        <label>Branch Comment</label>
        <textarea id="branchcomment" name="Remarks" maxlength="150"></textarea>
        </div>

        <div class="wspcomment">
        <label>WSP Comment</label>
        <textarea id="wspcomment" name="WSP Comments" maxlength="150"></textarea>
        </div>

        <hr>

        <div class="buttons">
        <button class="wspbutton" onclick='sendCommentsData(event,"updatestation")'>WSP Submit</button>
        <button class="branchbutton" onclick='sendCommentsData(event,"updatestation")'>Branch Submit</button>
        </div>
        <div>
        <button type="button" id="printReport">Report</button>
        </div>
    </form>
    </div>
 
  <script>
    
    const scriptURL = "https://script.google.com/macros/s/AKfycbx4AOEzJl7NtiWeIpn5XAMP7VKXabRsdm-NSOSNI00TPffliqF2iigwClPqvFpdqhnerA/exec";
    
  
    window.onload = () => {
      const email = sessionStorage.getItem("email");
      const department = sessionStorage.getItem("department");


  
     
      document.getElementById("section").value = department || "";

         
      const stationSelect = document.getElementById("station");
      const branchSelect = document.getElementById("branch");
      const certifiedDateInput = document.getElementById("certifieddate");
      const locationSelect = document.getElementById("location");
      const riskInput = document.getElementById("risk");
      const corractionInput = document.getElementById("corraction");
      const durationInput = document.getElementById("duration");
      const statusSelect = document.getElementById("status");
      const branchcomment = document.getElementById("branchcomment");
      const wspcomment = document.getElementById("wspcomment");
      const branchbuttons = document.querySelectorAll('.branchbutton');
      const wspbuttons = document.querySelectorAll('.wspbutton');

         // Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù„ÙØŒ Ø¹Ø±Ø¶ Ø§Ø³Ù…Ù‡
      const attachmentInput = document.getElementById("attachment");
      const filenameDiv = document.getElementById("filename");
    
      attachmentInput.addEventListener("change", function() {
        if (attachmentInput.files.length > 0) {
          filenameDiv.textContent = attachmentInput.files[0].name;
        } else {
          filenameDiv.textContent = "No File";
        }
      });
      ///ØªØºÙŠÙŠØ± Ù„ÙˆÙ† background Ù„Ù„ duration Ø­Ø³Ø¨ Ù‚Ø±Ø¨ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø§Ø¬Ø±Ø§Ø¡
      function updateDurationBackground() {
          const certifiedInput = document.getElementById("certifieddate");
          const durationInput = document.getElementById("duration");
      
          const certifiedDate = new Date(certifiedInput.value);
          const today = new Date();
      
          if (!certifiedDate || isNaN(certifiedDate)) return;
      
          // Ø§Ù„ÙØ±Ù‚ Ø¨Ø§Ù„Ø£ÙŠØ§Ù…
          const diffTime = certifiedDate - today;
          const diffDays = diffTime / (1000 * 60 * 60 * 24);
      
          // Ù…Ø«Ø§Ù„: ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù„ÙˆÙ† Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©
          if (diffDays > 60) {          // Ø£ÙƒØ«Ø± Ù…Ù† Ø´Ù‡Ø±ÙŠÙ†
              durationInput.style.backgroundColor = "#d4edda"; // Ø£Ø®Ø¶Ø± ÙØ§ØªØ­
          } else if (diffDays > 30) {   // Ø£Ù‚Ù„ Ù…Ù† Ø´Ù‡Ø±ÙŠÙ† ÙˆØ£ÙƒØ«Ø± Ù…Ù† Ø´Ù‡Ø±
              durationInput.style.backgroundColor = "#fff3cd"; // Ø£ØµÙØ± ÙØ§ØªØ­
          } else if (diffDays >= 0) {   // Ø£Ù‚Ù„ Ù…Ù† Ø´Ù‡Ø±
              durationInput.style.backgroundColor = "#f8d7da"; // Ø£Ø­Ù…Ø± ÙØ§ØªØ­
          } else {                       // Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ØªØ§Ø±ÙŠØ®
              durationInput.style.backgroundColor = "#f5c6cb"; // Ø£Ø­Ù…Ø± Ø¯Ø§ÙƒÙ†
          }
      }
      
      // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„Ø¯Ø§Ù„Ø© Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
       certifiedDateInput.addEventListener("change", updateDurationBackground);


  
      let branchStations = [];
      let branchDates = [];
  
        // Ù…Ù„Ø¡ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…ÙˆÙ‚Ø¹
      function fillStationDetails(details) {
        locationSelect.innerHTML = '<option value="" disabled selected>Select Location</option>';
        locationSelect.detailsMap = {};
        details.forEach((detail, index) => {
          const option = document.createElement("option");
          option.value = index;  // Ø£Ø±Ø³Ù„ Ù†Øµ Ø§Ù„Ù…ÙˆÙ‚Ø¹
          option.textContent = detail.location || "Unnamed Location";
          locationSelect.appendChild(option);
          locationSelect.detailsMap[index] = detail;
        });
      }

      locationSelect.addEventListener("change", () => {
        const selectedKey = locationSelect.value;
        if (!selectedKey) return;

        const detail = locationSelect.detailsMap[selectedKey];

        if (detail) {
          riskInput.value = detail.risk || "";
          corractionInput.value = detail.corraction || "";
          durationInput.value = detail.duration || "";

          let status = (detail.status || "").trim();
          switch (true) {
            case /ØªÙ…/.test(status): status = "ØªÙ…"; break;
            case /Ø¬Ø§Ø±/.test(status): status = "Ø¬Ø§Ø±Ù‰"; break;
            case /Ù„Ù…/.test(status): status = "Ù„Ù… ÙŠØªÙ…"; break;
            default: status = "";
          }
          statusSelect.value = status;
          branchcomment.value = detail.branchcomment || "";
          wspcomment.value = detail.wspcomment || "";

          if (detail.attachment) {
            document.getElementById("filename").innerHTML = `<a href="${detail.attachment}" target="_blank">Show File</a>`;
          } else {
            document.getElementById("filename").textContent = "No File";
          }
        }
      });

      // Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø­Ø·Ø§Øª Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„ÙØ±Ø¹
      function fetchStations(branch) {
        if (!branch) return;

        stationSelect.innerHTML = '<option value="" disabled selected>Loading Stations..</option>';

        const url = scriptURL + "?action=getStations&branch=" + encodeURIComponent(branch);

        fetch(url)
          .then(res => res.json())
          .then(data => {
            if (data.status === "success") {
              stationSelect.innerHTML = '<option value="" disabled selected>Select Station</option>';
              branchStations = data.stations;
              branchDates = data.certifiedDates;

              data.stations.forEach(station => {
                const option = document.createElement("option");
                option.value = station;
                option.textContent = station;
                stationSelect.appendChild(option);
              });
            } else {
              stationSelect.innerHTML = '<option value="" disabled selected>Not found</option>';
            }
          })
          .catch(err => {
            console.error("Error fetching stations:", err);
            stationSelect.innerHTML = '<option value="" disabled selected>Connection Error</option>';
          });
      }

      // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ÙØ±Ø¹ Ø­Ø³Ø¨ Ø§Ù„Ù‚Ø³Ù…
      if (department !== "WSP") {
        branchSelect.value = department;
        branchSelect.disabled = true;
        branchcomment.disabled = false;
        wspcomment.disabled = true;
        wspbuttons.forEach(btn => btn.disabled = true);
        fetchStations(department);
      } else {
        branchSelect.disabled = false;
        branchcomment.disabled = true;
        wspcomment.disabled = false;
        branchbuttons.forEach(btn => btn.disabled = true);
        branchSelect.addEventListener("change", () => fetchStations(branchSelect.value));
      }

      // Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ù…Ø­Ø·Ø©
      stationSelect.addEventListener("change", () => {
        const selectedStation = stationSelect.value;
        const index = branchStations.indexOf(selectedStation);
        if (index !== -1 && branchDates[index]) {
          const date = new Date(branchDates[index]);
          const year = date.getFullYear();
          const month = String(date.getMonth() + 1).padStart(2, '0');
          const day = String(date.getDate()).padStart(2, '0');
          certifiedDateInput.value = `${year}-${month}-${day}`;
        } else certifiedDateInput.value = "";

        fetch(scriptURL + "?action=getStationDetails&station=" + encodeURIComponent(selectedStation))
          .then(res => res.json())
          .then(data => {
           
            if (data.status === "success" && data.details.length > 0) fillStationDetails(data.details);
             
            else {
              locationSelect.innerHTML = '<option value="" disabled selected>No locations</option>';
              riskInput.value = corractionInput.value = durationInput.value = statusSelect.value = "";
              branchcomment.value = wspcomment.value = "";
              document.getElementById("filename").textContent = "";
            }
          })
          .catch(err => console.error("Error fetching station details:", err));
      });
    };

    //Ø¶ØºØ· Ø§Ù„ØµÙˆØ± ÙˆØ§Ù„Ù…Ø±ÙÙ‚Ø§Øª
    function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result.split(',')[1]); 
        reader.onerror = error => reject(error);
      });
    }

    async function compressImage(file, maxWidth = 1280, maxHeight = 1280, quality = 0.7) {
      return new Promise(resolve => {
        const img = new Image();
        const reader = new FileReader();
    
        reader.readAsDataURL(file);
        reader.onload = e => {
          img.src = e.target.result;
          img.onload = () => {
            let canvas = document.createElement('canvas');
            let ctx = canvas.getContext("2d");
    
            let width = img.width;
            let height = img.height;
    
            if (width > maxWidth) {
              height = Math.floor(height * (maxWidth / width));
              width = maxWidth;
            }
            if (height > maxHeight) {
              width = Math.floor(width * (maxHeight / height));
              height = maxHeight;
            }
    
            canvas.width = width;
            canvas.height = height;
    
            ctx.drawImage(img, 0, 0, width, height);
    
            canvas.toBlob(
              blob => {
                resolve(new File([blob], file.name, { type: file.type }));
              },
              file.type,
              quality
            );
          };
        };
      });
    }

    


 
    async function sendCommentsData(event, action) {
        event = event || window.event; // Ø¶Ù…Ø§Ù† ÙˆØ¬ÙˆØ¯ event
        const email = sessionStorage.getItem("email");
        const department = sessionStorage.getItem("department"); 
        const locationSelect = document.getElementById("location");
        const riskInput = document.getElementById("risk");
        const corractionInput = document.getElementById("corraction");
        const durationInput = document.getElementById("duration");
        const statusSelect = document.getElementById("status");
        const branchcomment = document.getElementById("branchcomment");
        const wspcomment = document.getElementById("wspcomment");
        const attachmentInput = document.getElementById("attachment");

            // ğŸ”¹ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ Ø§Ù„Ø°ÙŠ ÙŠØ±Ø³Ù„ (Ø­Ø³Ø¨ Ø§Ù„Ø²Ø±)
        let currentDepartment = department;
        if (event.target.classList.contains("branchbutton")) {
          currentDepartment =  document.getElementById("branch").value;  // â† Ø§Ø³Ù… Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ;
        } else if (event.target.classList.contains("wspbutton")) {
          currentDepartment = "wsp";
        }
        const confirmUpdate = confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆÙ‚Ù Ø§Ù„ØªÙ†ÙÙŠØ°ÙŠ ÙˆØ§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª ÙˆØ§Ù„Ù…Ø±ÙÙ‚ØŸ");
        if (!confirmUpdate) return;
      
        
        const selectedKey = locationSelect.value; // Ù‡Ø°Ø§ index
        if (!selectedKey) {
          alert("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©!");
          return;
        }
    
        const detail = locationSelect.detailsMap[selectedKey];
        if (!detail || !detail.location) {
          alert("âš ï¸ Ø§Ù„Ù…ÙˆÙ‚Ø¹ ØºÙŠØ± ØµØ­ÙŠØ­");
          return;
        }
    
        // ğŸ“ Ù†Øµ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ
        const locationText = detail.location;
    
        if (action === "update" && 
            (!locationText ||
             !riskInput.value ||
             !corractionInput.value ||
             !durationInput.value)) {
          alert("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± ØµÙ Ø£Ùˆ ØªØ¹Ø¨Ø¦Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ù‚Ø¨Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«.");
          return;
        }
      

      
        

                      
        const formData = new URLSearchParams();
        formData.append("action", "updatestation");  // ğŸ†• Ù…Ù‡Ù… Ø¬Ø¯Ù‹Ø§
        formData.append("station", document.getElementById("station").value);
        formData.append("email", email);
        formData.append("department", currentDepartment);
        formData.append("location", locationText); // âœ… Ù‡Ù†Ø§ Ù†Øµ Ø§Ù„Ù…ÙˆÙ‚Ø¹
        formData.append("risk", document.getElementById("risk").value);
        formData.append("corraction", document.getElementById("corraction").value);
        formData.append("duration", document.getElementById("duration").value);
        formData.append("status", document.getElementById("status").value);
        // ğŸ”¹ Ù‡Ù†Ø§ Ù†Ø±Ø³Ù„ Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„ÙØ¹Ù„ÙŠ ÙˆÙ„ÙŠØ³ Ù‚ÙŠÙ…Ø© input
        
        formData.append("branchcomment", document.getElementById("branchcomment").value);
        formData.append("wspcomment", document.getElementById("wspcomment").value);
       
        // ğŸ”¹ Ø¥Ø¶Ø§ÙØ© Ø­Ù‚Ù„ Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ù…Ù† Ø¬Ù‡Ø© Ø§Ù„Ø³ÙŠØ±ÙØ±
        formData.append("sendEmail", "true"); // Apps Script Ø³ÙŠØ³ØªØ®Ø¯Ù…Ù‡ Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯
        // â­ Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª
        let base64File = "";
        let fileName = "";
        
       
        
        if (attachmentInput.files.length > 0) {
            let file = attachmentInput.files[0];
            fileName = file.name;
        
            // ğŸ“Œ Ø¶ØºØ· Ø§Ù„ØµÙˆØ±Ø© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Image
            if (file.type.startsWith("image/")) {
                file = await compressImage(file);
            }
        
            // ğŸ“Œ ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø¥Ù„Ù‰ Base64
            base64File = await fileToBase64(file);
        }
        
        // â­ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ formData
        formData.append("fileBase64", base64File);
        formData.append("fileName", fileName);

        console.log("ğŸ“¤ Form Data sent to server:", formData.toString());
      
        fetch(scriptURL, {
          method: "POST",
          mode: "cors",
          headers: {
            "Content-Type": "application/x-www-form-urlencoded"
          },
          body: formData.toString()
        })
          .then(response => {
            console.log("ğŸ” Raw response object:", response);
            console.log("Raw response:", response);

      
            // âœ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ù‚Ø¨Ù„ ØªØ­ÙˆÙŠÙ„Ù‡Ø§ Ø¥Ù„Ù‰ JSON
            if (!response.ok) {
              console.error("âŒ Network or server error:", response.status, response.statusText);
              throw new Error(`HTTP Error: ${response.status}`);
            }
      
            // âœ… ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø¥Ù„Ù‰ JSON
            return response.json();
          })
          .then(result => { 
            console.log("âœ… Response JSON from server:", result);
            console.log("Result from server:", result);

      
            if (result.status === "unauthorized") {
              alert("ØºÙŠØ± Ù…ØµØ±Ø­ Ù„Ùƒ Ø¨Ø§Ù„ÙˆØµÙˆÙ„.");
              return;
            }
      
            if (result.result === "Updated") {
              alert("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­ âœ…");
              // ğŸ”„ ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ù…Ø¨Ø§Ø´Ø±Ø©
              const currentStation = document.getElementById("station").value;
              
              fetch(scriptURL + "?action=getStationDetails&station=" + encodeURIComponent(currentStation))
                  .then(res => res.json())
                  .then(data => {
                      if (data.status === "success") {
                          fillStationDetails(data.details);
              
                          // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ø®ØªÙŠØ§Ø± Ù†ÙØ³ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¥Ø°Ø§ Ø±ØºØ¨Øª
                          if (locationText) {
                              const keys = Object.keys(locationSelect.detailsMap);
                              const foundKey = keys.find(k => locationSelect.detailsMap[k].location === locationText);
                              if (foundKey) locationSelect.value = foundKey;
                          }
                      }
                  })
                  .catch(err => console.error("Error refreshing locations:", err));

              
               // ğŸ”¹ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø²Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù‡Ùˆ WSPØŒ Ù†Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„Ø§Ø¬Ø±Ø§Ø¡
              if (event.target.classList.contains("wspbutton")) {
                  const approve = confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„Ø§Ø¬Ø±Ø§Ø¡ØŸ");
  
                  if (approve) {
                      // ğŸ”¹ Ø¥Ø±Ø³Ø§Ù„ ØªØ­Ø¯ÙŠØ« Ù„ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù€ Checkbox Ø£Ùˆ Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ ÙÙŠ Google Sheet
                      const formDataApproval = new URLSearchParams();
                      formDataApproval.append("action", "approveAction"); // ÙŠØ¬Ø¨ Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ù‡Ø°Ø§ ÙÙŠ Apps Script
                      formDataApproval.append("station", document.getElementById("station").value);
                      formDataApproval.append("location", locationText);
                      formDataApproval.append("email", email);
                      formDataApproval.append("checkbox", "true"); // âœ… Ø¥Ø¶Ø§ÙØ©
  
                      fetch(scriptURL, {
                          method: "POST",
                          headers: { "Content-Type": "application/x-www-form-urlencoded" },
                          body: formDataApproval.toString()
                      })
                      .then(res => res.json())
                      .then(res => {
                          if (res.result === "Approved") {
                              alert("ØªÙ… Ø§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„Ø§Ø¬Ø±Ø§Ø¡ Ø¨Ù†Ø¬Ø§Ø­ âœ…");
                            ///ØªØ­Ø¯ÙŠØ« lpcation Ø¨Ø¹Ø¯ Ø§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„Ø§Ø¬Ø±Ø§Ø¡
                              fetch(scriptURL + "?action=getStationDetails&station=" + encodeURIComponent(currentStation))
                                .then(res => res.json())
                                .then(data => {
                                    if (data.status === "success") fillStationDetails(data.details);
                                });

                          } else {
                              alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„Ø§Ø¬Ø±Ø§Ø¡.");
                          }
                      })
                      .catch(err => {  
                          console.error("Approval error:", err);
                      });
                    } // â† Ø¥ØºÙ„Ø§Ù‚ if (approve)
                  } // â† Ø¥ØºÙ„Ø§Ù‚ if WSP
              } else if (result.result === "Location not found") {
                  alert("âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø­Ø¯Ø¯ ÙÙŠ Ø§Ù„Ø´ÙŠØª.");
              } else {
                  console.warn("âš ï¸ Unexpected result object:", result);
                  alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠØ«.");
              }
      
              clearForm();
              fetchData(email, department);
          })
          .catch(error => {
              console.error("ğŸ’¥ Exception caught:", error);
              alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªÙ†ÙÙŠØ° Ø§Ù„Ø¹Ù…Ù„ÙŠØ©. Ø±Ø§Ø¬Ø¹ Ø§Ù„Ù€ Console Ù„Ù…Ø¹Ø±ÙØ© Ø§Ù„ØªÙØ§ØµÙŠÙ„.");
          });
      }


      function clearForm() {
        document.getElementById("location").value = "";
        document.getElementById("risk").value = "";
        document.getElementById("corraction").value = "";
        document.getElementById("duration").value = "";
        document.getElementById("status").value = "";
        document.getElementById("attachment").value = "";
        document.getElementById("branchcomment").value = "";
        document.getElementById("wspcomment").value = "";
        document.getElementById("filename").textContent = "";
      }
      function fetchData(email, department) {
        fetch(`${scriptURL}?action=getStationDetails&email=${encodeURIComponent(email)}&department=${encodeURIComponent(department)}`)
          .then(response => response.json())
          .then(data => {
            console.log("âœ… Response JSON from server:", data);  // Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªÙŠØ¬Ø© ÙƒØ§Ù…Ù„Ø© Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±
            if (data.status === "unauthorized") {
              alert("ØºÙŠØ± Ù…ØµØ±Ø­ Ù„Ùƒ Ø¨Ø§Ù„ÙˆØµÙˆÙ„");
              return;
            }
            // Ù‡Ù†Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
          }) // ØªÙ… Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù€ then Ù‡Ù†Ø§
          .catch(error => {
            console.error("Ø®Ø·Ø£:", error);
            alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.");
          });
      }
      // Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø§Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„ØªØµØ­ÙŠØ­Ø© 
      document.getElementById("printReport").addEventListener("click", () => {
      const branch = document.getElementById("branch").value || "----";
      const station = document.getElementById("station").value || "----";
      const certifiedDate = document.getElementById("certifieddate").value || "----";
  
      const locationSelect = document.getElementById("location");
      const detailsMap = locationSelect.detailsMap;
  
      if (!detailsMap || Object.keys(detailsMap).length === 0) {
          alert("No Data for Print!");
          return;
      }
  
      // Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹ (Ø¨Ø¯ÙˆÙ† ÙÙ„ØªØ±Ø©)
      const allLocations = Object.values(detailsMap) || [];
  
      // Ø¥Ø°Ø§ Ù„Ù… ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª
      if (allLocations.length === 0) {
          alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©!");
          return;
      }
  
      let rowsHtml = allLocations.map(detail => `
          <tr>
              <td>${detail.location || ""}</td>
              <td>${detail.risk || ""}</td>
              <td>${detail.corraction || ""}</td>
              <td>${detail.duration || ""}</td>
              <td>${detail.status || ""}</td>
              <td>${detail.notes || ""}</td>
          </tr>
      `).join("");
  
      const htmlContent = `
          <html>
          <head>
              <title>ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯</title>
              <style>
                  body { font-family: Arial, sans-serif; direction: rtl; text-align: right; }
                  table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                  th, td { border: 1px solid #000; padding: 5px; word-wrap: break-word; }
                  th { background-color: #f0f0f0; }
                  h2 { text-align: center; }
                  p { text-align: center; }
                  th:nth-child(1), td:nth-child(1) { width: 10%; }
                  th:nth-child(2), td:nth-child(2) { width: 15%; }
                  th:nth-child(3), td:nth-child(3) { width: 25%; }
                  th:nth-child(4), td:nth-child(4) { width: 10%; }
                  th:nth-child(5), td:nth-child(5) { width: 10%; }
                  th:nth-child(6), td:nth-child(6) { width: 25%; }
              </style>
          </head>
          <body>
              <h2>ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…ÙˆÙ‚Ù Ù…Ù† ØªÙ†ÙÙŠØ° Ø§Ù„Ø§Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„ØªØµØ­ÙŠØ­ÙŠØ©</h2>
              <p><strong>Ø§Ù„ÙØ±Ø¹:</strong> ${branch} &nbsp;&nbsp;<strong>Ø§Ù„Ù†Ø¸Ø§Ù…:</strong> ${station} &nbsp;&nbsp;<strong>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯:</strong> ${certifiedDate}</p>
  
              <table>
                  <thead>
                      <tr>
                          <th>Ø§Ù„Ù…ÙˆÙ‚Ø¹</th>
                          <th>Ø§Ù„Ø®Ø·Ø±</th>
                          <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„ØªØµØ­ÙŠØ­ÙŠ</th>
                          <th>Ø§Ù„Ù…Ø¯Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©</th>
                          <th>Ø§Ù„Ù…ÙˆÙ‚Ù Ø§Ù„ØªÙ†ÙÙŠØ°ÙŠ</th>
                          <th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
                      </tr>
                  </thead>
                  <tbody>
                      ${rowsHtml}
                  </tbody>
              </table>
          </body>
          </html>
      `;
  
      const printWindow = window.open('', '', 'height=600,width=800');
      printWindow.document.write(htmlContent);
      printWindow.document.close();
      printWindow.focus();
      printWindow.print();
  });


  </script>

  

</body>
</html>





