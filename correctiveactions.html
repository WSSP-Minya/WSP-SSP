<!DOCTYPE html>
<html>
<head>
  <title>Corrective Actions</title>
  <link rel="stylesheet" href="corr_action.css" />
  <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>

</head>
<body>
   <div class="topbar">
            <div class="left">
                <button class="logout-button" onclick="logout()">Logout</button>
                <button class="homepage-button" onclick="AccessedToPage('mainpage')">
                    <img src="myhome.webp" alt="Main Page" title="Main Page">
                </button>
                <button class="addstation-button" id="addstation-button">
                    <img src="https://cdn-icons-png.freepik.com/512/10302/10302325.png" title="Add Certified Station">

                </button>
            </div>
        
            <div class="right">
                <div class="userinfo">
                    <label>Section</label>
                    <input id="section" disabled>
                </div>
                <img src="https://wssp.hcww.com.eg/public/static/media/wsp.22cd4e849308ae80b006.png" class="logo">
            </div>
    </div>
    <div class="page-container">
    <form onsubmit="return false;">
        <h1>Corrective Actions</h1>
         <div class="container">
          
          <button type="button" id="printReport">
            <img src="checklist_report.webp" alt="Checklist report" title = "Checklist Report">
          </button>
          <button type="button" onclick="openCorrectiveModal()" id="addcorrectiveactions-button">
            <img src="Risk management.png" alt="Add Corrective Actions" title = "Add Corrective Actions">
          </button>
            <button type="button" id="printCommentsReport">print comments Report
            
          </button>

            
        </div>
       

        <div class="generalinfo">
        <div>
            <label class="infolabel">Branch</label>
            <select id="branch">
            <option value="" selected disabled>Select Branch</option>
            <option value="Ø§Ù„Ø¹Ø¯ÙˆÙ‡">Ø§Ù„Ø¹Ø¯ÙˆÙ‡</option>
            <option value="Ù…ØºØ§ØºØ©">Ù…ØºØ§ØºØ©</option>
            <option value="Ø¨Ù†Ù‰ Ù…Ø²Ø§Ø±">Ø¨Ù†Ù‰ Ù…Ø²Ø§Ø±</option>
            <option value="Ù…Ø·Ø§Ù‰">Ù…Ø·Ø§Ù‰</option>
            <option value="Ø³Ù…Ø§Ù„ÙˆØ·">Ø³Ù…Ø§Ù„ÙˆØ·</option>
            <option value="Ø§Ù„Ù…Ù†ÙŠØ§">Ø§Ù„Ù…Ù†ÙŠØ§</option>
            <option value="Ø§Ø¨ÙˆÙ‚Ø±Ù‚Ø§Øµ">Ø§Ø¨ÙˆÙ‚Ø±Ù‚Ø§Øµ</option>
            <option value="Ù…Ù„ÙˆÙ‰">Ù…Ù„ÙˆÙ‰</option>
            <option value="Ø¯ÙŠØ±Ù…ÙˆØ§Ø³">Ø¯ÙŠØ±Ù…ÙˆØ§Ø³</option>
            </select>
        </div>

        <div>
            <label class="infolabel">Station</label>
            <select id="station">
            <option value="" selected disabled>Select Station</option>
            </select>
        </div>

        <div>
            <label class="infolabel">Certified Date</label>
            <input type="date" id="certifieddate" readonly>
        </div>
        </div>

        <hr>
    
        <div class="location">
        <label>Location</label>
        <select id="location">
            <option value="">Select Location</option>
        </select>
        </div>

        <div class="risk">
        <label>Risk</label>
        <input value="" readonly id="risk"> 
        </div>

        <div class="action">
        <label>Corrective Action</label>
        <input value="" readonly id="corraction">
        </div>

        <div class="branchresponse">
        <div class="duration">
            <label>Duration (month)</label>
            <input value="" readonly id="duration">
        </div>

        <div>
            <label>Status</label>
            <select id="status">
            <option value="" selected disabled>Select Status</option>
            <option value="ØªÙ…">ØªÙ…</option>
            <option value="Ø¬Ø§Ø±Ù‰">Ø¬Ø§Ø±Ù‰</option>
            <option value="Ù„Ù… ÙŠØªÙ…">Ù„Ù… ÙŠØªÙ…</option>
            </select>
        </div>

        <div>
            <label>Attachment</label>
            <input type="file" id="attachment" name="attachment" accept="image/*,.pdf,.doc,.docx">
            <div id="filename">No File</div>
        </div>
        </div>

        <div class="branchremark">
        <label>Branch Comment</label>
        <textarea id="branchcomment" name="Remarks" maxlength="800"></textarea>
        </div>

        <div class="wspcomment">
        <label>WSP Comment</label>
        <textarea id="wspcomment" name="WSP Comments" maxlength="800"></textarea>
        </div>

        <hr>

        <div class="buttons">
        <button class="wspbutton" onclick='sendCommentsData(event,"updatestation")'>WSP Submit</button>
        <button class="branchbutton" onclick='sendCommentsData(event,"updatestation")'>Branch Submit</button>
        </div>
        
    </form>
    </div>
    <!--Ø§Ø¶Ø§ÙØ© Ù…Ø­Ø·Ø© Ù…Ø¹ØªÙ…Ø¯Ø©-->
    <div id="stationModal" class="modal">
    <div class="modal-content">
      <h3>Certified Station Addition</h3>
  
      <label>Branch</label>
      <select id="branchmodalselect">
            <option value="" selected disabled>Select Branch</option>
            <option value="Ø§Ù„Ø¹Ø¯ÙˆÙ‡">Ø§Ù„Ø¹Ø¯ÙˆÙ‡</option>
            <option value="Ù…ØºØ§ØºØ©">Ù…ØºØ§ØºØ©</option>
            <option value="Ø¨Ù†Ù‰ Ù…Ø²Ø§Ø±">Ø¨Ù†Ù‰ Ù…Ø²Ø§Ø±</option>
            <option value="Ù…Ø·Ø§Ù‰">Ù…Ø·Ø§Ù‰</option>
            <option value="Ø³Ù…Ø§Ù„ÙˆØ·">Ø³Ù…Ø§Ù„ÙˆØ·</option>
            <option value="Ø§Ù„Ù…Ù†ÙŠØ§">Ø§Ù„Ù…Ù†ÙŠØ§</option>
            <option value="Ø§Ø¨ÙˆÙ‚Ø±Ù‚Ø§Øµ">Ø§Ø¨ÙˆÙ‚Ø±Ù‚Ø§Øµ</option>
            <option value="Ù…Ù„ÙˆÙ‰">Ù…Ù„ÙˆÙ‰</option>
            <option value="Ø¯ÙŠØ±Ù…ÙˆØ§Ø³">Ø¯ÙŠØ±Ù…ÙˆØ§Ø³</option>
       </select>
        
      <label>Station</label>
      <select id="stationmodalselect">
        <option value="" selected disabled>Select Station</option>   
      </select>

      <input type="text" id="newstationmodal" placeholder="Enter new station name">
  
      <label>Certified Date</label>
      <input type="date" id="certifieddatemodal">
  
      <div style="margin-top:10px">
        <button onclick="submitStation()">Submit</button>
        <button onclick="closeModal()">Cancel</button>
      </div>
    </div>
  </div>
  <!--Ø§Ø¶Ø§ÙØ© Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù…Ø­Ø·Ø© Ù…Ø¹ØªÙ…Ø¯Ø©-->
<div id="stationModal1" class="modal1">
 <div class="modal-content1">

  <h3>Add Corrective Actions</h3>

  <!-- Row 1 -->
  <div class="grid-3">
    <div>
      <label>Branch</label>
      <select id="branchmodal1">
            <option value="" selected disabled>Select Branch</option>
            <option value="Ø§Ù„Ø¹Ø¯ÙˆÙ‡">Ø§Ù„Ø¹Ø¯ÙˆÙ‡</option>
            <option value="Ù…ØºØ§ØºØ©">Ù…ØºØ§ØºØ©</option>
            <option value="Ø¨Ù†Ù‰ Ù…Ø²Ø§Ø±">Ø¨Ù†Ù‰ Ù…Ø²Ø§Ø±</option>
            <option value="Ù…Ø·Ø§Ù‰">Ù…Ø·Ø§Ù‰</option>
            <option value="Ø³Ù…Ø§Ù„ÙˆØ·">Ø³Ù…Ø§Ù„ÙˆØ·</option>
            <option value="Ø§Ù„Ù…Ù†ÙŠØ§">Ø§Ù„Ù…Ù†ÙŠØ§</option>
            <option value="Ø§Ø¨ÙˆÙ‚Ø±Ù‚Ø§Øµ">Ø§Ø¨ÙˆÙ‚Ø±Ù‚Ø§Øµ</option>
            <option value="Ù…Ù„ÙˆÙ‰">Ù…Ù„ÙˆÙ‰</option>
            <option value="Ø¯ÙŠØ±Ù…ÙˆØ§Ø³">Ø¯ÙŠØ±Ù…ÙˆØ§Ø³</option> 
      </select>     
    </div>
    <div>
      <label>Station</label>
      <select id="stationmodal1">
        <option value="" selected disabled>Select Station</option>
            </select>
    </div>
    <div>
      <label>Certified Date</label>
      <input type="date" id="certifieddatemodal1" readonly>
    </div>
  </div>

  <hr>

  <!-- Row 2 -->
  <div class="grid-3">
    <div>
      <label>Location</label>
      <input type="text" id="locationmodal1">
    </div>
    <div>
      <label>Risk</label>
      <input type="text" id="riskmodal1">
    </div>
    <div>
      <label>Risk Degree</label>
      <select id="riskdegreemodal1">
        <option value="" selected disabled>Select Risk Degree</option>
            <option value="Ø®Ø·ÙˆØ±Ø© Ø¹Ø§Ù„ÙŠØ© Ø¬Ø¯Ø§Ù‹">Ø®Ø·ÙˆØ±Ø© Ø¹Ø§Ù„ÙŠØ© Ø¬Ø¯Ø§Ù‹</option>
            <option value="Ø®Ø·ÙˆØ±Ø© Ø¹Ø§Ù„ÙŠØ©">Ø®Ø·ÙˆØ±Ø© Ø¹Ø§Ù„ÙŠØ©</option>
            <option value="Ø®Ø·ÙˆØ±Ø© Ù…ØªÙˆØ³Ø·Ø©">Ø®Ø·ÙˆØ±Ø© Ù…ØªÙˆØ³Ø·Ø©</option>
            <option value="Ø®Ø·ÙˆØ±Ø© Ù…Ù†Ø®ÙØ¶Ø©">Ø®Ø·ÙˆØ±Ø© Ù…Ù†Ø®ÙØ¶Ø©</option> 
      </select>
    </div>
  </div>

  <!-- Row 3 -->
  <div class="grid-3">
    <div>
      <label>Corrective Action</label>
      <input type="text" id="corractionmodal1">
    </div>
    <div>
      <label>Duration</label>
      <input type="text" id="durationmodal1">
    </div>
    <div>
      <label>Executor</label>
      <select id="executormodal1">
         <option value="" selected disabled>Select Executor</option>
            <option value="WSP">WSP</option>
            <option value="Ø§Ù„Ø¹Ø¯ÙˆÙ‡">Ø§Ù„Ø¹Ø¯ÙˆÙ‡</option>
            <option value="Ù…ØºØ§ØºØ©">Ù…ØºØ§ØºØ©</option>
            <option value="Ø¨Ù†Ù‰ Ù…Ø²Ø§Ø±">Ø¨Ù†Ù‰ Ù…Ø²Ø§Ø±</option>
            <option value="Ù…Ø·Ø§Ù‰">Ù…Ø·Ø§Ù‰</option>
            <option value="Ø³Ù…Ø§Ù„ÙˆØ·">Ø³Ù…Ø§Ù„ÙˆØ·</option>
            <option value="Ø§Ù„Ù…Ù†ÙŠØ§">Ø§Ù„Ù…Ù†ÙŠØ§</option>
            <option value="Ø§Ø¨ÙˆÙ‚Ø±Ù‚Ø§Øµ">Ø§Ø¨ÙˆÙ‚Ø±Ù‚Ø§Øµ</option>
            <option value="Ù…Ù„ÙˆÙ‰">Ù…Ù„ÙˆÙ‰</option>
            <option value="Ø¯ÙŠØ±Ù…ÙˆØ§Ø³">Ø¯ÙŠØ±Ù…ÙˆØ§Ø³</option> 
      </select>
    </div>
  </div>

  <hr>

  <!-- Table -->
  <div class="table-correctiveactions">
  <table class="ca-table">
    
    <thead>
      <tr>
        <th>Ø§Ù„Ù…ÙˆÙ‚Ø¹</th>
        <th>Ø§Ù„Ø®Ø·Ø±</th>
        <th>Ø§Ù„Ø§Ø¬Ø±Ø§Ø¡ Ø§Ù„ØªØµØ­ÙŠØ­ÙŠ</th>
        <th>Ø¯Ø±Ø¬Ø© Ø§Ù„Ø®Ø·ÙˆØ±Ø©</th>
        <th>Ø§Ù„Ù…Ø¯Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©</th>
        <th>Ø§Ù„Ø¬Ù‡Ù‡ Ø§Ù„Ù…Ù†ÙØ°Ù‡</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td>-</td>
        <td>-</td>
        <td>-</td>
        <td>-</td>
        <td>-</td>
        <td>-</td>
      </tr>
    </tbody>
  </table>
  </div>

  <hr>

  <!-- Buttons -->
  <div class="modal-buttons">
    <button class="btn-submit" onclick="addCorrectiveAction()">Submit</button>
    <button class="btn-edit" onclick="editCorrectiveAction()">Edit</button>
    <button class="btn-delete" onclick="deleteCorrectiveAction()">Delete</button>
    <button class="btn-close" onclick="closeModal1()">Close</button>

  </div>

</div>

    
</div>
 
  <script>
    
    const scriptURL = "https://script.google.com/macros/s/AKfycbxRWjAEwonIeuxGVCo6c6cLjmN-3EAEnvgROBueGb-SozGAmuiXRCv1g3fO8DZ1kkzHzQ/exec";

    document.getElementById("addstation-button").onclick = () => {
      document.getElementById("stationModal").style.display = "flex";
    };
    
    function closeModal(){
      document.getElementById("stationModal").style.display = "none";
    }
    /* ===== Open / Close Modal ===== */
    function openCorrectiveModal() {
        document.getElementById("stationModal1").style.display = "block";
    }

    function closeModal1() {
        document.getElementById("stationModal1").style.display = "none";
        clearCorrectiveActionsModal();
    }
   
    function AccessedToPage(pagename){
                
                window.location.href= pagename+".html";
            }
  
    window.onload = () => {
      
      const email = sessionStorage.getItem("email");
      const department = sessionStorage.getItem("department");
      const userRole = sessionStorage.getItem("role");

      if (userRole !== "Admin") {
          const btn = document.getElementById("printCommentReport");
          if (btn) btn.style.display = "none";
      }

          
      document.getElementById("section").value = department || "";

         
      const stationSelect = document.getElementById("station");
      const stationSelectModal = document.getElementById("stationmodalselect"); //Ø®Ø§Øµ Ø¨Ø§Ø¶Ø§ÙØ© Ù…Ø­Ø·Ø©
      const branchSelect = document.getElementById("branch");
      const branchSelectModal = document.getElementById("branchmodalselect"); //Ø®Ø§Øµ Ø¨Ø§Ø¶Ø§ÙØ© Ù…Ø­Ø·Ø©
      const certifiedDateInput = document.getElementById("certifieddate");
      const certifiedDateInputModal = document.getElementById("certifieddatemodal"); //Ø®Ø§Øµ Ø¨Ø§Ø¶Ø§ÙØ© Ù…Ø­Ø·Ø©
      const locationSelect = document.getElementById("location");
      const riskInput = document.getElementById("risk");
      const corractionInput = document.getElementById("corraction");
      const durationInput = document.getElementById("duration");
      const statusSelect = document.getElementById("status");
      const branchcomment = document.getElementById("branchcomment");
      const wspcomment = document.getElementById("wspcomment");
      const branchbuttons = document.querySelectorAll('.branchbutton');
      const wspbuttons = document.querySelectorAll('.wspbutton');

         // Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù„ÙØŒ Ø¹Ø±Ø¶ Ø§Ø³Ù…Ù‡
      const attachmentInput = document.getElementById("attachment");
      const filenameDiv = document.getElementById("filename");
      
    
      attachmentInput.addEventListener("change", function() {
        if (attachmentInput.files.length > 0) {
          filenameDiv.textContent = attachmentInput.files[0].name;
        } else {
          filenameDiv.textContent = "No File";
        }
      });
      function parseDateSmart(dateStr) {
          // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø´ÙƒÙ„ yyyy-mm-dd (Ø´ÙƒÙ„ input type="date")
          if (/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) {
              const [y, m, d] = dateStr.split("-");
              return new Date(y, m - 1, d);
          }
      
          // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø´ÙƒÙ„ dd/mm/yyyy
          if (/^\d{2}\/\d{2}\/\d{4}$/.test(dateStr)) {
              const [d, m, y] = dateStr.split("/");
              return new Date(y, m - 1, d);
          }
      
          // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø´ÙƒÙ„ mm/dd/yyyy
          if (/^\d{2}\/\d{2}\/\d{4}$/.test(dateStr)) {
              const [m, d, y] = dateStr.split("/");
              return new Date(y, m - 1, d);
          }
      
          return new Date(dateStr); // fallback
      }

      ///ØªØºÙŠÙŠØ± Ù„ÙˆÙ† background Ù„Ù„ duration Ø­Ø³Ø¨ Ù‚Ø±Ø¨ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø§Ø¬Ø±Ø§Ø¡
      function updateDurationBackground() {
          const certifiedInput = document.getElementById("certifieddate");
          const durationInput = document.getElementById("duration");
      
          if (!certifiedInput || !durationInput) return;
          if (!certifiedInput.value || !durationInput.value) return;
      
          // Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„ØªØ§Ø±ÙŠØ® Ø¨Ø§Ù„ØµÙŠØº Ø§Ù„Ù…Ø®ØªÙ„ÙØ©
          let certifiedDate = parseDateSmart(certifiedInput.value);
      
          if (isNaN(certifiedDate.getTime())) {
              return;
          }
      
          const durationMonths = parseInt(durationInput.value);
          if (isNaN(durationMonths)) return;
      
          let endDate = new Date(certifiedDate);
          endDate.setMonth(endDate.getMonth() + durationMonths);
      
          const today = new Date();
          today.setHours(0,0,0,0);
          endDate.setHours(0,0,0,0);
      
          let monthsLeft =
              (endDate.getFullYear() - today.getFullYear()) * 12 +
              (endDate.getMonth() - today.getMonth());
      
                
          if (monthsLeft <= 0) {
              durationInput.style.backgroundColor = "#7A0000"; // red
          }
          else if (monthsLeft <= 3) {
              durationInput.style.backgroundColor = "#f8d7da"; // light red
          }
          else if (monthsLeft <= 12) {
              durationInput.style.backgroundColor = "#fff3cd"; // yellow
          }
          else {
              durationInput.style.backgroundColor = "#d4edda"; // green
          }
      }
      //ØªÙ„ÙˆÙŠÙ† Ø§Ù„Ù…Ø®Ø§Ø·Ø± Ø·Ø¨Ù‚Ø§ Ù„Ø¯Ø±Ø¬Ø© Ø§Ù„Ø®Ø·ÙˆØ±Ø©
      function updateRiskBackground(riskdegree) {
        const riskInput = document.getElementById("risk");
        if (!riskdegree) {
            riskInput.style.backgroundColor = "";
            return;
        }
    
        switch (riskdegree.trim()) {
            case "Ø®Ø·ÙˆØ±Ø© Ø¹Ø§Ù„ÙŠØ© Ø¬Ø¯Ø§Ù‹":
                riskInput.style.backgroundColor = "red"; // Ø£Ø­Ù…Ø±
                break;
            case "Ø®Ø·ÙˆØ±Ø© Ø¹Ø§Ù„ÙŠØ©":
                riskInput.style.backgroundColor = "orange"; // Ø¨Ø±ØªÙ‚Ø§Ù„Ù‰
                break;
            case "Ø®Ø·ÙˆØ±Ø© Ù…ØªÙˆØ³Ø·Ø©":
                riskInput.style.backgroundColor = "yellow"; // Ø£ØµÙØ±
                break;
            case "Ø®Ø·ÙˆØ±Ø© Ù…Ù†Ø®ÙØ¶Ø©":
                riskInput.style.backgroundColor = "green"; // Ø£Ø®Ø¶Ø±
                break;
            default:
                riskInput.style.backgroundColor = ""; // Ù„ÙˆÙ† Ø§ÙØªØ±Ø§Ø¶ÙŠ
                break;
        }
      }



      let branchStations = [];
      let branchDates = [];

       
        // Ù…Ù„Ø¡ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…ÙˆÙ‚Ø¹
      window.fillStationDetails = function(details) {

        locationSelect.innerHTML = '<option value="" disabled selected>Select Location</option>';
        locationSelect.detailsMap = {};
        details.forEach((detail, index) => {
          // ØªØ¬Ø§Ù‡Ù„ Ø§Ù„ØµÙÙˆÙ Ø§Ù„ØªÙŠ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ WSP Ø¥Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„ÙŠØ³ WSP
          if (department !== "WSP" && (detail.executor || "").trim() === "WSP"){ return;}
          // 2ï¸âƒ£ ØªØ¬Ø§Ù‡Ù„ Ø§Ù„ØµÙÙˆÙ Ø§Ù„ØªÙŠ checkbox = true Ø¥Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„ÙŠØ³ WSP
          if (department === "WSP" && detail.checkbox === true) { return;}

          const option = document.createElement("option");
          option.value = index;  // Ø£Ø±Ø³Ù„ Ù†Øµ Ø§Ù„Ù…ÙˆÙ‚Ø¹
          option.textContent = detail.location || "Unnamed Location";
          locationSelect.appendChild(option);
          locationSelect.detailsMap[index] = detail;
        });
      }

      locationSelect.addEventListener("change", () => {
        const selectedKey = locationSelect.value;
        if (!selectedKey) return;

        const detail = locationSelect.detailsMap[selectedKey];

        if (detail) {
          riskInput.value = detail.risk || "";
          corractionInput.value = detail.corraction || "";
          durationInput.value = detail.duration || "";
          
          // ØªØ­Ø¯ÙŠØ« Ù„ÙˆÙ† Ø§Ù„Ù€ duration Ø¨Ø¹Ø¯ ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
          updateDurationBackground();
          // ØªØ­Ø¯ÙŠØ« Ù„ÙˆÙ† Ø§Ù„Ù€ risk Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø¯Ø±Ø¬Ø© Ø§Ù„Ø®Ø·Ø±
          updateRiskBackground(detail.riskdegree);
          

          let status = (detail.status || "").trim();
          switch (true) {
             case /^ØªÙ…$/.test(status): status = "ØªÙ…"; break;
            case /^Ø¬Ø§Ø±Ù‰$/.test(status): status = "Ø¬Ø§Ø±Ù‰"; break;
            case /^Ù„Ù… ÙŠØªÙ…$/.test(status): status = "Ù„Ù… ÙŠØªÙ…"; break;
            default: status = "";
          }
          statusSelect.value = status;
          branchcomment.value = detail.branchcomment || "";
          wspcomment.value = detail.wspcomment || "";

          if (detail.attachment) {
            document.getElementById("filename").innerHTML = `<a href="${detail.attachment}" target="_blank">Show File</a>`;
          } else {
            document.getElementById("filename").textContent = "No File";
          }
        }
      });

      // Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø­Ø·Ø§Øª Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„ÙØ±Ø¹
      function fetchStations(branch) {
        if (!branch) return;

        stationSelect.innerHTML = '<option value="" disabled selected>Loading Stations..</option>';

        const url = scriptURL + "?action=getStations&branch=" + encodeURIComponent(branch);

        fetch(url)
          .then(res => res.json())
          .then(data => {
            if (data.status === "success") {
              stationSelect.innerHTML = '<option value="" disabled selected>Select Station</option>';
              branchStations = data.stations;
              branchDates = data.certifiedDates;
              
              data.stations.forEach(station => {
                const option = document.createElement("option");
                option.value = station;
                option.textContent = station;
                stationSelect.appendChild(option);
              });
            } else {
              stationSelect.innerHTML = '<option value="" disabled selected>Not found</option>';
            }
          })
          .catch(err => {
            console.error("Error fetching stations:", err);
            stationSelect.innerHTML = '<option value="" disabled selected>Connection Error</option>';
          });
      }
      
      

      const addStationBtn = document.getElementById("addstation-button");
      const addCorrectiveBtn = document.getElementById("addcorrectiveactions-button");
      // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ÙØ±Ø¹ Ø­Ø³Ø¨ Ø§Ù„Ù‚Ø³Ù…
      if (department !== "WSP") {
        branchSelect.value = department;
        branchSelect.disabled = true;
        branchcomment.disabled = false;
        wspcomment.disabled = true;
        wspbuttons.forEach(btn => btn.disabled = true);
        addStationBtn.style.display = "none";
        addCorrectiveBtn.style.display = "none";
        fetchStations(department);
      } else {
        branchSelect.disabled = false;
        branchcomment.disabled = true;
        wspcomment.disabled = false;
        branchbuttons.forEach(btn => btn.disabled = true);
        branchSelect.addEventListener("change", () => fetchStations(branchSelect.value));
       }

      // Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ù…Ø­Ø·Ø©
      stationSelect.addEventListener("change", () => {
        const selectedStation = stationSelect.value;
        const index = branchStations.indexOf(selectedStation);
        if (index !== -1 && branchDates[index]) {
          const date = new Date(branchDates[index]);
          const year = date.getFullYear();
          const month = String(date.getMonth() + 1).padStart(2, '0');
          const day = String(date.getDate()).padStart(2, '0');
          certifiedDateInput.value = `${year}-${month}-${day}`;
        } else certifiedDateInput.value = "";

        fetch(scriptURL + "?action=getStationDetails&station=" + encodeURIComponent(selectedStation))
          .then(res => res.json())
          .then(data => {
           
            if (data.status === "success" && data.details.length > 0) fillStationDetails(data.details);
             
            else {
              locationSelect.innerHTML = '<option value="" disabled selected>No locations</option>';
              riskInput.value = corractionInput.value = durationInput.value = statusSelect.value = "";
              branchcomment.value = wspcomment.value = "";
              document.getElementById("filename").textContent = "";
            }
          })
          .catch(err => console.error("Error fetching station details:", err));
      });
    };

    
   

    
    
    
   


    //Ø¶ØºØ· Ø§Ù„ØµÙˆØ± ÙˆØ§Ù„Ù…Ø±ÙÙ‚Ø§Øª
    function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result.split(',')[1]); 
        reader.onerror = error => reject(error);
      });
    }

    async function compressImage(file, maxWidth = 1280, maxHeight = 1280, quality = 0.7) {
      return new Promise(resolve => {
        const img = new Image();
        const reader = new FileReader();
    
        reader.readAsDataURL(file);
        reader.onload = e => {
          img.src = e.target.result;
          img.onload = () => {
            let canvas = document.createElement('canvas');
            let ctx = canvas.getContext("2d");
    
            let width = img.width;
            let height = img.height;
    
            if (width > maxWidth) {
              height = Math.floor(height * (maxWidth / width));
              width = maxWidth;
            }
            if (height > maxHeight) {
              width = Math.floor(width * (maxHeight / height));
              height = maxHeight;
            }
    
            canvas.width = width;
            canvas.height = height;
    
            ctx.drawImage(img, 0, 0, width, height);
    
            canvas.toBlob(
              blob => {
                resolve(new File([blob], file.name, { type: file.type }));
              },
              file.type,
              quality
            );
          };
        };
      });
    }

    


 
    async function sendCommentsData(event, action) {
      event = event || window.event;
      const email = sessionStorage.getItem("email");
      const department = sessionStorage.getItem("department"); 
      const locationSelect = document.getElementById("location");
      const corractionInput = document.getElementById("corraction");
      const durationInput = document.getElementById("duration");
      const attachmentInput = document.getElementById("attachment");
  
      // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ Ø­Ø³Ø¨ Ø§Ù„Ø²Ø±
      let currentDepartment = department;
      if (event.target.classList.contains("branchbutton")) {
          currentDepartment = document.getElementById("branch").value;
      } else if (event.target.classList.contains("wspbutton")) {
          currentDepartment = "wsp";
      }
  
      if (!confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆÙ‚Ù Ø§Ù„ØªÙ†ÙÙŠØ°ÙŠ ÙˆØ§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª ÙˆØ§Ù„Ù…Ø±ÙÙ‚ØŸ")) return;
  
      const selectedKey = locationSelect.value;
      if (!selectedKey) {
          alert("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©!");
          return;
      }
  
      const detail = locationSelect.detailsMap[selectedKey];
      if (!detail || !detail.location) {
          alert("âš ï¸ Ø§Ù„Ù…ÙˆÙ‚Ø¹ ØºÙŠØ± ØµØ­ÙŠØ­");
          return;
      }
  
      const locationText = detail.location;
      const riskText = detail.risk;
  
      if (action === "update" && (!locationText || !corractionInput.value || !durationInput.value)) {
          alert("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± ØµÙ Ø£Ùˆ ØªØ¹Ø¨Ø¦Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ù‚Ø¨Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«.");
          return;
      }
  
      // Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª
      let base64File = "";
      let fileName = "";
      if (attachmentInput.files.length > 0) {
          let file = attachmentInput.files[0];
          fileName = file.name;
          if (file.type.startsWith("image/")) file = await compressImage(file);
          base64File = await fileToBase64(file);
      }
     let statusPercentValue = "";

        // Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©
        const statusValue = document.getElementById("status").value;
        
        // Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© (Ø¥Ù† ÙˆØ¬Ø¯Øª)
        let previousPercent = "";
        if (detail && detail.statuspercent !== undefined && detail.statuspercent !== null) {
            previousPercent = detail.statuspercent.toString();
        }
        
        //  Ø§Ù„Ù…Ù†Ø·Ù‚ Ø§Ù„ÙƒØ§Ù…Ù„ Ù„Ù…Ø³ØªØ®Ø¯Ù… WSP ÙÙ‚Ø·
        if (department === "WSP") {
        
            // âœ… ØªÙ… â†’ 100%
            if (statusValue === "ØªÙ…") {
                statusPercentValue = 100;
            }
        
            // âŒ Ù„Ù… ÙŠØªÙ… â†’ 0%
            else if (statusValue === "Ù„Ù… ÙŠØªÙ…") {
                statusPercentValue = 0;
            }
        
            // ğŸŸ¡ Ø¬Ø§Ø±Ù‰ â†’ Prompt
            else if (statusValue === "Ø¬Ø§Ø±Ù‰") {
        
                const wspInput = prompt(
                    "ğŸ“Š Ø§Ù„Ø­Ø§Ù„Ø©: Ø¬Ø§Ø±Ù‰\n" +
                    "Ø¨Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù†Ø³Ø¨Ø© Ø§Ù„ØªÙ†ÙÙŠØ° (1 - 99):",
                    previousPercent
                );
        
                if (wspInput === null || wspInput.trim() === "") {
                    alert("âŒ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­ÙØ¸ Ø§Ù„Ø­Ø§Ù„Ø© Ø¨Ø¯ÙˆÙ† Ø¥Ø¯Ø®Ø§Ù„ Ù†Ø³Ø¨Ø© Ø§Ù„ØªÙ†ÙÙŠØ°");
                    return;
                }
        
                const percent = Number(wspInput);
        
                if (isNaN(percent) || percent < 1 || percent > 99) {
                    alert("âŒ Ù†Ø³Ø¨Ø© Ø§Ù„ØªÙ†ÙÙŠØ° ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ø±Ù‚Ù…Ù‹Ø§ Ø¨ÙŠÙ† 1 Ùˆ 99");
                    return;
                }
        
                statusPercentValue = percent;
            }
        }


  
      // ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø¥Ø±Ø³Ø§Ù„
      const formData = new URLSearchParams();
      formData.append("action", "updatestation");
      formData.append("station", document.getElementById("station").value);
      formData.append("email", email);
      formData.append("department", currentDepartment);
      formData.append("location", locationText.trim());
      formData.append("risk", riskText.trim());
      formData.append("corraction", corractionInput.value);
      formData.append("duration", durationInput.value);
      formData.append("status", document.getElementById("status").value);
      formData.append("statuspercent", statusPercentValue);
      formData.append("branchcomment", document.getElementById("branchcomment").value);
      formData.append("wspcomment", document.getElementById("wspcomment").value);
      formData.append("sendEmail", "true");
      formData.append("fileBase64", base64File);
      formData.append("fileName", fileName);
  
      console.log("ğŸ“¤ Sending form data:", formData.toString());
  
      let result; // ØªØ¹Ø±ÙŠÙ Ù…ØªØºÙŠØ± result Ù‚Ø¨Ù„ try/catch
  
      try {
          const response = await fetch(scriptURL, {
              method: "POST",
              headers: { "Content-Type": "application/x-www-form-urlencoded" },
              body: formData.toString()
          });
  
          const text = await response.text();
  
          try {
              result = JSON.parse(text);
              console.log("Server response:", result);
          } catch (e) {
              console.warn("Non-JSON response (possibly CORS issue):", text);
              alert("ØªØ¹Ø°Ø± Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±.");
              return;
          }
  
          if (result.status === "unauthorized") {
              alert("ØºÙŠØ± Ù…ØµØ±Ø­ Ù„Ùƒ Ø¨Ø§Ù„ÙˆØµÙˆÙ„.");
              return;
          }
  
          if (result.result === "Updated") {
              alert("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ù„Ù…Ø±ÙÙ‚ Ø¨Ù†Ø¬Ø§Ø­ âœ…");
          } else if (result.result === "Location not found") {
              alert("âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø­Ø¯Ø¯ ÙÙŠ Ø§Ù„Ø´ÙŠØª.");
              return;
          } else {
              console.warn("âš ï¸ Unexpected result object:", result);
              alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠØ«.");
          }
  
      } catch (error) {
          console.error("ğŸ’¥ Error sending data:", error);
          alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. Ø±Ø§Ø¬Ø¹ Console.");
          return;
      }
  
      // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ø¯ÙŠØ«
      const currentStation = document.getElementById("station").value;
      try {
          const detailsResponse = await fetch(scriptURL + "?action=getStationDetails&station=" + encodeURIComponent(currentStation));
          const detailsData = await detailsResponse.json();
          if (detailsData.status === "success") {
              fillStationDetails(detailsData.details);
              const keys = Object.keys(locationSelect.detailsMap);
              const foundKey = keys.find(k => locationSelect.detailsMap[k].location === locationText);
              if (foundKey) locationSelect.value = foundKey;
          }
      } catch (err) {
          console.error("Error refreshing locations:", err);
      }
  
      // Ø§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø²Ø± WSP
      if (event.target.classList.contains("wspbutton")) {
        if (confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„Ø§Ø¬Ø±Ø§Ø¡ØŸ")) {
            const formDataApproval = new URLSearchParams();
            formDataApproval.append("action", "approveAction");
            formDataApproval.append("station", currentStation);
            formDataApproval.append("location", locationText.trim());
            formDataApproval.append("risk", riskText.trim());
            formDataApproval.append("email", email);
            formDataApproval.append("checkbox", "true");
    
            try {
                const approvalRes = await fetch(scriptURL, {
                    method: "POST",
                    headers: { "Content-Type": "application/x-www-form-urlencoded" },
                    body: formDataApproval.toString()
                });
    
                if (!approvalRes.ok) throw new Error(`HTTP error ${approvalRes.status}`);
    
                const approvalData = await approvalRes.json();
    
                if (approvalData.result === "Approved") {
                    alert("ØªÙ… Ø§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„Ø§Ø¬Ø±Ø§Ø¡ Ø¨Ù†Ø¬Ø§Ø­ âœ…");
    
                    const refreshRes = await fetch(`${scriptURL}?action=getStationDetails&station=${encodeURIComponent(currentStation)}`);
                    if (!refreshRes.ok) throw new Error(`HTTP error ${refreshRes.status}`);
    
                    const refreshData = await refreshRes.json();
                    if (refreshData.status === "success") fillStationDetails(refreshData.details);
                } else {
                    alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„Ø§Ø¬Ø±Ø§Ø¡.");
                }
    
            } catch (err) {
                console.error("Approval error:", err);
                alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„Ø§Ø¬Ø±Ø§Ø¡.");
            }
        }
    }

  
      clearMainForm();
      fetchData(email, department);
  }
  

      function clearMainForm() {
        document.getElementById("location").value = "";
        document.getElementById("risk").value = "";
        document.getElementById("corraction").value = "";
        document.getElementById("duration").value = "";
        document.getElementById("status").value = "";
        document.getElementById("attachment").value = "";
        document.getElementById("branchcomment").value = "";
        document.getElementById("wspcomment").value = "";
        document.getElementById("filename").textContent = "";
      }
      function fetchData(email, department) {
        fetch(`${scriptURL}?action=getStationDetails&email=${encodeURIComponent(email)}&department=${encodeURIComponent(department)}`)
          .then(response => response.json())
          .then(data => {
            console.log("âœ… Response JSON from server:", data);  // Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªÙŠØ¬Ø© ÙƒØ§Ù…Ù„Ø© Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±
            if (data.status === "unauthorized") {
              alert("ØºÙŠØ± Ù…ØµØ±Ø­ Ù„Ùƒ Ø¨Ø§Ù„ÙˆØµÙˆÙ„");
              return;
            }
            // Ù‡Ù†Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
          }) // ØªÙ… Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù€ then Ù‡Ù†Ø§
          .catch(error => {
            console.error("Ø®Ø·Ø£:", error);
            alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.");
          });
      }

    
    /// Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø©
    const branchSelectModal1 = document.getElementById("branchmodal1");
    const stationSelectModal1 = document.getElementById("stationmodal1");
    const certifiedDateInputModal1 = document.getElementById("certifieddatemodal1");
    
    // Ù…ØµÙÙˆÙØ§Øª Ù„Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙØ±Ø¹
    let branchStations = [];
    let branchDates = [];
    
    // --- Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø­Ø·Ø§Øª Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„ÙØ±Ø¹ ---
    function fetchStations(branch) {
      if (!branch) return;
    
      stationSelectModal1.innerHTML = '<option value="" disabled selected>Loading Stations...</option>';
    
      const url = scriptURL + "?action=getStations&branch=" + encodeURIComponent(branch);
    
      fetch(url)
        .then(res => res.json())
        .then(data => {
          if (data.status === "success") {
            stationSelectModal1.innerHTML = '<option value="" disabled selected>Select Station</option>';
            branchStations = data.stations;      // Ø­ÙØ¸ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…Ø­Ø·Ø§Øª
            branchDates = data.certifiedDates;   // Ø­ÙØ¸ Ø§Ù„ØªÙˆØ§Ø±ÙŠØ®
    
            data.stations.forEach(station => {
              const option = document.createElement("option");
              option.value = station;
              option.textContent = station;
              stationSelectModal1.appendChild(option);
            });
          } else {
            stationSelectModal1.innerHTML = '<option value="" disabled selected>Not found</option>';
          }
        })
        .catch(err => {
          console.error("Error fetching stations:", err);
          stationSelectModal1.innerHTML = '<option value="" disabled selected>Connection Error</option>';
        });
    }
    
    // --- Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„ÙØ±Ø¹ ---
    branchSelectModal1.addEventListener("change", () => {
      const selectedBranch = branchSelectModal1.value;
      certifiedDateInputModal1.value = ""; // ØªÙØ±ÙŠØº Ø§Ù„ØªØ§Ø±ÙŠØ® Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„ÙØ±Ø¹
      fetchStations(selectedBranch);
    });
    
    // --- Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ù…Ø­Ø·Ø© ---
    stationSelectModal1.addEventListener("change", () => {
      const selectedStation = stationSelectModal1.value;
      const index = branchStations.indexOf(selectedStation);
    
      // --- ØªØ­Ø¯ÙŠØ« ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ ---
      if (index !== -1 && branchDates[index]) {
        const date = new Date(branchDates[index]);
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
    
        // MM/DD/YYYY
        certifiedDateInputModal1.value = `${year}-${month}-${day}`; // YYYY-MM-DD
      } else {
        certifiedDateInputModal1.value = "";
      }
      loadCorrectiveActions();      
    });




    // Ù„Ø¬Ù„Ø¨ Ø§Ù„Ø§Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„ØªØµØ­ÙŠØ­ÙŠØ© Ø§Ù„Ù…Ø±Ø§Ø¯ ØªØ¹Ø¯ÙŠÙ„Ù‡Ø§ ÙÙ‰ Ø§Ù„Ù…ÙˆØ¯Ù„
    let selectedRowIndex = null;

    function loadCorrectiveActions() {
      const station = document.getElementById("stationmodal1").value;
    
      fetch(scriptURL, {
        method: "POST",
        body: new URLSearchParams({
          action: "getCorrectiveActions",
          station
        })
      })
        .then(res => res.json())
        .then(data => {
          const tbody = document.querySelector(".ca-table tbody");
          tbody.innerHTML = "";
    
          data.forEach(row => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td>${row.location}</td>
              <td>${row.risk}</td>
              <td>${row.corraction}</td>
              <td>${row.riskdegree}</td>
              <td>${row.duration}</td>
              <td>${row.executor}</td>
            `;
    
            tr.onclick = () => fillForm(row);
            tbody.appendChild(tr);
          });
        });
    }
    ///Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙ Ø§Ù„Ù…Ø®ØªØ§Ø± ÙÙ‰ Ø®Ø§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¯Ù„
    function fillForm(row) {
      selectedRowIndex = row.rowIndex;
    
      document.getElementById("locationmodal1").value = row.location;
      document.getElementById("riskmodal1").value = row.risk;
      document.getElementById("corractionmodal1").value = row.corraction;
      document.getElementById("riskdegreemodal1").value = row.riskdegree;
      document.getElementById("durationmodal1").value = row.duration;
      document.getElementById("executormodal1").value = row.executor;
    }
    ///Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„ØªØµØ­ÙŠØ­ÙŠØ© ÙÙ‰ Ø§Ù„Ù…ÙˆØ¯Ù„
    function editCorrectiveAction() {
      if (!selectedRowIndex) {
        alert("Ø§Ø®ØªØ± ØµÙÙ‹Ø§ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„");
        return;
      }
    
      fetch(scriptURL, {
        method: "POST",
        body: new URLSearchParams({
          action: "editCorrectiveAction",
          station: document.getElementById("stationmodal1").value,
          rowIndex: selectedRowIndex,
          location: document.getElementById("locationmodal1").value,
          risk: document.getElementById("riskmodal1").value,
          corraction: document.getElementById("corractionmodal1").value,
          riskdegree: document.getElementById("riskdegreemodal1").value,
          duration: document.getElementById("durationmodal1").value,
          executor: document.getElementById("executormodal1").value
        })
      })
        .then(res => res.json())
        .then(res => alert(res.message));
        clearCorrectiveActionsModal();
    }
    ///Ø­Ø°Ù Ø§Ù„Ø§Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„ØªØµØ­ÙŠØ­ÙŠØ© Ø§Ù„Ù…Ø±Ø§Ø¯ Ø­Ø°ÙÙ‡Ø§ ÙÙ‰ Ø§Ù„Ù…ÙˆØ¯Ù„
    function deleteCorrectiveAction() {
      if (!selectedRowIndex) {
        alert("Ø§Ø®ØªØ± ØµÙÙ‹Ø§ Ù„Ù„Ø­Ø°Ù");
        return;
      }
    
      if (!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø­Ø°ÙØŸ")) return;
    
      fetch(scriptURL, {
        method: "POST",
        body: new URLSearchParams({
          action: "deleteCorrectiveAction",
          station: document.getElementById("stationmodal1").value,
          rowIndex: selectedRowIndex
        })
      })
        .then(res => res.json())
        .then(res => {
          alert(res.message);
          loadCorrectiveActions();
        });
    }
    ///Ø§Ø¶Ø§ÙØ© Ø§Ù„Ø§Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„ØªØµØ­ÙŠØ­ÙŠØ© Ù„Ù…Ø­Ø·Ø© Ù…Ø¹ØªÙ…Ø¯Ø©
    function addCorrectiveAction() {
      const station = document.getElementById("stationmodal1").value;
      if (!station) {
        alert("Ø§Ø®ØªØ± Ø§Ù„Ù…Ø­Ø·Ø© Ø£ÙˆÙ„Ø§Ù‹");
        return;
      }
    
      const params = {
        action: "saveCorrectiveAction",
        station: station,
        location: document.getElementById("locationmodal1").value,
        risk: document.getElementById("riskmodal1").value,
        corraction: document.getElementById("corractionmodal1").value,
        riskdegree: document.getElementById("riskdegreemodal1").value,
        duration: document.getElementById("durationmodal1").value,
        executor: document.getElementById("executormodal1").value
      };
    
      fetch(scriptURL, {
        method: "POST",
        body: new URLSearchParams(params)
      })
        .then(res => res.json())
        .then(res => {
          alert(res.message);
          loadCorrectiveActions(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù…Ø¨Ø§Ø´Ø±Ø©
          clearCorrectiveActionsModal(); // Ù…Ø³Ø­ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø¨Ø¹Ø¯ Ø§Ù„Ø¥Ø¶Ø§ÙØ©
        })
        .catch(err => {
          console.error(err);
          alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¥Ø¶Ø§ÙØ©");
        });
    }
    
    function clearCorrectiveActionsModal() {
      const formIds = [
        "locationmodal1", "riskmodal1", "corractionmodal1", "riskdegreemodal1",
        "durationmodal1", "executormodal1"
      ];
      formIds.forEach(id => document.getElementById(id).value = "");
      selectedRowIndex = null;
    }
    // --- Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ Ø§Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø­Ø·Ø§Øª ---
    const branchSelectModal = document.getElementById("branchmodalselect");
    const stationSelectModal = document.getElementById("stationmodalselect");
    const certifiedDateModal = document.getElementById("certifieddatemodal");
    
    // Ù…ØµÙÙˆÙØ§Øª Ù„Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙØ±Ø¹
    let modalStations = [];
    let modalDates = [];
    
    // --- Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø­Ø·Ø§Øª Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙØ±Ø¹ ---
    function fetchStationsModal(branch) {
      if (!branch) return;
    
      stationSelectModal.innerHTML = '<option value="" disabled selected>Loading Stations...</option>';
    
      const url = scriptURL + "?action=getStations&branch=" + encodeURIComponent(branch);
    
      fetch(url)
        .then(res => res.json())
        .then(data => {
          if (data.status === "success") {
            stationSelectModal.innerHTML = `
            <option value="" disabled selected>Select Station</option>
            <option value="__new__">Ø¥Ø¶Ø§ÙØ© Ù…Ø­Ø·Ø©</option>
          `;
              
    
            modalStations = data.stations;      // Ø­ÙØ¸ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…Ø­Ø·Ø§Øª
            modalDates = data.certifiedDates;   // Ø­ÙØ¸ Ø§Ù„ØªÙˆØ§Ø±ÙŠØ®
    
            data.stations.forEach(station => {
              const option = document.createElement("option");
              option.value = station;
              option.textContent = station;
              stationSelectModal.appendChild(option);
            });
          } else {
            stationSelectModal.innerHTML = '<option value="" disabled selected>Not found</option>';
          }
        })
        .catch(err => {
          console.error("Error fetching stations:", err);
          stationSelectModal.innerHTML = '<option value="" disabled selected>Connection Error</option>';
        });
    }
    
    // --- Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„ÙØ±Ø¹ ---
    branchSelectModal.addEventListener("change", () => {
      const selectedBranch = branchSelectModal.value;
      certifiedDateModal.value = ""; // ØªÙØ±ÙŠØº Ø§Ù„ØªØ§Ø±ÙŠØ®
      modalStations = [];
      modalDates = [];
      stationSelectModal.innerHTML = `
            <option value="" disabled selected>Select Station</option>
            <option value="__new__">Ø¥Ø¶Ø§ÙØ© Ù…Ø­Ø·Ø©</option>
          `;
    
      fetchStationsModal(selectedBranch);
    });
    
    // --- Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ù…Ø­Ø·Ø© ---
    stationSelectModal.addEventListener("change", () => {
      const selectedStation = stationSelectModal.value;
      const index = modalStations.indexOf(selectedStation);
    
      // --- ØªØ­Ø¯ÙŠØ« ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ Ø¨ØµÙŠØºØ© YYYY-MM-DD Ù„Ù€ input type=date ---
      if (index !== -1 && modalDates[index]) {
        const date = new Date(modalDates[index]);
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
    
        certifiedDateModal.value = `${year}-${month}-${day}`; // YYYY-MM-DD
      } else {
        certifiedDateModal.value = "";
      }
      // --- Ø¥Ø¸Ù‡Ø§Ø± Ø£Ùˆ Ø¥Ø®ÙØ§Ø¡ Ø­Ù‚Ù„ Ø¥Ø¶Ø§ÙØ© Ù…Ø­Ø·Ø© Ø¬Ø¯ÙŠØ¯Ø© ---
      const newStationInput = document.getElementById("newstationmodal");
      if (selectedStation === "__new__") { 
        newStationInput.style.display = "block"; // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø­Ù‚Ù„
        newStationInput.value = "";              // ØªÙØ±ÙŠØº Ø£ÙŠ Ù‚ÙŠÙ…Ø© Ø³Ø§Ø¨Ù‚Ø©
      } else {
        newStationInput.style.display = "none"; // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø­Ù‚Ù„
        newStationInput.value = "";              // ØªÙØ±ÙŠØº Ø§Ù„Ù‚ÙŠÙ…Ø©
      }
      
    });
    
    // Ø­ÙØ¸ Ø§Ù„Ù…Ø­Ø·Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ø£Ùˆ ØªØ­Ø¯ÙŠØ« ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯
    function submitStation() {
      // Ø¬Ù„Ø¨ Ø§Ù„Ù‚ÙŠÙ… Ù…Ù† Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
      const branchSelect = document.getElementById("branchmodalselect");
      const stationSelect = document.getElementById("stationmodalselect");
      const newStationInput = document.getElementById("newstationmodal");
      const certifiedDateInput = document.getElementById("certifieddatemodal").value;
    
      const branch = branchSelect.value;
      const station = stationSelect.value === "__new__" ? newStationInput.value.trim() : stationSelect.value;
    
      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§ÙƒØªÙ…Ø§Ù„ Ø§Ù„Ø­Ù‚ÙˆÙ„
      if (!branch || !station || !certifiedDateInput) {
        alert("Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ù…Ø·Ù„ÙˆØ¨Ø©!");
        return;
      }
    
      // ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø¥Ø°Ø§ Ø£Ø±Ø¯Ù†Ø§ ØµÙŠØºØ© DD/MM/YYYY (Ø§Ø®ØªÙŠØ§Ø±ÙŠ Ø­Ø³Ø¨ Ø§Ù„Ø³ÙŠØ±ÙØ±)
      const [year, month, day] = certifiedDateInput.split("-");
      const certifiedDate = `${day}/${month}/${year}`;
    
      // ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø¥Ø±Ø³Ø§Ù„
      const params = new URLSearchParams({
        action: "saveCertifiedStation",
        branch: branch,
        station: station,
        certifiedDate: certifiedDateInput // Ø£Ùˆ certifiedDate Ø¥Ø°Ø§ Ø§Ù„Ø³ÙŠØ±ÙØ± ÙŠØ±ÙŠØ¯ DD/MM/YYYY
      });
    
      // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ Ø§Ù„Ø³ÙŠØ±ÙØ±
      fetch(scriptURL, { method: "POST", body: params })
        .then(res => res.json())
        .then(res => {
          alert(res.message);
          clearCertifiedStationAdditionModal();
        })
        .catch(err => {
          console.error(err);
          alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸");
        });
    }
    
    // Ù…Ø³Ø­ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø¨Ø¹Ø¯ Ø§Ù„Ø­ÙØ¸
    function clearCertifiedStationAdditionModal() {
      document.getElementById("branchmodalselect").selectedIndex = 0;
      document.getElementById("stationmodalselect").selectedIndex = 0;
      document.getElementById("newstationmodal").value = "";
      document.getElementById("certifieddatemodal").value = "";  
    }












    
      // Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø§Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„ØªØµØ­ÙŠØ­Ø© 
      document.getElementById("printReport").addEventListener("click", () => {
      const branch = document.getElementById("branch").value || "----";
      const station = document.getElementById("station").value || "----";
      const certifiedDate = document.getElementById("certifieddate").value || "----";
  
      const locationSelect = document.getElementById("location");
      const detailsMap = locationSelect.detailsMap;
  
      if (!detailsMap || Object.keys(detailsMap).length === 0) {
          alert("No Data for Print!");
          return;
      }
  
      // Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹ (Ø¨Ø¯ÙˆÙ† ÙÙ„ØªØ±Ø©)
      const allLocations = Object.values(detailsMap) || [];
  
      // Ø¥Ø°Ø§ Ù„Ù… ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª
      if (allLocations.length === 0) {
          alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©!");
          return;
      }
  
      let rowsHtml = allLocations.map(detail => `
          <tr>
              <td>${detail.location || ""}</td>
              <td>${detail.risk || ""}</td>
              <td>${detail.corraction || ""}</td>
              <td>${detail.duration || ""}</td>
              <td>${detail.status || ""}</td>
              <td>${detail.notes || ""}</td>
          </tr>
      `).join("");
  
      const htmlContent = `
          <html>
          <head>
              <title>ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯</title>
              <style>
                  body { font-family: Arial, sans-serif; direction: rtl; text-align: right; }
                  table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                  th, td { border: 1px solid #000; padding: 5px; word-wrap: break-word; }
                  th { background-color: #f0f0f0; }
                  h2 { text-align: center; }
                  p { text-align: center; }
                  th:nth-child(1), td:nth-child(1) { width: 10%; }
                  th:nth-child(2), td:nth-child(2) { width: 15%; }
                  th:nth-child(3), td:nth-child(3) { width: 25%; }
                  th:nth-child(4), td:nth-child(4) { width: 10%; }
                  th:nth-child(5), td:nth-child(5) { width: 10%; }
                  th:nth-child(6), td:nth-child(6) { width: 25%; }
              </style>
          </head>
          <body>
              <h2>ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…ÙˆÙ‚Ù Ù…Ù† ØªÙ†ÙÙŠØ° Ø§Ù„Ø§Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„ØªØµØ­ÙŠØ­ÙŠØ©</h2>
              <p><strong>Ø§Ù„ÙØ±Ø¹:</strong> ${branch} &nbsp;&nbsp;<strong>Ø§Ù„Ù†Ø¸Ø§Ù…:</strong> ${station} &nbsp;&nbsp;<strong>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯:</strong> ${certifiedDate}</p>
  
              <table>
                  <thead>
                      <tr>
                          <th>Ø§Ù„Ù…ÙˆÙ‚Ø¹</th>
                          <th>Ø§Ù„Ø®Ø·Ø±</th>
                          <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„ØªØµØ­ÙŠØ­ÙŠ</th>
                          <th>Ø§Ù„Ù…Ø¯Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©</th>
                          <th>Ø§Ù„Ù…ÙˆÙ‚Ù Ø§Ù„ØªÙ†ÙÙŠØ°ÙŠ</th>
                          <th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
                      </tr>
                  </thead>
                  <tbody>
                      ${rowsHtml}
                  </tbody>
              </table>
          </body>
          </html>
      `;
  
      const printWindow = window.open('', '', 'height=600,width=800');
      printWindow.document.write(htmlContent);
      printWindow.document.close();
      printWindow.focus();
      printWindow.print();
  });
    
       // Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø§Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„ØªØµØ­ÙŠØ­ÙŠØ© ÙˆÙ…Ù„Ø§Ø­Ø¸Ø§Øª WSP Ø·Ø¨Ù‚Ø§Ù‹ Ù„Ù†Ø³Ø¨Ø© ØªÙ†ÙÙŠØ° Ø§Ù‚Ù„ Ù…Ù† (100%)
       document.getElementById("printCommentsReport").addEventListener("click", () => {
    
        const branch = document.getElementById("branch").value || "----";
        const station = document.getElementById("station").value || "----";
        const certifiedDate = document.getElementById("certifieddate").value || "----";
    
        const locationSelect = document.getElementById("location");
        const detailsMap = locationSelect.detailsMap;
    
        if (!detailsMap || Object.keys(detailsMap).length === 0) {
            alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©!");
            return;
        }
    
        // ÙÙ„ØªØ±Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø³Ø¨ statuspercent < 100
        const filteredData = Object.values(detailsMap).filter(detail => {
            return Number(detail.statuspercent) < 100;
        });
    
        if (filteredData.length === 0) {
            alert("Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ù…ÙƒØªÙ…Ù„Ø© 100%");
            return;
        }
    
        let rowsHtml = filteredData.map(detail => `
            <tr>
                <td>${detail.location || ""}</td>
                <td>${detail.risk || ""}</td>
                <td>${detail.corraction || ""}</td>
                <td>${detail.status || ""}</td>
                <td>${detail.wspcomment || ""}</td>
            </tr>
        `).join("");
    
        const htmlContent = `
            <html>
            <head>
                <title>ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª ØºÙŠØ± Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©</title>
                <style>
                    body { font-family: Arial, sans-serif; direction: rtl; text-align: right; }
                    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                    th, td { border: 1px solid #000; padding: 6px; }
                    th { background-color: #f0f0f0; }
                    h2, p { text-align: center; }
                    th:nth-child(1), td:nth-child(1) { width: 15%; }
                    th:nth-child(2), td:nth-child(2) { width: 25%; }
                    th:nth-child(3), td:nth-child(3) { width: 25%; }
                    th:nth-child(4), td:nth-child(4) { width: 10%; }
                    th:nth-child(5), td:nth-child(5) { width: 35%; }
                </style>
            </head>
            <body>
                <h2>ØªÙ‚Ø±ÙŠØ± Ø¨Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„ØªØµØ­ÙŠØ­ÙŠØ© Ø§Ù„ØºÙŠØ± Ù…ÙƒØªÙ…Ù„Ø©</h2>
                <p>
                    <strong>Ø§Ù„ÙØ±Ø¹:</strong> ${branch}
                    &nbsp;&nbsp;
                    <strong>Ø§Ù„Ù†Ø¸Ø§Ù…:</strong> ${station}
                    &nbsp;&nbsp;
                    <strong>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯:</strong> ${certifiedDate}
                </p>
    
                <table>
                    <thead>
                        <tr>
                            <th>Ø§Ù„Ù…ÙˆÙ‚Ø¹</th>
                            <th>Ø§Ù„Ø®Ø·Ø±</th>
                            <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„ØªØµØ­ÙŠØ­ÙŠ</th>
                             <th>Ø§Ù„Ù…ÙˆÙ‚Ù Ø§Ù„ØªÙ†ÙÙŠØ°Ù‰</th>
                            <th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª WSP</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${rowsHtml}
                    </tbody>
                </table>
            </body>
            </html>
        `;
    
        const printWindow = window.open('', '', 'height=600,width=900');
        printWindow.document.write(htmlContent);
        printWindow.document.close();
        printWindow.focus();
        printWindow.print();
});



    
    
    //  ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
    function logout() {
        sessionStorage.clear(); // Ù…Ø³Ø­ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ù„Ø³Ø©
        alert("You have been logged out");
        window.location.href = "index.html"; // Ø¥Ø¹Ø§Ø¯Ø© ØªÙˆØ¬ÙŠÙ‡ Ù„ØµÙØ­Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
    }


  </script>

  

</body>
</html>



