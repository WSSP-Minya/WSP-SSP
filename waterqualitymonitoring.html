<!DOCTYPE html>
<html>


<!--العنوان الرئيسى للصفحة-->
<head>
    <title >RWater Quality Monitoring</title>
    <link rel="stylesheet" href="Water_Quality.css">

</head>



<body>
    <!-- المستخدم وعنوان الصفحة-->
    <div class="topbar">
           <button class="logout-button" onclick="logout()">Logout</button>
           <div class="userinfo"> 
                <label>Section</label>
                <input id="section" disabled>
           </div>
    
           <img src="https://wssp.hcww.com.eg/public/static/media/wsp.22cd4e849308ae80b006.png" class="logo">
    </div>

<br>
<br>
    <h1>Raw Water Quality Monitoring</h1>




                    <!--Water qyality form-->
<form>
    <!--البيانات الاساسية-->
    <div class="essdata">
    <label class="dat" for="date">Date</label>
    <input id="date" type="date" required>

    <label class="dat"for="branch">Branch</label>
    <select id="branch" type="select" required>                      
            <option value="" disabled selected>Select Branch</option> 
            <option value="العدوه">العدوه</option>
            <option value="مغاغة">مغاغة</option>
            <option value="بنى مزار">بنى مزار</option>
            <option value="مطاى">مطاى</option>
            <option value="سمالوط">سمالوط</option>
            <option value="المنيا">المنيا</option>
            <option value="ابوقرقاص">ابوقرقاص</option>
            <option value="ملوى">ملوى</option>
            <option value="ديرمواس">ديرمواس</option>
    </select>
        
    <label class="dat" for="station">Station</label>
    <select id="station" value="" type="select"><option>Select Staion</option></select> 

    <label class="dat" for="sample">Location</label>
    <input id="sample" value="المأخذ" type="location" readonly>
    
    <input type="hidden" id="entry-id">


    
    </div>
    <hr>

  
       
        
    <div class="parameters-section">
        <hr>
    
        <!-- Radios -->
        <input id="physical" type="radio" name="para" checked>
        <label for="physical" class="para-label">Physical parameters</label>
    
        <input id="chemical" type="radio" name="para">
        <label for="chemical" class="para-label">Chemical parameters</label>
    
        <input id="biological" type="radio" name="para">
        <label for="biological" class="para-label">Biological parameters</label>
    
        <!-- Contents -->
        <div class="contents">
    
            <!-- Physical -->
            <div class="content card" id="physical-content">
                <div class="grid physical-grid">
                    <div>
                        <label for="turbidity">Turbidity NTU</label>
                        <input id="turbidity" name="turbidity" type="number">
                    </div>
                    <div>
                        <label for="pH">pH</label>
                        <input id="pH" name="pH" type="number">
                    </div>
                    <div>
                        <label for="temp">Temp <sup>o</sup>C</label>
                        <input id="temp" name="temp" type="number">
                    </div>
                </div>
            </div>
    
            <!-- Chemical -->
            <div class="content card" id="chemical-content">
                <div class="grid chemical-grid">
                    <div><label for="tds">TDS mg/l</label><input id="tds" name="tds" type="number"></div>
                    <div><label for="ch">Chlorides mg/l</label><input id="ch" name="ch" type="number"></div>
                    <div><label for="sulf">Sulfates mg/l</label><input id="sulf" name="sulf" type="number"></div>
                    <div><label for="fe">Fe mg/l</label><input id="fe" name="fe" type="number"></div>
                    <div><label for="mn">Mn mg/l</label><input id="mn" name="mn" type="number"></div>
                    <div><label for="nh3">NH<sub>3</sub> mg/l</label><input id="nh3" name="nh3" type="number"></div>
    
                    <div><label for="no2">NO<sub>2</sub> mg/l</label><input id="no2" name="no2" type="number"></div>
                    <div><label for="no3">NO<sub>3</sub> mg/l</label><input id="no3" name="no3" type="number"></div>
                    <div><label for="do">DO mg/l</label><input id="do" name="do" type="number"></div>
                    <div><label for="cod">COD mg/l</label><input id="cod" name="cod" type="number"></div>
                    <div><label for="bod">BOD mg/l</label><input id="bod" name="bod" type="number"></div>
                    <div><label for="og">Oil & Grease mg/l</label><input id="og" name="og" type="number"></div>
                </div>
            </div>
    
            <!-- Biological -->
            <div class="content card" id="biological-content">
                <div class="grid bio-grid">
                    <div>
                        <label for="tc">Total Coliform C.U.F/100 ml</label>
                        <input id="tc" name="tc" type="number">
                    </div>
                    <div>
                        <label for="ta">Total Algae Colony/100 ml</label>
                        <input id="ta" name="ta" type="number">
                    </div>
                </div>
            </div>
    
        </div>
   
    <br>
    <br>
    

    <div class="buttons">
        <button class="button-content">Submit</button>
        
        <button class="button-content">Update</button>
        
        <button class="button-content">Delete</button>
        
    </div>
    <br><br><br><br><br><br><br>
    <div>
        <button onclick="printTable()" class="output">
            <img src="https://static.vecteezy.com/system/resources/previews/006/693/009/non_2x/printer-icon-template-black-color-editable-printer-icon-symbol-flat-illustration-for-graphic-and-web-design-free-vector.jpg" alt="print">
        </button>
    
        <button onclick="exportTableToExcel('waterqualitytable', 'water_quality_data')" class="output">
            <img src="https://static.vecteezy.com/system/resources/previews/017/396/828/non_2x/microsoft-excel-mobile-apps-logo-free-png.png" alt="export">
        </button>
    </div>
    
    <table id = "waterqualitytable" class="table-data">
        <thead class="thead">
            <tr>
              
              <th>Date</th>
              <th>Branch</th> <!--تعديل السطر-->
              <th>Station</th> <!--اضافة سطر-->
              <th>location</th>
              <th>Turbidity</th>
              <th>pH</th>
              <th>Temp</th>
              <th>TDS</th>
              <th>Chlorides</th>
              <th>Sulfates</th>
              <th>Fe</th>
              <th>Mn</th>
              <th>NH<sub>3</sub></th>
              <th>NO<sub>2</sub></th>
              <th>NO<sub>3</sub></th>
              <th>DO</th>
              <th>COD</th>
              <th>BOD</th>
              <th>Oil&Grease</th>
              <th>Total Coliform</th>
              <th>Total Algae</th>
              
            </tr>
        </thead>
        <tbody>
            <tr>
              <td></td> 
            </tr>
        </tbody>
       
    </table>
   

</form>
</body> 
</html>
<script>
    const scriptURL = "https://script.google.com/macros/s/AKfycby6WsMlH_11y53X0pJb3cCj-FI_OL0k4uMCeBJAJTVcqO-HMvkoXKd_ukvad8b3p9lGFQ/exec";
    
    // متغير عام لتخزين القسم
    let department = "";
    
    // عند تحميل الصفحة
    window.onload = () => {
      email = sessionStorage.getItem("email");
      department = sessionStorage.getItem("department");
        
    
      const stationSelect = document.getElementById("station");
      const branchSelect = document.getElementById("branch");
    
      
      document.getElementById("section").value = department;
    
      if (department !== "WSP") {
        branchSelect.value = department;
        branchSelect.disabled = true;
    
        fetchStations(department, (data) => {
          stationSelect.innerHTML = '<option value="" disabled selected>Select Station</option>';
          if (data.status === "success") {
            data.stations.forEach(station => {
              const option = document.createElement("option");
              option.value = station;
              option.textContent = station;
              stationSelect.appendChild(option);
            });
          } else {
            stationSelect.innerHTML = '<option value="" disabled selected>Not found</option>';
          }
        });
      } else {
        branchSelect.disabled = false;
        branchSelect.addEventListener("change", () => {
          const selectedBranch = branchSelect.value;
          if (!selectedBranch) return;
    
          stationSelect.innerHTML = '<option value="" disabled selected>Loading Stations..</option>';
          fetchStations(selectedBranch, (data) => {
            stationSelect.innerHTML = '<option value="" disabled selected>Select Station</option>';
            if (data.status === "success") {
              data.stations.forEach(station => {
                const option = document.createElement("option");
                option.value = station;
                option.textContent = station;
                stationSelect.appendChild(option);
              });
            } else {
              stationSelect.innerHTML = '<option value="" disabled selected>Not found</option>';
            }
          });
        });
      }
    
      fetchData(email, department);
    
      // ربط الأزرار
      document.querySelectorAll(".button-content")[0].addEventListener("click", e => { e.preventDefault(); sendData("add"); });
      document.querySelectorAll(".button-content")[1].addEventListener("click", e => { e.preventDefault(); sendData("update"); });
      document.querySelectorAll(".button-content")[2].addEventListener("click", e => { e.preventDefault(); sendData("delete"); });
    };
    
    // ================= JSONP Fetch Functions =================
    function fetchData(email, department) {
      window.handleWaterData = function(data) {
        if (data.status === "unauthorized") {
          alert("غير مصرح لك بالوصول");
          return;
        }
    
        const rows = data.water_data;
        const tbody = document.querySelector("table.table-data tbody");
        tbody.innerHTML = "";
    
        const desiredColumnIndexes = [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21];
    
        rows.slice(1).forEach((row) => {
          const rowBranch = row[2];
          if (department !== "WSP" && rowBranch !== department) return;
    
          const tr = document.createElement("tr");
          row.forEach((cell, index) => {
            if (desiredColumnIndexes.includes(index)) {
              const td = document.createElement("td");
              if (index === 1) {
                const d = new Date(cell);
                td.textContent = !isNaN(d.getTime())
                  ? `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}/${d.getFullYear()}`
                  : cell ?? "";
              } else {
                td.textContent = cell ?? "";
              }
              tr.appendChild(td);
            }
          });
          tr.addEventListener("click", () => {
            clearRowHighlight();
            tr.classList.add("selected-row");
            fillFormWithRow(row);
          });
          tbody.appendChild(tr);
        });
    
        if (!tbody.hasChildNodes()) {
          const tr = document.createElement("tr");
          const td = document.createElement("td");
          td.colSpan = desiredColumnIndexes.length;
          td.textContent = "لا توجد بيانات لعرضها لهذه المنطقة.";
          td.style.textAlign = "center";
          tr.appendChild(td);
          tbody.appendChild(tr);
        }
      };
    
      const script = document.createElement("script");
      script.src = `${scriptURL}?action=getData&email=${encodeURIComponent(email)}&department=${encodeURIComponent(department)}&callback=handleWaterData`;
      document.body.appendChild(script);
    }
    
    function fetchStations(branch, callback) {
      window.handleStations = function(data) {
        callback(data);
      };
      const script = document.createElement("script");
      script.src = `${scriptURL}?action=getStations&branch=${encodeURIComponent(branch)}&callback=handleStations`;
      document.body.appendChild(script);
    }
    
    // ================= وظائف النموذج =================
    function fillFormWithRow(row) {
      const formattedDate = formatDateForInput(row[1]);
      document.getElementById("date").value = formattedDate;
      document.getElementById("entry-id").value = row[0];
      document.getElementById("branch").value = row[2];
    
      if (department === "WSP") {
        fetchStations(row[2], (data) => {
          const stationSelect = document.getElementById("station");
          stationSelect.innerHTML = '<option value="" disabled selected>Select Station</option>';
          if (data.status === "success") {
            data.stations.forEach(station => {
              const option = document.createElement("option");
              option.value = station;
              option.textContent = station;
              stationSelect.appendChild(option);
            });
            stationSelect.value = row[3];
          }
        });
      } else {
        document.getElementById("station").value = row[3];
      }
    
      document.getElementById("sample").value = row[4];
      document.getElementById("turbidity").value = row[5];
      document.getElementById("pH").value = row[6];
      document.getElementById("temp").value = row[7];
      document.getElementById("tds").value = row[8];
      document.getElementById("ch").value = row[9];
      document.getElementById("sulf").value = row[10];
      document.getElementById("fe").value = row[11];
      document.getElementById("mn").value = row[12];
      document.getElementById("nh3").value = row[13];
      document.getElementById("no2").value = row[14];
      document.getElementById("no3").value = row[15];
      document.getElementById("do").value = row[16];
      document.getElementById("cod").value = row[17];
      document.getElementById("bod").value = row[18];
      document.getElementById("og").value = row[19];
      document.getElementById("tc").value = row[20];
      document.getElementById("ta").value = row[21];
    }
    
    function formatDateForInput(dateValue) {
      try {
        const d = new Date(dateValue);
        if (isNaN(d.getTime())) return "";
        const [day, month, year] = d.toLocaleDateString("en-GB", { timeZone: "Africa/Cairo" }).split("/");
        return `${year}-${month.padStart(2,"0")}-${day.padStart(2,"0")}`;
      } catch { return ""; }
    }
    
    function clearRowHighlight() {
      document.querySelectorAll("table.table-data tr").forEach(row => row.classList.remove("selected-row"));
    }
    
    // ================= إرسال البيانات =================
    function sendData(action) {
      const email = sessionStorage.getItem("email");
      const department = sessionStorage.getItem("department");
    
      if ((action==="update" || action==="delete") && !document.getElementById("entry-id").value) {
        alert("يرجى اختيار صف من الجدول قبل التحديث أو الحذف.");
        return;
      }
    
      const formData = new URLSearchParams();
      formData.append("action", action);
      formData.append("email", email);
      formData.append("department", department);
      formData.append("id", document.getElementById("entry-id").value);
      formData.append("date", document.getElementById("date").value);
      formData.append("branch", document.getElementById("branch").value);
      formData.append("station", document.getElementById("station").value);
      formData.append("location", document.getElementById("sample").value);
      formData.append("turbidity", document.getElementById("turbidity").value);
      formData.append("ph", document.getElementById("pH").value);
      formData.append("temp", document.getElementById("temp").value);
      formData.append("tds", document.getElementById("tds").value);
      formData.append("chlorides", document.getElementById("ch").value);
      formData.append("sulfates", document.getElementById("sulf").value);
      formData.append("fe", document.getElementById("fe").value);
      formData.append("mn", document.getElementById("mn").value);
      formData.append("nh3", document.getElementById("nh3").value);
      formData.append("no2", document.getElementById("no2").value);
      formData.append("no3", document.getElementById("no3").value);
      formData.append("do", document.getElementById("do").value);
      formData.append("cod", document.getElementById("cod").value);
      formData.append("bod", document.getElementById("bod").value);
      formData.append("og", document.getElementById("og").value);
      formData.append("tc", document.getElementById("tc").value);
      formData.append("ta", document.getElementById("ta").value);
    
      fetch(scriptURL, {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: formData.toString()
      })
      .then(res => res.text())
      .then(result => {
        alert(`تمت عملية ${action==='add'?'الإضافة':action==='update'?'التحديث':'الحذف'} بنجاح.`);
        clearForm();
        fetchData(email, department);
      })
      .catch(error => { console.error("خطأ:", error); alert("حدث خطأ أثناء تنفيذ العملية."); });
    }
    
    function clearForm() {
      document.querySelector("form").reset();
      document.getElementById("entry-id").value = "";
      clearRowHighlight();
      if (department !== "WSP") {
        document.getElementById("branch").value = department;
        document.getElementById("branch").disabled = true;
        document.getElementById("station").innerHTML = '<option value="" disabled selected>Select Station</option>';
      }
    }
    
    // ================= الطباعة والتصدير =================
    function printTable() {
      const table = document.getElementById("waterqualitytable").outerHTML;
      const style = `<style>table{border-collapse:collapse;width:100%;}th,td{border:1px solid #000;padding:8px;text-align:center;}</style>`;
      const win = window.open('', '', 'height=700,width=900');
      win.document.write('<html><head><title>Raw Water Quality Monitoring</title>' + style + '</head><body>' + table + '</body></html>');
      win.document.close();
      win.print();
    }
    
    function exportTableToExcel(waterqualitytable, filename='') {
      const table = document.getElementById(waterqualitytable).outerHTML.replace(/ /g,'%20');
      const link = document.createElement("a");
      document.body.appendChild(link);
      link.href = 'data:application/vnd.ms-excel,' + table;
      link.download = filename ? filename+'.xls' : 'excel_data.xls';
      link.click();
      document.body.removeChild(link);
    }

    //  تسجيل الخروج
    function logout() {
        sessionStorage.clear(); // مسح بيانات الجلسة
        alert("You have been logged out");
        window.location.href = "index.html"; // إعادة توجيه لصفحة تسجيل الدخول
    }
</script>





















